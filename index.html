<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Etsy Digital Product Toolkit</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>

    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #09090b;
      --surface: #18181b;
      --surface-2: #1f1f23;
      --border: #27272a;
      --border-hover: #3f3f46;
      --text: #f4f4f5;
      --text-dim: #a1a1aa;
      --text-muted: #71717a;
      --accent-green: #10b981;
      --accent-green-dim: #34d399;
      --accent-purple: #a371f7;
      --accent-purple-dim: #c4a5fd;
      --accent-orange: #f97316;
      --accent-yellow: #fbbf24;
      --accent-blue: #3b82f6;
    }

    [data-theme="light"] {
      --bg: #f4f4f5;
      --surface: #ffffff;
      --surface-2: #f9fafb;
      --border: #e4e4e7;
      --border-hover: #d4d4d8;
      --text: #18181b;
      --text-dim: #52525b;
      --text-muted: #71717a;
    }


    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 20px;
      height: 60px;
    }

    .logo {
      font-family: 'Space Mono', monospace;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-orange);
      white-space: nowrap;
    }

    .logo span { color: var(--text-muted); font-weight: 400; }

    /* Dropdown Navigation */
    .nav-dropdown {
      position: relative;
      flex: 1;
      max-width: 280px;
    }

    .nav-dropdown-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 16px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-dropdown-btn:hover {
      border-color: var(--border-hover);
      background: var(--border);
    }

    .nav-dropdown-btn svg {
      margin-left: auto;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .nav-dropdown.open .nav-dropdown-btn svg {
      transform: rotate(180deg);
    }

    .nav-dropdown-menu {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 200;
    }

    .nav-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 14px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-dim);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
    }

    .nav-dropdown-item:hover {
      background: var(--surface-2);
      color: var(--text);
    }

    .nav-dropdown-item.active {
      background: var(--accent-green);
      color: #000;
    }

    .nav-dropdown-item::before {
      content: attr(data-icon);
      font-size: 16px;
    }

    /* Clipboard indicator */
    .clipboard-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .clipboard-indicator.has-data {
      border-color: var(--accent-green);
      color: var(--accent-green-dim);
    }

    .clipboard-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
    }

    .clipboard-indicator.has-data .clipboard-dot {
      background: var(--accent-green);
    }

    /* Main content */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    .tool-panel {
      display: none;
    }

    .tool-panel.active {
      display: block;
    }

    /* Common Components */
    .page-title {
      font-family: 'Space Mono', monospace;
      font-size: 24px;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 24px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--surface);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
    }

    .panel-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 16px;
    }

    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 20px;
    }

    .upload-zone:hover { border-color: var(--border-hover); background: rgba(39, 39, 42, 0.3); }
    .upload-zone.dragover { border-color: var(--accent-green); background: rgba(16, 185, 129, 0.1); }

    .upload-zone svg { width: 40px; height: 40px; color: var(--text-muted); margin-bottom: 12px; }
    .upload-text { color: var(--text-dim); font-size: 14px; }
    .upload-hint { color: var(--text-muted); font-size: 12px; margin-top: 4px; }

    .hidden { display: none !important; }

    .settings-group { margin-bottom: 16px; }
    .settings-group label { display: block; font-size: 13px; color: var(--text-dim); margin-bottom: 8px; }

    input[type="text"], input[type="number"], select, textarea {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-green);
    }

    textarea { resize: vertical; min-height: 80px; }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent-green);
    }

    .range-value { float: right; color: var(--text-muted); font-size: 12px; }

    .btn {
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary { background: var(--accent-green); color: #000; }
    .btn-primary:hover { background: var(--accent-green-dim); }
    .btn-primary:disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; }

    .btn-secondary { background: var(--border); color: var(--text-dim); }
    .btn-secondary:hover { background: var(--border-hover); color: var(--text); }

    .btn-full { width: 100%; }

    .btn svg { width: 18px; height: 18px; }

    /* Preset buttons */
    .preset-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .preset-btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: 2px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .preset-btn:hover { border-color: var(--border-hover); }
    .preset-btn.active { border-color: var(--accent-green); background: rgba(16, 185, 129, 0.1); color: var(--accent-green-dim); }

    .preset-check {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: transparent;
    }

    .preset-btn.active .preset-check { background: var(--accent-green); color: #fff; }

    /* Output files list */
    .output-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .output-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }

    .output-thumb {
      width: 48px;
      height: 48px;
      border-radius: 6px;
      background: repeating-conic-gradient(var(--border) 0% 25%, var(--surface) 0% 50%) 50% / 8px 8px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .output-thumb img { width: 100%; height: 100%; object-fit: contain; }

    .output-info { flex: 1; min-width: 0; }

    .output-name {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      width: 100%;
      padding: 2px 0;
      border-bottom: 1px solid transparent;
    }

    .output-name:hover { border-bottom-color: var(--border); }
    .output-name:focus { border-bottom-color: var(--accent-green); outline: none; }

    .output-dims {
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'Space Mono', monospace;
      margin-top: 2px;
    }

    .output-actions {
      display: flex;
      gap: 6px;
    }

    .output-actions button {
      padding: 8px;
      border-radius: 6px;
      border: none;
      background: var(--border);
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s;
    }

    .output-actions button:hover { background: var(--border-hover); color: var(--text); }
    .output-actions button.primary { background: var(--accent-green); color: #000; }

    /* Chip selectors */
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      padding: 6px 12px;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .chip:hover { border-color: var(--border-hover); }
    .chip.selected { background: var(--accent-orange); border-color: var(--accent-orange); color: #000; }

    /* Status banners */
    .status-banner {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 13px;
      margin-bottom: 16px;
    }

    .status-banner.success { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: var(--accent-green-dim); }
    .status-banner.info { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #93c5fd; }
    .status-banner.warning { background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); color: #fde68a; }

    /* Copy button */
    .copy-btn {
      padding: 4px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
    }

    .copy-btn:hover { background: var(--border); color: var(--text-dim); }
    .copy-btn.copied { background: rgba(16, 185, 129, 0.2); border-color: var(--accent-green); color: var(--accent-green); }
    .copy-btn svg { width: 14px; height: 14px; }

    /* Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Quick actions */
    .tool-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .tool-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px 20px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .tool-card:hover {
      border-color: var(--accent-green);
      background: var(--surface-2);
      transform: translateY(-2px);
    }

    .tool-card-icon {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }

    .tool-card-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 6px;
    }

    .tool-card-desc {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .session-stats {
      display: flex;
      gap: 24px;
      justify-content: center;
      margin-top: 12px;
    }

    .session-stat {
      text-align: center;
    }

    .session-stat-value {
      display: block;
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-green);
    }

    .session-stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Description generator specific */
    .output-box {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      white-space: pre-wrap;
      font-size: 13px;
      line-height: 1.6;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Images grid */
    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }

    .image-card {
      background: var(--surface-2);
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .image-card.selected { border-color: var(--accent-purple); }

    .image-card-preview {
      aspect-ratio: 1;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
    }

    .image-card-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }

    .image-card-actions {
      display: flex;
      gap: 4px;
      padding: 8px;
    }

    .image-card-actions button {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 6px;
      background: var(--border);
      color: var(--text-dim);
      cursor: pointer;
      font-size: 12px;
    }

    .image-card-actions button:hover { background: var(--border-hover); }

    /* Checkerboard bg */
    .checker-bg {
      background: repeating-conic-gradient(var(--border) 0% 25%, var(--surface) 0% 50%) 50% / 16px 16px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.3; }

    /* Action bar */
    .action-bar {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .action-bar .btn { flex: 1; }

    /* Session summary */
    .session-summary {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-top: 24px;
    }

    .session-summary h3 {
      font-size: 14px;
      margin-bottom: 12px;
      color: var(--text-dim);
    }

    .session-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .session-item:last-child { border-bottom: none; }
    .session-item-label { color: var(--text-muted); }
    .session-item-value { color: var(--text); font-weight: 500; }

    /* Tabs on mobile */
    @media (max-width: 768px) {
      .header-inner { height: auto; flex-wrap: wrap; padding: 12px 0; }
      .tabs { order: 3; width: 100%; padding-top: 12px; }
      .clipboard-indicator { display: none; }
    }

    /* Lightbox Modal */
    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      cursor: zoom-out;
    }

    .lightbox.open {
      opacity: 1;
      visibility: visible;
    }

    .lightbox img {
      max-width: 90vw;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .lightbox-close:hover {
      background: var(--accent-green);
      color: #000;
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 50px;
      height: 50px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 50%;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .lightbox-nav:hover {
      background: var(--accent-green);
      color: #000;
    }

    .lightbox-prev { left: 20px; }
    .lightbox-next { right: 20px; }

    .lightbox-info {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-dim);
    }

    /* Clickable preview thumbnails */
    .preview-thumb {
      cursor: zoom-in;
      transition: transform 0.15s;
    }

    .preview-thumb:hover {
      transform: scale(1.02);
    }

    /* Favorite star on tool cards */
    .tool-card {
      position: relative;
    }

    .tool-card-fav {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
      opacity: 0.3;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 2;
    }

    .tool-card:hover .tool-card-fav {
      opacity: 0.7;
    }

    .tool-card-fav:hover {
      opacity: 1 !important;
      transform: scale(1.2);
    }

    .tool-card-fav.favorited {
      opacity: 1;
      color: #fbbf24;
    }

    /* Progress queue indicator */
    .queue-indicator {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: none;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 999;
    }

    .queue-indicator.active {
      display: block;
    }

    .queue-progress {
      width: 200px;
      height: 6px;
      background: var(--surface-2);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }

    .queue-progress-bar {
      height: 100%;
      background: var(--accent-green);
      transition: width 0.3s;
    }

    /* Workflow Wizard */
    .wizard-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 9000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .wizard-overlay.active { display: flex; }

    .wizard-modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .wizard-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .wizard-header h2 { font-size: 20px; }

    .wizard-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
    }

    .wizard-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .wizard-step { display: none; }
    .wizard-step.active { display: block; }

    .wizard-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .wizard-option {
      padding: 20px 16px;
      background: var(--surface-2);
      border: 2px solid var(--border);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .wizard-option:hover {
      border-color: var(--accent-purple);
      transform: translateY(-2px);
    }

    .wizard-option.selected {
      border-color: var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
    }

    .wizard-option-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .wizard-option-name {
      font-weight: 500;
      font-size: 14px;
    }

    .wizard-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .wizard-progress {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .wizard-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
    }

    .wizard-dot.active { background: var(--accent-green); }
    .wizard-dot.done { background: var(--accent-purple); }

    /* Keyboard Shortcuts Modal */
    .shortcuts-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 9500;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .shortcuts-modal.active { display: flex; }

    .shortcuts-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
    }

    .shortcut-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .shortcut-row:last-child { border-bottom: none; }

    .shortcut-keys {
      display: flex;
      gap: 4px;
    }

    .shortcut-key {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      min-width: 32px;
      text-align: center;
    }

    /* History Panel */
    .history-panel {
      position: fixed;
      top: 70px;
      right: -320px;
      width: 300px;
      height: calc(100vh - 90px);
      background: var(--surface);
      border-left: 1px solid var(--border);
      z-index: 900;
      transition: right 0.3s;
      display: flex;
      flex-direction: column;
    }

    .history-panel.open { right: 0; }

    .history-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--surface-2);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .history-item:hover { background: var(--border); }

    .history-item-thumb {
      width: 48px;
      height: 48px;
      border-radius: 6px;
      object-fit: cover;
      background: var(--border);
    }

    .history-item-info { flex: 1; min-width: 0; }

    .history-item-name {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-item-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Template Library */
    .template-library {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }

    .template-item {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-item:hover {
      border-color: var(--accent-purple);
      transform: translateY(-2px);
    }

    .template-thumb {
      aspect-ratio: 1;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
    }

    .template-info {
      padding: 12px;
    }

    .template-name {
      font-size: 13px;
      font-weight: 500;
    }

    .template-type {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Drag & Drop Highlight */
    .drop-target {
      position: relative;
    }

    .drop-target.drag-over::after {
      content: 'Drop here';
      position: absolute;
      inset: 0;
      background: rgba(99, 102, 241, 0.2);
      border: 3px dashed var(--accent-purple);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      color: var(--accent-purple);
      z-index: 100;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .quick-action {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
    }

    .quick-action:hover {
      border-color: var(--accent-green);
      background: rgba(16, 185, 129, 0.1);
    }

    .quick-action-icon { font-size: 18px; }

    /* Batch Queue Enhanced */
    .batch-queue {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      min-width: 280px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 1000;
      display: none;
    }

    .batch-queue.active { display: block; }

    .batch-queue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .batch-queue-title {
      font-weight: 600;
      font-size: 14px;
    }

    .batch-queue-items {
      max-height: 200px;
      overflow-y: auto;
    }

    .batch-queue-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }

    .batch-queue-item:last-child { border-bottom: none; }

    .batch-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .batch-status.processing {
      background: var(--accent-yellow);
      animation: pulse 1s infinite;
    }

    .batch-status.done { background: var(--accent-green); }
    .batch-status.error { background: var(--accent-orange); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  

/* Standalone overrides */
.tool-panel, .tool-content { display: block !important; }
body { padding: 0; }
</style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-inner">
      <div class="logo">ELEPHANT<span>TOOLS</span></div>
      
      <!-- Navigation Dropdown -->
      <div class="nav-dropdown">
        <button class="nav-dropdown-btn" id="navDropdownBtn">
          <span id="currentToolIcon">üñºÔ∏è</span>
          <span id="currentToolName">PNG Upscaler</span>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <div class="nav-dropdown-menu hidden" id="navDropdownMenu">
          <button class="nav-dropdown-item" onclick="switchTab('upscaler', 'üñºÔ∏è', 'PNG Upscaler')">
            <span>üñºÔ∏è</span> PNG Upscaler
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('wallart', 'üé®', 'Wall Art Resizer')">
            <span>üé®</span> Wall Art Resizer
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('coloring', 'üé®', 'Coloring Book')">
            <span>üé®</span> Coloring Book
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('greeting', 'üíå', 'Greeting Cards')">
            <span>üíå</span> Greeting Cards
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('kids', 'üéà', 'Kids Cards')">
            <span>üéà</span> Kids Cards
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('invitations', '‚úâÔ∏è', 'Invitations')">
            <span>‚úâÔ∏è</span> Invitations
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('journal', 'üìì', 'Journal Builder')">
            <span>üìì</span> Journal Builder
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('sticker', 'üè∑Ô∏è', 'Sticker Sheet')">
            <span>üè∑Ô∏è</span> Sticker Sheet
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('palette', 'üé®', 'Color Palette')">
            <span>üé®</span> Color Palette
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('variants', 'üåà', 'Color Variants')">
            <span>üåà</span> Color Variants
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('composer', 'üì∑', 'Photo Composer')">
            <span>üì∑</span> Photo Composer
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('banner', 'üè™', 'Shop Banner')">
            <span>üè™</span> Shop Banner
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('frames', 'üñºÔ∏è', 'Simple Frames')">
            <span>üñºÔ∏è</span> Simple Frames
          </button>
          <button class="nav-dropdown-item" onclick="switchTab('bundle', 'üì¶', 'Bundle Creator')">
            <span>üì¶</span> Bundle Creator
          </button>
        </div>
      </div>

      <!-- Header Actions -->
      <div style="display:flex;align-items:center;gap:12px;margin-left:auto;">
        <button class="icon-btn" id="themeToggle" title="Toggle theme">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor">
            <circle cx="10" cy="10" r="4" stroke-width="1.5"/>
            <path d="M10 2v2m0 12v2M18 10h-2M4 10H2m13.66-5.66l-1.42 1.42M7.76 12.24l-1.42 1.42m11.32 0l-1.42-1.42M7.76 7.76L6.34 6.34" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="icon-btn" onclick="document.getElementById('settingsModal').style.display='flex'" title="Settings">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
            <path d="M16 10a6 6 0 11-12 0 6 6 0 0112 0z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">

    <!-- PNG Upscaler -->
<div class="tool-panel active active" id="panel-upscaler" style="display:block;">
      <h1 class="page-title">PNG Upscaler</h1>
      <p class="page-subtitle">Upscale images for t-shirts & apparel ‚Ä¢ 300 DPI ‚Ä¢ Preserves transparency</p>

      <div class="grid-2">
        <div class="panel">
          <div class="panel-title">Settings</div>

          <div class="upload-zone" id="upscalerUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop images or click to upload</div>
            <div class="upload-hint">PNG, JPG, WebP ‚Ä¢ Multiple files supported</div>
          </div>
          <input type="file" id="upscalerInput" accept="image/*" multiple class="hidden">

          <div class="settings-group">
            <label>Target Sizes</label>
            <div style="margin-bottom:8px;font-size:12px;color:var(--text-muted);">üëï T-Shirt Sizes</div>
            <div class="preset-grid" id="upscalerPresets">
              <button class="preset-btn" data-mode="minimum" data-min="4500">
                <span class="preset-check">‚úì</span>
                <span>Min 4500px</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="4500" data-h="5400" data-label="15 x 18">
                <span class="preset-check">‚úì</span>
                <span>Full Chest 15√ó18"</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="3600" data-h="3600" data-label="12 x 12">
                <span class="preset-check">‚úì</span>
                <span>Standard 12√ó12"</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="3000" data-h="3600" data-label="10 x 12">
                <span class="preset-check">‚úì</span>
                <span>Front Print 10√ó12"</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="1200" data-h="1200" data-label="4 x 4">
                <span class="preset-check">‚úì</span>
                <span>Pocket 4√ó4"</span>
              </button>
            </div>
            <div style="margin:12px 0 8px;font-size:12px;color:var(--text-muted);">üñºÔ∏è Wall Art Sizes</div>
            <div class="preset-grid" id="upscalerWallartPresets">
              <button class="preset-btn" data-mode="exact" data-w="1500" data-h="2100" data-label="5 x 7">
                <span class="preset-check">‚úì</span>
                <span>5√ó7"</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="2400" data-h="3000" data-label="8 x 10">
                <span class="preset-check">‚úì</span>
                <span>8√ó10"</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="3300" data-h="4200" data-label="11 x 14">
                <span class="preset-check">‚úì</span>
                <span>11√ó14"</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="4800" data-h="6000" data-label="16 x 20">
                <span class="preset-check">‚úì</span>
                <span>16√ó20"</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="5400" data-h="7200" data-label="18 x 24">
                <span class="preset-check">‚úì</span>
                <span>18√ó24"</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="7200" data-h="10800" data-label="24 x 36">
                <span class="preset-check">‚úì</span>
                <span>24√ó36"</span>
              </button>
            </div>
            <div style="margin:12px 0 8px;font-size:12px;color:var(--text-muted);">üè∑Ô∏è Sticker Sizes</div>
            <div class="preset-grid">
              <button class="preset-btn" data-mode="exact" data-w="600" data-h="600" data-label="2 x 2">
                <span class="preset-check">‚úì</span>
                <span>2√ó2" Sticker</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="900" data-h="900" data-label="3 x 3">
                <span class="preset-check">‚úì</span>
                <span>3√ó3" Sticker</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="1200" data-h="900" data-label="4 x 3">
                <span class="preset-check">‚úì</span>
                <span>4√ó3" Bumper</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="1050" data-h="600" data-label="3.5 x 2">
                <span class="preset-check">‚úì</span>
                <span>3.5√ó2" Label</span>
              </button>
            </div>
            <div style="margin:12px 0 8px;font-size:12px;color:var(--text-muted);">üíå Cards & Invitations</div>
            <div class="preset-grid">
              <button class="preset-btn" data-mode="exact" data-w="1050" data-h="600" data-label="3.5 x 2">
                <span class="preset-check">‚úì</span>
                <span>3.5√ó2" Kids Card</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="1500" data-h="2100" data-label="5 x 7">
                <span class="preset-check">‚úì</span>
                <span>5√ó7" Invitation</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="1200" data-h="1800" data-label="4 x 6">
                <span class="preset-check">‚úì</span>
                <span>4√ó6" Postcard</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="1275" data-h="1650" data-label="4.25 x 5.5">
                <span class="preset-check">‚úì</span>
                <span>A2 Card</span>
              </button>
            </div>
            <div style="margin:12px 0 8px;font-size:12px;color:var(--text-muted);">üìì Planner & Journal</div>
            <div class="preset-grid">
              <button class="preset-btn" data-mode="exact" data-w="2550" data-h="3300" data-label="8.5 x 11">
                <span class="preset-check">‚úì</span>
                <span>US Letter</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="2480" data-h="3508" data-label="A4">
                <span class="preset-check">‚úì</span>
                <span>A4</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="1748" data-h="2480" data-label="A5">
                <span class="preset-check">‚úì</span>
                <span>A5</span>
              </button>
              <button class="preset-btn" data-mode="exact" data-w="1650" data-h="2550" data-label="5.5 x 8.5">
                <span class="preset-check">‚úì</span>
                <span>Half Letter</span>
              </button>
            </div>
          </div>

          <div class="settings-group">
            <label>Export Format</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-export="png">PNG</button>
              <button class="btn btn-secondary" data-export="jpg">JPG</button>
              <button class="btn btn-secondary" data-export="pdf">PDF</button>
              <button class="btn btn-secondary" data-export="all">All Formats</button>
            </div>
          </div>

          <div class="settings-group" style="display:flex;gap:16px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="upscalerKeepRatio" checked style="width:auto;">
              <span>Keep original ratio (scale proportionally)</span>
            </label>
          </div>

          <div class="action-bar">
            <button class="btn btn-secondary" id="upscalerCopyDims" disabled>üìã Copy Dimensions</button>
            <button class="btn btn-secondary" id="upscalerProcess" disabled>üîÑ Process</button>
            <button class="btn btn-primary" id="upscalerDownload" disabled>‚¨áÔ∏è Download</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Output</div>
          <div id="upscalerCompare" style="display:none;margin-bottom:12px;position:relative;border-radius:8px;overflow:hidden;touch-action:none;">
            <div style="display:flex;gap:8px;margin-bottom:8px;">
              <span style="font-size:12px;color:var(--text-muted);">Before/After Comparison - drag slider</span>
            </div>
            <div id="compareContainer" style="position:relative;width:100%;height:250px;background:var(--surface-2);border-radius:8px;overflow:hidden;">
              <img id="compareAfter" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;">
              <div id="compareClip" style="position:absolute;top:0;left:0;width:50%;height:100%;overflow:hidden;">
                <img id="compareBefore" style="position:absolute;top:0;left:0;width:200%;height:100%;object-fit:contain;">
              </div>
              <div id="compareSlider" style="position:absolute;top:0;left:50%;width:4px;height:100%;background:var(--accent-green);cursor:ew-resize;transform:translateX(-50%);">
                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:24px;background:var(--accent-green);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;">‚ü∑</div>
              </div>
            </div>
          </div>
          <div id="upscalerOutput" class="output-list">
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
              <p>Upload images to upscale</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- WALL ART RESIZER PANEL -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: PNG UPSCALER
// ============================================
    // ============================================
    // PNG UPSCALER
    // ============================================
    setupUploadZone('upscalerUpload', 'upscalerInput', handleUpscalerFiles);

    // All preset buttons in upscaler panel - attach after page load
    function initUpscalerPresets() {
      var btns = document.querySelectorAll('#panel-upscaler .preset-btn');
      for (var i = 0; i < btns.length; i++) {
        (function(btn) {
          if (btn.getAttribute('data-mode')) {
            btn.style.cursor = 'pointer';
            btn.onclick = function() {
              if (this.classList.contains('active')) {
                this.classList.remove('active');
              } else {
                this.classList.add('active');
              }
            };
          }
        })(btns[i]);
      }
    }
    initUpscalerPresets();

    document.getElementById('upscalerCopyDims').addEventListener('click', () => {
      if (state.upscaler.files.length) {
        const dims = state.upscaler.files.map(f => f.dimString).filter(d => d).join('\n');
        if (!dims) {
          Utils.toast('Process images first to get dimensions', 'error');
          return;
        }
        // Try clipboard API, fallback to execCommand
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(dims).then(() => {
            updateClipboard(dims);
            const btn = document.getElementById('upscalerCopyDims');
            btn.textContent = '‚úì Copied!';
            setTimeout(() => btn.textContent = 'üìã Copy Dimensions', 2000);
          }).catch(() => {
            fallbackCopy(dims);
          });
        } else {
          fallbackCopy(dims);
        }
      }
    });

    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      updateClipboard(text);
      const btn = document.getElementById('upscalerCopyDims');
      btn.textContent = '‚úì Copied!';
      setTimeout(() => btn.textContent = 'üìã Copy Dimensions', 2000);
    }

    // Export format buttons
    let upscalerExportFormat = 'png';
    document.querySelectorAll('#panel-upscaler [data-export]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#panel-upscaler [data-export]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        upscalerExportFormat = btn.dataset.export;
      });
    });

    document.getElementById('upscalerDownload').addEventListener('click', async () => {
      if (state.upscaler.files.length === 0) return;

      const format = upscalerExportFormat;
      const zip = new JSZip();
      
      for (const f of state.upscaler.files) {
        // Recreate canvas from blob for format conversion
        const img = await loadImage(f.previewUrl);
        const canvas = document.createElement('canvas');
        canvas.width = f.width;
        canvas.height = f.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, f.width, f.height);

        if (format === 'png' || format === 'all') {
          const pngBlob = await new Promise(r => canvas.toBlob(r, 'image/png'));
          zip.file(f.name + '.png', pngBlob);
        }

        if (format === 'jpg' || format === 'all') {
          // Add white background for JPG
          const jpgCanvas = document.createElement('canvas');
          jpgCanvas.width = f.width;
          jpgCanvas.height = f.height;
          const jpgCtx = jpgCanvas.getContext('2d');
          jpgCtx.fillStyle = '#ffffff';
          jpgCtx.fillRect(0, 0, f.width, f.height);
          jpgCtx.drawImage(canvas, 0, 0);
          const jpgBlob = await new Promise(r => jpgCanvas.toBlob(r, 'image/jpeg', 0.92));
          zip.file(f.name + '.jpg', jpgBlob);
        }

        if (format === 'pdf' || format === 'all') {
          const { jsPDF } = window.jspdf;
          const inchW = f.width / 300;
          const inchH = f.height / 300;

          if (!pdfDoc) {
            pdfDoc = new jsPDF({ orientation: inchW > inchH ? 'landscape' : 'portrait', unit: 'in', format: [inchW, inchH] });
          } else {
            pdfDoc.addPage([inchW, inchH], inchW > inchH ? 'landscape' : 'portrait');
          }

          // Start with high quality, reduce if needed for 20MB limit
          let quality = 0.92;
          let imgData = canvas.toDataURL('image/jpeg', quality);

          // Estimate size and reduce quality if too large
          while (imgData.length > 15000000 && quality > 0.5) {
            quality -= 0.1;
            imgData = canvas.toDataURL('image/jpeg', quality);
          }

          pdfDoc.addImage(imgData, 'JPEG', 0, 0, inchW, inchH);
        }
      }

      // Handle PDF as single file
      if ((format === 'pdf' || format === 'all') && pdfDoc) {
        if (format === 'pdf') {
          // PDF only - download directly
          const pdfBlob = pdfDoc.output('blob');
          downloadBlob(pdfBlob, 'upscaled-images.pdf');
          Utils.toast(`Downloaded PDF with ${state.upscaler.files.length} pages`);
          return;
        } else {
          // All formats - add PDF to zip
          zip.file('all-images.pdf', pdfDoc.output('blob'));
        }
      }

      const blob = await zip.generateAsync({ type: 'blob' });
      const suffix = format === 'all' ? 'all-formats' : format;
      downloadBlob(blob, `upscaled-${suffix}.zip`);
      Utils.toast(`Downloaded ${state.upscaler.files.length} files as ${format.toUpperCase()}`);
    });

    async function handleUpscalerFiles(files) {
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const img = await loadImage(dataUrl);
        state.upscaler.files.push({
          id: Date.now() + Math.random(),
          name: file.name.replace(/\.[^/.]+$/, ''),
          original: img,
          dataUrl,
          originalUrl: dataUrl
        });
      }
      document.getElementById('upscalerProcess').disabled = false;
      Utils.toast(state.upscaler.files.length + ' image(s) ready - select sizes and click Process');
    }

    document.getElementById('upscalerProcess').addEventListener('click', () => {
      if (state.upscaler.files.length > 0) {
        processUpscaler();
      }
    });

    async function processUpscaler() {
      // Gather presets from ALL preset groups
      const presets = Array.from(document.querySelectorAll('#panel-upscaler .preset-btn.active')).map(btn => ({
        mode: btn.dataset.mode,
        min: parseInt(btn.dataset.min) || 0,
        w: parseInt(btn.dataset.w) || 0,
        h: parseInt(btn.dataset.h) || 0,
        label: btn.dataset.label || 'min'
      })).filter(p => p.mode); // Filter out non-preset buttons

      if (presets.length === 0) {
        Utils.toast('Select at least one size preset', 'error');
        return;
      }

      const keepRatio = document.getElementById('upscalerKeepRatio').checked;
      const output = document.getElementById('upscalerOutput');
      output.innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner" style="margin:0 auto;"></div><p style="margin-top:16px;color:var(--text-muted);">Processing...</p></div>';

      const results = [];

      for (const file of state.upscaler.files) {
        for (const preset of presets) {
          const img = file.original;
          let newW, newH, suffix;

          if (preset.mode === 'minimum') {
            // Minimum mode: scale so smallest side is at least the minimum
            const minDim = Math.min(img.width, img.height);
            const scale = minDim >= preset.min ? 1 : preset.min / minDim;
            newW = Math.round(img.width * scale);
            newH = Math.round(img.height * scale);
            suffix = preset.min + 'px';
          } else if (keepRatio) {
            // Keep ratio mode: scale proportionally to fit within target, maintain original aspect ratio
            const imgRatio = img.width / img.height;
            const targetRatio = preset.w / preset.h;
            
            if (imgRatio > targetRatio) {
              // Image is wider - scale based on width
              newW = preset.w;
              newH = Math.round(preset.w / imgRatio);
            } else {
              // Image is taller - scale based on height
              newH = preset.h;
              newW = Math.round(preset.h * imgRatio);
            }
            suffix = preset.label.replace(' ', '') + '_ratio';
          } else {
            // Exact mode: stretch/distort to exact dimensions
            newW = preset.w;
            newH = preset.h;
            suffix = preset.label.replace(' ', '');
          }

          const canvas = document.createElement('canvas');
          canvas.width = newW;
          canvas.height = newH;
          const ctx = canvas.getContext('2d', { alpha: true });
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, 0, 0, newW, newH);

          const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
          const previewUrl = canvas.toDataURL('image/png');

          const inchW = (newW / 300).toFixed(1);
          const inchH = (newH / 300).toFixed(1);
          const dimString = `${inchW}" x ${inchH}" - ${newW} x ${newH} px`;

          results.push({
            id: Date.now() + Math.random(),
            name: `${file.name}_${suffix}_300dpi`,
            blob,
            previewUrl,
            originalUrl: file.originalUrl || file.dataUrl,
            width: newW,
            height: newH,
            dimString
          });
        }
      }

      state.upscaler.files = results;
      state.stats.processed += results.length;
      updateStats();
      renderUpscalerOutput();
    }

    function renderUpscalerOutput() {
      const output = document.getElementById('upscalerOutput');
      const compare = document.getElementById('upscalerCompare');

      if (state.upscaler.files.length === 0) {
        output.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><p>Upload images to upscale</p></div>';
        document.getElementById('upscalerCopyDims').disabled = true;
        document.getElementById('upscalerDownload').disabled = true;
        compare.style.display = 'none';
        return;
      }

      // Show before/after comparison for first image
      const first = state.upscaler.files[0];
      if (first.originalUrl && first.previewUrl) {
        compare.style.display = 'block';
        document.getElementById('compareBefore').src = first.originalUrl;
        document.getElementById('compareAfter').src = first.previewUrl;
        initCompareSlider();
      }

      output.innerHTML = state.upscaler.files.map((f, i) => `
        <div class="output-item">
          <div class="output-thumb preview-thumb" onclick="openUpscalerLightbox(${i})" title="Click to enlarge"><img src="${f.previewUrl}" alt=""></div>
          <div class="output-info">
            <input class="output-name" value="${f.name}" data-idx="${i}">
            <div class="output-dims">${f.width} √ó ${f.height}px ¬∑ ${(f.width/300).toFixed(1)}" √ó ${(f.height/300).toFixed(1)}"</div>
          </div>
          <div class="output-actions">
            <button class="copy-btn" data-copy="${f.dimString}" title="Copy dims"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
            <button class="primary" onclick="downloadBlob(state.upscaler.files[${i}].blob, state.upscaler.files[${i}].name + '.png')">‚¨á</button>
          </div>
        </div>
      `).join('');

      output.querySelectorAll('.output-name').forEach(input => {
        input.addEventListener('change', e => {
          state.upscaler.files[parseInt(e.target.dataset.idx)].name = e.target.value;
        });
      });

      output.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          navigator.clipboard.writeText(btn.dataset.copy);
          btn.classList.add('copied');
          setTimeout(() => btn.classList.remove('copied'), 1000);
        });
      });

      document.getElementById('upscalerCopyDims').disabled = false;
      document.getElementById('upscalerDownload').disabled = false;
    }

    function initCompareSlider() {
      const container = document.getElementById('compareContainer');
      const slider = document.getElementById('compareSlider');
      const clip = document.getElementById('compareClip');
      if (!container || !slider) return;

      let isDragging = false;

      function updateSlider(clientX) {
        const rect = container.getBoundingClientRect();
        let x = (clientX - rect.left) / rect.width;
        x = Math.max(0, Math.min(1, x));
        slider.style.left = (x * 100) + '%';
        clip.style.width = (x * 100) + '%';
      }

      slider.addEventListener('mousedown', () => isDragging = true);
      slider.addEventListener('touchstart', () => isDragging = true, {passive: true});

      document.addEventListener('mousemove', e => { if (isDragging) updateSlider(e.clientX); });
      document.addEventListener('touchmove', e => { if (isDragging && e.touches[0]) updateSlider(e.touches[0].clientX); }, {passive: true});

      document.addEventListener('mouseup', () => isDragging = false);
      document.addEventListener('touchend', () => isDragging = false);

      container.addEventListener('click', e => updateSlider(e.clientX));
    }

    function openUpscalerLightbox(index) {
      const images = state.upscaler.files.map(f => f.previewUrl);
      const file = state.upscaler.files[index];
      openLightbox(images, index, `${file.name} ‚Ä¢ ${file.width}√ó${file.height}px`);
    }


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Wall Art Resizer -->
<div class="tool-panel" id="panel-wallart" style="display:none;">
      <h1 class="page-title">üñºÔ∏è Wall Art Resizer</h1>
      <p class="page-subtitle">Batch resize artwork ‚Ä¢ Multiple sizes ‚Ä¢ 300 DPI</p>

      <div class="grid-2">
        <div class="panel">
          <div class="panel-title">Settings</div>

          <div class="upload-zone" id="wallartUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop images or click to upload</div>
            <div class="upload-hint">Upload multiple images for batch processing</div>
          </div>
          <input type="file" id="wallartInput" accept="image/*" multiple class="hidden">

          <div id="wallartFileList" style="display:none;margin-top:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <span style="font-size:12px;font-weight:600;">Images (<span id="wallartFileCount">0</span>)</span>
              <button class="btn btn-secondary btn-sm" id="wallartClearAll" style="padding:4px 8px;font-size:10px;">Clear All</button>
            </div>
            <div id="wallartThumbs" style="display:flex;flex-wrap:wrap;gap:6px;max-height:100px;overflow-y:auto;"></div>
          </div>

          <div class="settings-group" style="margin-top:16px;">
            <label>Standard Sizes (300 DPI)</label>
            <div class="preset-grid" id="wallartSizes">
              <button class="preset-btn" data-wallsize="4x6" data-w="1200" data-h="1800" data-ratio="0.667">
                <span class="preset-check">‚úì</span><span>4√ó6"</span>
              </button>
              <button class="preset-btn" data-wallsize="5x7" data-w="1500" data-h="2100" data-ratio="0.714">
                <span class="preset-check">‚úì</span><span>5√ó7"</span>
              </button>
              <button class="preset-btn" data-wallsize="8x10" data-w="2400" data-h="3000" data-ratio="0.8">
                <span class="preset-check">‚úì</span><span>8√ó10"</span>
              </button>
              <button class="preset-btn" data-wallsize="8.5x11" data-w="2550" data-h="3300" data-ratio="0.773">
                <span class="preset-check">‚úì</span><span>8.5√ó11"</span>
              </button>
              <button class="preset-btn" data-wallsize="11x14" data-w="3300" data-h="4200" data-ratio="0.786">
                <span class="preset-check">‚úì</span><span>11√ó14"</span>
              </button>
              <button class="preset-btn" data-wallsize="12x16" data-w="3600" data-h="4800" data-ratio="0.75">
                <span class="preset-check">‚úì</span><span>12√ó16"</span>
              </button>
              <button class="preset-btn" data-wallsize="12x18" data-w="3600" data-h="5400" data-ratio="0.667">
                <span class="preset-check">‚úì</span><span>12√ó18"</span>
              </button>
              <button class="preset-btn" data-wallsize="16x20" data-w="4800" data-h="6000" data-ratio="0.8">
                <span class="preset-check">‚úì</span><span>16√ó20"</span>
              </button>
              <button class="preset-btn" data-wallsize="18x24" data-w="5400" data-h="7200" data-ratio="0.75">
                <span class="preset-check">‚úì</span><span>18√ó24"</span>
              </button>
              <button class="preset-btn" data-wallsize="20x30" data-w="6000" data-h="9000" data-ratio="0.667">
                <span class="preset-check">‚úì</span><span>20√ó30"</span>
              </button>
              <button class="preset-btn" data-wallsize="24x36" data-w="7200" data-h="10800" data-ratio="0.667">
                <span class="preset-check">‚úì</span><span>24√ó36"</span>
              </button>
            </div>
            <div style="margin:12px 0 8px;font-size:11px;color:var(--text-muted);">Square</div>
            <div class="preset-grid" id="wallartSizesSquare">
              <button class="preset-btn" data-wallsize="8x8" data-w="2400" data-h="2400" data-ratio="1">
                <span class="preset-check">‚úì</span><span>8√ó8"</span>
              </button>
              <button class="preset-btn" data-wallsize="10x10" data-w="3000" data-h="3000" data-ratio="1">
                <span class="preset-check">‚úì</span><span>10√ó10"</span>
              </button>
              <button class="preset-btn" data-wallsize="12x12" data-w="3600" data-h="3600" data-ratio="1">
                <span class="preset-check">‚úì</span><span>12√ó12"</span>
              </button>
              <button class="preset-btn" data-wallsize="16x16" data-w="4800" data-h="4800" data-ratio="1">
                <span class="preset-check">‚úì</span><span>16√ó16"</span>
              </button>
              <button class="preset-btn" data-wallsize="20x20" data-w="6000" data-h="6000" data-ratio="1">
                <span class="preset-check">‚úì</span><span>20√ó20"</span>
              </button>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn btn-secondary btn-sm" onclick="document.querySelectorAll('#wallartSizes .preset-btn, #wallartSizesSquare .preset-btn').forEach(b=>b.classList.add('active'))">Select All</button>
              <button class="btn btn-secondary btn-sm" onclick="document.querySelectorAll('#wallartSizes .preset-btn, #wallartSizesSquare .preset-btn').forEach(b=>b.classList.remove('active'))">Clear All</button>
            </div>
          </div>

          <div class="action-bar">
            <button class="btn btn-primary" id="wallartDownload" disabled>‚¨áÔ∏è Download ZIP</button>
          </div>
          <div id="wallartProgress" style="display:none;margin-top:12px;">
            <div style="background:var(--surface-2);border-radius:4px;height:8px;overflow:hidden;">
              <div id="wallartProgressBar" style="background:var(--accent);height:100%;width:0%;transition:width 0.2s;"></div>
            </div>
            <div id="wallartProgressText" style="font-size:11px;color:var(--text-muted);margin-top:4px;text-align:center;"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Preview</div>
          <div id="wallartPreview" style="display:flex;align-items:center;justify-content:center;min-height:350px;background:var(--surface-2);border-radius:8px;">
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
              <p>Upload artwork to preview</p>
            </div>
          </div>
          <div id="wallartSizePreview" style="display:none;margin-top:12px;">
            <div id="wallartSelectedCount" style="font-size:12px;color:var(--text-muted);"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- COLORING BOOK PANEL -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: WALL ART RESIZER
// ============================================
    // ============================================
    // WALL ART RESIZER (Batch Processing)
    // ============================================
    let wallartImages = [];

    // Size toggle buttons
    document.querySelectorAll('#wallartSizes .preset-btn, #wallartSizesSquare .preset-btn').forEach(btn => {
      btn.onclick = function() {
        this.classList.toggle('active');
      };
    });

    setupUploadZone('wallartUpload', 'wallartInput', async (files) => {
      for (const file of Array.from(files)) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const img = await loadImage(dataUrl);
        wallartImages.push({ img, name: file.name.replace(/\.[^/.]+$/, ''), dataUrl });
      }
      renderWallartThumbs();
      if (wallartImages.length > 0) {
        document.getElementById('wallartDownload').disabled = false;
        // Show first image preview
        document.getElementById('wallartPreview').innerHTML = `<img src="${wallartImages[0].dataUrl}" style="max-width:100%;max-height:350px;border-radius:8px;">`;
      }
    });

    function renderWallartThumbs() {
      const list = document.getElementById('wallartFileList');
      const thumbs = document.getElementById('wallartThumbs');
      const count = document.getElementById('wallartFileCount');
      
      if (wallartImages.length === 0) {
        list.style.display = 'none';
        document.getElementById('wallartDownload').disabled = true;
        return;
      }
      
      list.style.display = 'block';
      count.textContent = wallartImages.length;
      thumbs.innerHTML = wallartImages.map((d, i) => `
        <div style="position:relative;width:44px;height:44px;border-radius:4px;overflow:hidden;border:2px solid var(--border);cursor:pointer;" onclick="previewWallartImage(${i})">
          <img src="${d.dataUrl}" style="width:100%;height:100%;object-fit:cover;">
          <button onclick="event.stopPropagation();removeWallartImage(${i})" style="position:absolute;top:-3px;right:-3px;width:16px;height:16px;border-radius:50%;background:#e74c3c;border:none;color:#fff;font-size:9px;cursor:pointer;line-height:1;">‚úï</button>
        </div>
      `).join('');
    }

    window.previewWallartImage = function(index) {
      if (wallartImages[index]) {
        document.getElementById('wallartPreview').innerHTML = `<img src="${wallartImages[index].dataUrl}" style="max-width:100%;max-height:350px;border-radius:8px;">`;
      }
    };

    window.removeWallartImage = function(index) {
      wallartImages.splice(index, 1);
      renderWallartThumbs();
      if (wallartImages.length > 0) {
        document.getElementById('wallartPreview').innerHTML = `<img src="${wallartImages[0].dataUrl}" style="max-width:100%;max-height:350px;border-radius:8px;">`;
      } else {
        document.getElementById('wallartPreview').innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><p>Upload artwork to preview</p></div>`;
      }
    };

    document.getElementById('wallartClearAll').onclick = () => {
      wallartImages = [];
      renderWallartThumbs();
      document.getElementById('wallartPreview').innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><p>Upload artwork to preview</p></div>`;
    };

    document.getElementById('wallartDownload').addEventListener('click', async () => {
      if (wallartImages.length === 0) return;

      const btn = document.getElementById('wallartDownload');
      const progressDiv = document.getElementById('wallartProgress');
      const progressBar = document.getElementById('wallartProgressBar');
      const progressText = document.getElementById('wallartProgressText');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Processing...';
      progressDiv.style.display = 'block';

      try {
        // Get selected sizes
        const selectedSizes = Array.from(document.querySelectorAll('#wallartSizes .preset-btn.active, #wallartSizesSquare .preset-btn.active')).map(btn => ({
          name: btn.dataset.wallsize,
          w: parseInt(btn.dataset.w),
          h: parseInt(btn.dataset.h)
        }));

        if (selectedSizes.length === 0) {
          Utils.toast('Select at least one size', 'error');
          btn.disabled = false;
          btn.textContent = '‚¨áÔ∏è Download ZIP';
          progressDiv.style.display = 'none';
          return;
        }

        const zip = new JSZip();
        const totalOps = wallartImages.length * selectedSizes.length;
        let completed = 0;

        for (const wallart of wallartImages) {
          const img = wallart.img;
          
          // Create folder for each image if multiple images
          const folder = wallartImages.length > 1 ? zip.folder(wallart.name) : zip;

          for (const size of selectedSizes) {
            const canvas = document.createElement('canvas');
            canvas.width = size.w;
            canvas.height = size.h;
            const ctx = canvas.getContext('2d');

            // Stretch to fill entire canvas
            ctx.drawImage(img, 0, 0, size.w, size.h);

            const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.95));
            folder.file(`${wallart.name}_${size.name}.jpg`, blob);
            
            completed++;
            const pct = Math.round((completed / totalOps) * 100);
            progressBar.style.width = pct + '%';
            progressText.textContent = `Processing ${completed}/${totalOps} files...`;
          }
        }

        progressText.textContent = 'Creating ZIP...';
        const blob = await zip.generateAsync({ type: 'blob' });
        
        const filename = wallartImages.length === 1 
          ? `${wallartImages[0].name}_wall-art-${selectedSizes.length}sizes.zip`
          : `wall-art-batch-${wallartImages.length}images-${selectedSizes.length}sizes.zip`;
        
        downloadBlob(blob, filename);
        Utils.toast(`Downloaded ${wallartImages.length} images √ó ${selectedSizes.length} sizes!`);
      } catch (e) {
        console.error(e);
        Utils.toast('Error creating files', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚¨áÔ∏è Download ZIP';
        progressDiv.style.display = 'none';
        progressBar.style.width = '0%';
      }
    });



// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Coloring Book -->
<div class="tool-panel" id="panel-coloring" style="display:none;">
      <h1 class="page-title">‚úèÔ∏è Coloring Book Creator</h1>
      <p class="page-subtitle">Convert images to line art coloring pages</p>

      <div class="grid-2">
        <div class="panel">
          <div class="panel-title">Settings</div>

          <div class="upload-zone" id="coloringUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop images or click to upload</div>
            <div class="upload-hint">Upload multiple images for a coloring book</div>
          </div>
          <input type="file" id="coloringInput" accept="image/*" multiple class="hidden">

          <div class="settings-group" style="margin-top:16px;">
            <label>Style</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" id="coloringEdges">Line Art</button>
              <button class="btn btn-secondary" id="coloringSketch">Sketch</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Sensitivity: <span id="coloringSensVal">50%</span></label>
            <input type="range" id="coloringSensitivity" min="10" max="90" value="50" style="width:100%;">
          </div>

          <div class="settings-group">
            <label>Line Strength: <span id="coloringStrVal">1.0x</span></label>
            <input type="range" id="coloringStrength" min="5" max="20" value="10" style="width:100%;">
          </div>

          <div class="settings-group">
            <label>Cover Page</label>
            <input type="text" id="coloringCoverTitle" placeholder="Coloring Book" value="Coloring Book">
            <label style="display:flex;align-items:center;gap:6px;margin-top:8px;cursor:pointer;">
              <input type="checkbox" id="coloringCoverPage" checked style="width:auto;">
              <span>Include cover page</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;margin-top:8px;cursor:pointer;">
              <input type="checkbox" id="coloringPageNumbers" checked style="width:auto;">
              <span>Add page numbers</span>
            </label>
          </div>

          <div class="action-bar">
            <button class="btn btn-secondary" id="coloringSelectAll" disabled>Select All</button>
            <button class="btn btn-primary" id="coloringDownload" disabled>‚¨áÔ∏è Download PDF</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Preview</div>
          <div id="coloringGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;min-height:300px;">
            <div class="empty-state" style="grid-column:1/-1;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg>
              <p>Upload images to create coloring pages</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BACKGROUND REMOVER --><!-- STICKER SHEET -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: COLORING BOOK CREATOR
// ============================================
    // ============================================
    // COLORING BOOK (Simplified)
    // ============================================
    setupUploadZone('coloringUpload', 'coloringInput', handleColoringFiles);

    let coloringMode = 'edges';
    document.getElementById('coloringEdges').addEventListener('click', () => {
      coloringMode = 'edges';
      document.getElementById('coloringEdges').classList.add('active');
      document.getElementById('coloringSketch').classList.remove('active');
      processColoringPages();
    });
    document.getElementById('coloringSketch').addEventListener('click', () => {
      coloringMode = 'sketch';
      document.getElementById('coloringSketch').classList.add('active');
      document.getElementById('coloringEdges').classList.remove('active');
      processColoringPages();
    });

    document.getElementById('coloringSensitivity').addEventListener('input', e => {
      document.getElementById('coloringSensVal').textContent = e.target.value + '%';
    });
    document.getElementById('coloringStrength').addEventListener('input', e => {
      document.getElementById('coloringStrVal').textContent = (e.target.value / 10).toFixed(1) + 'x';
    });

    document.getElementById('coloringSelectAll').addEventListener('click', () => {
      if (state.coloring.selected.size === state.coloring.files.length) {
        state.coloring.selected.clear();
      } else {
        state.coloring.files.forEach(f => state.coloring.selected.add(f.id));
      }
      renderColoringGrid();
    });

    document.getElementById('coloringDownload').addEventListener('click', downloadColoringPDF);

    async function handleColoringFiles(files) {
      const fileArray = Array.from(files);

      // First, load all files and show them immediately
      for (const file of fileArray) {
        if (!file.type.startsWith('image/')) continue;
        try {
          const dataUrl = await readFileAsDataURL(file);
          const img = await loadImage(dataUrl);
          const id = Date.now() + Math.random();
          state.coloring.files.push({ id, img, dataUrl, processed: null, processing: true });
          state.coloring.selected.add(id);
        } catch (e) {
          console.error('Error loading image:', e);
        }
      }

      // Show grid immediately with loading state
      renderColoringGrid();

      // Then process each one
      await processColoringPages();
    }

    async function processColoringPages() {
      const sensitivity = parseInt(document.getElementById('coloringSensitivity').value) / 100;
      const strength = parseInt(document.getElementById('coloringStrength').value) / 10;

      for (const file of state.coloring.files) {
        if (file.processed && !file.needsReprocess) continue; // Skip already processed

        try {
          const canvas = document.createElement('canvas');
          const maxSize = 1200; // Increased for better quality
          const scale = Math.min(maxSize / file.img.width, maxSize / file.img.height, 1);
          canvas.width = Math.floor(file.img.width * scale);
          canvas.height = Math.floor(file.img.height * scale);
          const ctx = canvas.getContext('2d');

          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(file.img, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          const w = canvas.width, h = canvas.height;

          // Simple edge detection
          const gray = new Float32Array(w * h);
          for (let i = 0; i < data.length; i += 4) {
            gray[i / 4] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
          }

          const edges = new Float32Array(w * h);
          for (let y = 1; y < h - 1; y++) {
            for (let x = 1; x < w - 1; x++) {
              const idx = y * w + x;
              const gx = -gray[idx - w - 1] - 2 * gray[idx - 1] - gray[idx + w - 1] + gray[idx - w + 1] + 2 * gray[idx + 1] + gray[idx + w + 1];
              const gy = -gray[idx - w - 1] - 2 * gray[idx - w] - gray[idx - w + 1] + gray[idx + w - 1] + 2 * gray[idx + w] + gray[idx + w + 1];
              edges[idx] = Math.sqrt(gx * gx + gy * gy) / 255;
            }
          }

          // Find max without spread operator (avoids stack overflow)
          let maxE = 0;
          for (let i = 0; i < edges.length; i++) {
            if (edges[i] > maxE) maxE = edges[i];
          }
          maxE = maxE || 1;
          for (let i = 0; i < data.length; i += 4) {
            const e = edges[i / 4];
            if (e > sensitivity) {
              const v = 255 - Math.min(255, (e / maxE) * 255 * strength);
              data[i] = data[i + 1] = data[i + 2] = v;
            } else {
              data[i] = data[i + 1] = data[i + 2] = 255;
            }
            data[i + 3] = 255;
          }

          ctx.putImageData(imageData, 0, 0);
          file.processed = canvas.toDataURL('image/jpeg', 0.9);
          file.processing = false;
          file.needsReprocess = false;

          // Update grid after each image processes
          renderColoringGrid();

          // Small delay to let UI update
          await new Promise(r => setTimeout(r, 10));
        } catch (e) {
          console.error('Error processing image:', e);
          file.processing = false;
        }
      }

      state.stats.processed += state.coloring.files.filter(f => f.processed).length;
      updateStats();
      renderColoringGrid();
    }

    function renderColoringGrid() {
      const grid = document.getElementById('coloringGrid');
      const count = document.getElementById('coloringCount');

      count.textContent = `(${state.coloring.files.length})`;
      document.getElementById('coloringDownload').disabled = state.coloring.selected.size === 0;

      if (state.coloring.files.length === 0) {
        grid.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><p>Upload images to create coloring pages</p></div>';
        return;
      }

      grid.innerHTML = state.coloring.files.map((f, i) => `
        <div class="image-card ${state.coloring.selected.has(f.id) ? 'selected' : ''}" data-id="${f.id}">
          <div class="image-card-preview preview-thumb" style="position:relative;" onclick="openColoringLightbox(${i})">
            <img src="${f.processed || f.dataUrl}" alt="">
            ${f.processing ? '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;"><div class="spinner"></div></div>' : '<div style="position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,0.6);padding:2px 6px;border-radius:4px;font-size:10px;">üîç Click to enlarge</div>'}
          </div>
          <div class="image-card-actions">
            <button onclick="event.stopPropagation(); state.coloring.selected.has(${f.id}) ? state.coloring.selected.delete(${f.id}) : state.coloring.selected.add(${f.id}); renderColoringGrid();">
              ${state.coloring.selected.has(f.id) ? '‚úì' : '‚óã'}
            </button>
            <button onclick="event.stopPropagation(); state.coloring.files.splice(${i}, 1); state.coloring.selected.delete(${f.id}); renderColoringGrid();">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function openColoringLightbox(index) {
      const images = state.coloring.files.filter(f => f.processed || f.dataUrl).map(f => f.processed || f.dataUrl);
      const names = state.coloring.files.map(f => f.name);
      openLightbox(images, index, `${names[index]} ‚Ä¢ ${index + 1} of ${images.length}`);
    }

    async function downloadColoringPDF() {
      const selected = state.coloring.files.filter(f => state.coloring.selected.has(f.id) && f.processed);
      if (selected.length === 0) {
        Utils.toast('No processed images selected', 'error');
        return;
      }

      const btn = document.getElementById('coloringDownload');
      btn.disabled = true;
      btn.textContent = '‚è≥ Creating PDF...';

      // Get options
      const addPageNumbers = document.getElementById('coloringPageNumbers').checked;
      const addCover = document.getElementById('coloringCoverPage').checked;
      const addInstructions = document.getElementById('coloringInstructions').checked;
      const coverTitle = document.getElementById('coloringCoverTitle').value || 'Coloring Book';

      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'in', format: 'letter' });

        let pageNum = 0;

        // Add cover page
        if (addCover) {
          const { canvas: coverCanvas, ctx: coverCtx } = Utils.createCanvas(2550, 3300, { background: 'white' });

          // Draw decorative border
          coverCtx.strokeStyle = '#333';
          coverCtx.lineWidth = 8;
          coverCtx.strokeRect(100, 100, 2350, 3100);

          // Title
          coverCtx.fillStyle = '#333';
          coverCtx.font = 'bold 120px Georgia, serif';
          coverCtx.textAlign = 'center';
          coverCtx.fillText(coverTitle, 1275, 1500);

          // Subtitle
          coverCtx.font = '48px Georgia, serif';
          coverCtx.fillStyle = '#666';
          coverCtx.fillText(`${selected.length} Pages`, 1275, 1650);

          const coverData = coverCanvas.toDataURL('image/jpeg', 0.9);
          pdf.addImage(coverData, 'JPEG', 0, 0, 8.5, 11);
          pageNum++;
        }

        // Add instructions page
        if (addInstructions) {
          if (pageNum > 0) pdf.addPage('letter', 'portrait');

          const { canvas: instCanvas, ctx: instCtx } = Utils.createCanvas(2550, 3300, { background: 'white' });

          instCtx.fillStyle = '#333';
          instCtx.font = 'bold 72px Georgia, serif';
          instCtx.textAlign = 'center';
          instCtx.fillText('How to Use This Book', 1275, 400);

          instCtx.font = '36px Georgia, serif';
          instCtx.textAlign = 'left';
          const instructions = [
            '1. Print pages on high-quality paper (cardstock works great!)',
            '2. Use colored pencils, markers, or crayons',
            '3. Take your time and enjoy the process',
            '4. Frame your favorites or give them as gifts!',
            '',
            'Tips for Best Results:',
            '‚Ä¢ Use printer setting "Best Quality"',
            '‚Ä¢ Let ink dry before coloring',
            '‚Ä¢ Test markers on a scrap first',
            '',
            'Enjoy your coloring journey! ‚ú®'
          ];

          instructions.forEach((line, i) => {
            instCtx.fillText(line, 200, 600 + i * 80);
          });

          const instData = instCanvas.toDataURL('image/jpeg', 0.9);
          pdf.addImage(instData, 'JPEG', 0, 0, 8.5, 11);
          pageNum++;
        }

        // Add coloring pages
        for (let i = 0; i < selected.length; i++) {
          if (pageNum > 0) pdf.addPage('letter', 'portrait');
          pageNum++;

          btn.textContent = `‚è≥ Page ${i + 1}/${selected.length}...`;

          const processedImg = await loadImage(selected[i].processed);
          const { canvas, ctx } = Utils.createCanvas(2550, 3300, { background: 'white' });

          // Scale to fit with margins
          const margin = 150;
          const maxW = canvas.width - (margin * 2);
          const maxH = canvas.height - (margin * 2) - (addPageNumbers ? 100 : 0);
          const scale = Math.min(maxW / processedImg.width, maxH / processedImg.height);
          const drawW = processedImg.width * scale;
          const drawH = processedImg.height * scale;
          const x = (canvas.width - drawW) / 2;
          const y = (canvas.height - drawH - (addPageNumbers ? 50 : 0)) / 2;

          ctx.drawImage(processedImg, x, y, drawW, drawH);

          // Add page number
          if (addPageNumbers) {
            ctx.fillStyle = '#999';
            ctx.font = '36px Georgia, serif';
            ctx.textAlign = 'center';
            ctx.fillText(`- ${i + 1} -`, canvas.width / 2, canvas.height - 80);
          }

          const jpgData = canvas.toDataURL('image/jpeg', 0.9);
          pdf.addImage(jpgData, 'JPEG', 0, 0, 8.5, 11);

          await new Promise(r => setTimeout(r, 50));
        }

        const filename = document.getElementById('coloringFilename').value.trim() || 'coloring-book';

        // Use blob method for better compatibility
        const blob = pdf.output('blob');
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename + '.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        Utils.toast(`Downloaded: ${filename}.pdf (${pageNum} pages)`);
      } catch (e) {
        console.error('PDF error:', e);
        Utils.toast('Error creating PDF: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚¨áÔ∏è Download PDF';
      }
    }


    // ============================================
    // ENHANCED COLORING BOOK - Cover & Page Numbers
    // ============================================
    document.getElementById('coloringCoverPage').onchange = (e) => {
      document.getElementById('coloringCoverSettings').style.display = e.target.checked ? 'block' : 'none';
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Greeting Cards -->
<div class="tool-panel" id="panel-greeting" style="display:none;">
      <h1 class="page-title">üíå Greeting Card Maker</h1>
      <p class="page-subtitle">Create printable folded greeting cards from your designs</p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Card Settings</div>

          <div class="upload-zone" id="greetingUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop front design image</div>
            <div class="upload-hint">This will be the card front</div>
          </div>
          <input type="file" id="greetingInput" accept="image/*" class="hidden">

          <div class="settings-group" style="margin-top:16px;">
            <label>Card Size (Folded)</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-cardsize="5x7">5√ó7"</button>
              <button class="btn btn-secondary" data-cardsize="4x6">4√ó6"</button>
              <button class="btn btn-secondary" data-cardsize="a2">A2 (4.25√ó5.5")</button>
              <button class="btn btn-secondary" data-cardsize="a7">A7 (5√ó7")</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Fold Type</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-fold="half">Half Fold (Top)</button>
              <button class="btn btn-secondary" data-fold="side">Side Fold</button>
              <button class="btn btn-secondary" data-fold="quarter">Quarter Fold</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Back Design</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-back="blank">Blank</button>
              <button class="btn btn-secondary" data-back="logo">Add Logo</button>
              <button class="btn btn-secondary" data-back="mirror">Mirror Front</button>
            </div>
          </div>

          <div class="settings-group" id="greetingLogoGroup" style="display:none;">
            <label>Logo/Branding Image</label>
            <div class="upload-zone" id="greetingLogoUpload" style="padding:16px;">
              <div class="upload-text" style="font-size:12px;">Drop logo image</div>
            </div>
            <input type="file" id="greetingLogoInput" accept="image/*" class="hidden">
          </div>

          <div class="settings-group">
            <label>Inside Content</label>
            <div class="size-buttons" style="margin-bottom:12px;">
              <button class="btn btn-secondary active" data-inside="blank">Blank</button>
              <button class="btn btn-secondary" data-inside="message">Message</button>
              <button class="btn btn-secondary" data-inside="image">Image</button>
            </div>
            <div id="greetingMessageGroup" style="display:none;">
              <textarea id="greetingMessage" placeholder="Enter inside message" rows="2" style="width:100%;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:vertical;"></textarea>
            </div>
            <div id="greetingInsideImageGroup" style="display:none;">
              <div class="upload-zone" id="greetingInsideUpload" style="padding:16px;">
                <div class="upload-text" style="font-size:12px;">Drop inside image</div>
              </div>
              <input type="file" id="greetingInsideInput" accept="image/*" class="hidden">
            </div>
          </div>

          <div class="settings-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="greetingCutLines" style="width:auto;">
              <span>Add cut lines & fold marks</span>
            </label>
          </div>

          <div class="settings-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="greetingBleed" checked style="width:auto;">
              <span>Add 0.125" bleed area</span>
            </label>
          </div>

          <div class="action-bar">
            <button class="btn btn-primary" id="greetingDownload" disabled>‚¨áÔ∏è Download Card PDF</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Preview</div>
          <div style="display:flex;gap:8px;margin-bottom:12px;">
            <button class="btn btn-secondary active" id="greetingPreviewFrontBtn" onclick="showGreetingPreview('front')">Front</button>
            <button class="btn btn-secondary" id="greetingPreviewInsideBtn" onclick="showGreetingPreview('inside')">Inside</button>
          </div>
          <div id="greetingPreviewFront" style="display:flex;flex-direction:column;gap:16px;align-items:center;justify-content:center;min-height:350px;background:var(--surface-2);border-radius:8px;padding:20px;">
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 10h18"/></svg>
              <p>Upload a design to preview card</p>
            </div>
          </div>
          <div id="greetingPreviewInside" style="display:none;flex-direction:column;gap:16px;align-items:center;justify-content:center;min-height:350px;background:var(--surface-2);border-radius:8px;padding:20px;">
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="5" width="18" height="14" rx="2"/></svg>
              <p>Inside will be blank</p>
            </div>
          </div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:8px;text-align:center;">
            PDF will include printable layout with fold guides
          </div>
        </div>
      </div>
    </div>

    <!-- KIDS VALENTINE CARD MAKER -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: GREETING CARD CREATOR
// ============================================
    // ============================================
    // GREETING CARD MAKER
    // ============================================
    let greetingFront = null;
    let greetingLogo = null;
    let greetingInside = null;
    let greetingSize = '5x7';
    let greetingFold = 'half';
    let greetingBack = 'blank';
    let greetingInsideType = 'blank';

    function showGreetingPreview(tab) {
      document.getElementById('greetingPreviewFront').style.display = tab === 'front' ? 'flex' : 'none';
      document.getElementById('greetingPreviewInside').style.display = tab === 'inside' ? 'flex' : 'none';
      document.getElementById('greetingPreviewFrontBtn').classList.toggle('active', tab === 'front');
      document.getElementById('greetingPreviewInsideBtn').classList.toggle('active', tab === 'inside');
    }

    // Inside content type toggle
    document.querySelectorAll('#panel-greeting [data-inside]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-greeting [data-inside]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        greetingInsideType = btn.dataset.inside;
        document.getElementById('greetingMessageGroup').style.display = greetingInsideType === 'message' ? 'block' : 'none';
        document.getElementById('greetingInsideImageGroup').style.display = greetingInsideType === 'image' ? 'block' : 'none';
        renderGreetingInsidePreview();
      };
    });

    setupUploadZone('greetingUpload', 'greetingInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;

      const dataUrl = await readFileAsDataURL(file);
      const img = await loadImage(dataUrl);
      greetingFront = { name: Utils.getBaseName(file.name), img, dataUrl };

      renderGreetingPreview();
      document.getElementById('greetingDownload').disabled = false;
      Utils.toast('Front design loaded!');
    });

    setupUploadZone('greetingInsideUpload', 'greetingInsideInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;

      const dataUrl = await readFileAsDataURL(file);
      const img = await loadImage(dataUrl);
      greetingInside = { img, dataUrl };

      renderGreetingInsidePreview();
      Utils.toast('Inside image loaded!');
    });

    setupUploadZone('greetingLogoUpload', 'greetingLogoInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;

      const dataUrl = await readFileAsDataURL(file);
      const img = await loadImage(dataUrl);
      greetingLogo = { img, dataUrl };

      renderGreetingPreview();
      Utils.toast('Logo loaded!');
    });

    document.querySelectorAll('#panel-greeting [data-cardsize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-greeting [data-cardsize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        greetingSize = btn.dataset.cardsize;
        renderGreetingPreview();
      };
    });

    document.querySelectorAll('#panel-greeting [data-fold]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-greeting [data-fold]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        greetingFold = btn.dataset.fold;
        renderGreetingPreview();
      };
    });

    document.querySelectorAll('#panel-greeting [data-back]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-greeting [data-back]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        greetingBack = btn.dataset.back;
        document.getElementById('greetingLogoGroup').style.display = greetingBack === 'logo' ? 'block' : 'none';
        renderGreetingPreview();
      };
    });

    function getCardDimensions(size, fold) {
      // Dimensions in inches for FOLDED card
      const sizes = {
        '5x7': { w: 5, h: 7 },
        '4x6': { w: 4, h: 6 },
        'a2': { w: 4.25, h: 5.5 },
        'a7': { w: 5, h: 7 }
      };

      const folded = sizes[size] || sizes['5x7'];

      // Flat dimensions depend on fold type
      if (fold === 'half') {
        return { flatW: folded.w, flatH: folded.h * 2, foldedW: folded.w, foldedH: folded.h };
      } else if (fold === 'side') {
        return { flatW: folded.w * 2, flatH: folded.h, foldedW: folded.w, foldedH: folded.h };
      } else { // quarter
        return { flatW: folded.w * 2, flatH: folded.h * 2, foldedW: folded.w, foldedH: folded.h };
      }
    }

    function renderGreetingPreview() {
      const preview = document.getElementById('greetingPreviewFront');

      if (!greetingFront?.img) {
        preview.innerHTML = '<div class="empty-state"><p>Upload a design to preview card</p></div>';
        return;
      }

      const dims = getCardDimensions(greetingSize, greetingFold);
      const dpi = 300;
      const bleed = document.getElementById('greetingBleed').checked ? 0.125 : 0;

      // Create preview canvas (scaled down for display)
      const scale = 0.3;
      const flatW = (dims.flatW + bleed * 2) * dpi * scale;
      const flatH = (dims.flatH + bleed * 2) * dpi * scale;

      const { canvas, ctx } = Utils.createCanvas(flatW, flatH, '#ffffff');

      // Draw front panel
      const frontX = bleed * dpi * scale;
      const frontY = bleed * dpi * scale;
      const panelW = dims.foldedW * dpi * scale;
      const panelH = dims.foldedH * dpi * scale;

      // Position front based on fold type
      let fx, fy;
      if (greetingFold === 'half') {
        fx = frontX;
        fy = frontY + panelH; // Front is bottom half
      } else if (greetingFold === 'side') {
        fx = frontX + panelW; // Front is right half
        fy = frontY;
      } else { // quarter - front is bottom right
        fx = frontX + panelW;
        fy = frontY + panelH;
      }

      // Draw front image (fit to panel)
      const fScale = Math.min(panelW / greetingFront.img.width, panelH / greetingFront.img.height);
      const fw = greetingFront.img.width * fScale;
      const fh = greetingFront.img.height * fScale;
      ctx.drawImage(greetingFront.img, fx + (panelW - fw) / 2, fy + (panelH - fh) / 2, fw, fh);

      // Draw back panel
      if (greetingBack === 'mirror') {
        let bx, by;
        if (greetingFold === 'half') {
          bx = frontX; by = frontY;
        } else if (greetingFold === 'side') {
          bx = frontX; by = frontY;
        } else {
          bx = frontX; by = frontY;
        }
        ctx.drawImage(greetingFront.img, bx + (panelW - fw) / 2, by + (panelH - fh) / 2, fw, fh);
      } else if (greetingBack === 'logo' && greetingLogo?.img) {
        let bx, by;
        if (greetingFold === 'half') {
          bx = frontX; by = frontY;
        } else if (greetingFold === 'side') {
          bx = frontX; by = frontY;
        } else {
          bx = frontX; by = frontY;
        }
        const logoSize = Math.min(panelW, panelH) * 0.3;
        const lScale = Math.min(logoSize / greetingLogo.img.width, logoSize / greetingLogo.img.height);
        const lw = greetingLogo.img.width * lScale;
        const lh = greetingLogo.img.height * lScale;
        ctx.drawImage(greetingLogo.img, bx + (panelW - lw) / 2, by + panelH - lh - 20 * scale, lw, lh);
      }

      // Draw fold lines
      if (document.getElementById('greetingCutLines').checked) {
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);

        if (greetingFold === 'half') {
          ctx.beginPath();
          ctx.moveTo(0, flatH / 2);
          ctx.lineTo(flatW, flatH / 2);
          ctx.stroke();
        } else if (greetingFold === 'side') {
          ctx.beginPath();
          ctx.moveTo(flatW / 2, 0);
          ctx.lineTo(flatW / 2, flatH);
          ctx.stroke();
        } else {
          ctx.beginPath();
          ctx.moveTo(0, flatH / 2);
          ctx.lineTo(flatW, flatH / 2);
          ctx.moveTo(flatW / 2, 0);
          ctx.lineTo(flatW / 2, flatH);
          ctx.stroke();
        }
        ctx.setLineDash([]);
      }

      // Draw border
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 1;
      ctx.strokeRect(0, 0, flatW, flatH);

      preview.innerHTML = `
        <div style="text-align:center;">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Flat Layout (${dims.flatW}" √ó ${dims.flatH}")</div>
          <canvas id="greetingCanvas" style="max-width:100%;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,0.1);"></canvas>
          <div style="font-size:11px;color:var(--text-muted);margin-top:12px;">Folded size: ${dims.foldedW}" √ó ${dims.foldedH}"</div>
        </div>
      `;

      const displayCanvas = document.getElementById('greetingCanvas');
      displayCanvas.width = flatW;
      displayCanvas.height = flatH;
      displayCanvas.getContext('2d').drawImage(canvas, 0, 0);
    }

    document.getElementById('greetingCutLines').onchange = renderGreetingPreview;
    document.getElementById('greetingBleed').onchange = renderGreetingPreview;
    document.getElementById('greetingMessage').addEventListener('input', renderGreetingInsidePreview);

    function renderGreetingInsidePreview() {
      const preview = document.getElementById('greetingPreviewInside');
      const dims = getCardDimensions(greetingSize, greetingFold);
      const dpi = 300;
      const scale = 0.3;
      const panelW = dims.foldedW * dpi * scale;
      const panelH = dims.foldedH * dpi * scale;

      if (greetingInsideType === 'blank') {
        preview.innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="5" width="18" height="14" rx="2"/></svg><p>Inside will be blank</p></div>`;
        return;
      }

      const { canvas, ctx } = Utils.createCanvas(panelW, panelH, '#ffffff');

      if (greetingInsideType === 'message') {
        const message = document.getElementById('greetingMessage').value.trim();
        if (!message) {
          preview.innerHTML = `<div class="empty-state"><p>Enter a message above</p></div>`;
          return;
        }
        ctx.fillStyle = '#333';
        ctx.font = `${14 * scale}px Georgia, serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const lines = message.split('\n');
        const lineHeight = 20 * scale;
        const startY = panelH / 2 - (lines.length - 1) * lineHeight / 2;
        lines.forEach((line, i) => {
          ctx.fillText(line, panelW / 2, startY + i * lineHeight);
        });
      } else if (greetingInsideType === 'image' && greetingInside?.img) {
        const img = greetingInside.img;
        const iScale = Math.min(panelW / img.width, panelH / img.height) * 0.9;
        const iw = img.width * iScale;
        const ih = img.height * iScale;
        ctx.drawImage(img, (panelW - iw) / 2, (panelH - ih) / 2, iw, ih);
      } else if (greetingInsideType === 'image') {
        preview.innerHTML = `<div class="empty-state"><p>Upload inside image above</p></div>`;
        return;
      }

      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 1;
      ctx.strokeRect(0, 0, panelW, panelH);

      preview.innerHTML = `
        <div style="text-align:center;">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Inside Preview</div>
          <canvas id="greetingInsideCanvas" style="max-width:100%;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,0.1);"></canvas>
        </div>
      `;

      const displayCanvas = document.getElementById('greetingInsideCanvas');
      displayCanvas.width = panelW;
      displayCanvas.height = panelH;
      displayCanvas.getContext('2d').drawImage(canvas, 0, 0);
    }

    document.getElementById('greetingDownload').addEventListener('click', downloadGreetingCard);

    async function downloadGreetingCard() {
      if (!greetingFront?.img) {
        Utils.toast('Please upload a front design first', 'error');
        return;
      }

      const btn = document.getElementById('greetingDownload');
      btn.disabled = true;
      btn.textContent = '‚è≥ Creating PDF...';

      try {
        const { jsPDF } = window.jspdf;
        const dpi = 300;

        // US Letter: 8.5 x 11 inches
        const pageW = 11; // landscape
        const pageH = 8.5;
        const pxW = pageW * dpi; // 3300
        const pxH = pageH * dpi; // 2550

        // Each panel is 5.5 x 8.5, but card area is 5 x 7 centered
        const panelW = pxW / 2; // 1650px = 5.5"
        const panelH = pxH;     // 2550px = 8.5"
        const cardW = 5 * dpi;  // 1500px
        const cardH = 7 * dpi;  // 2100px
        const marginX = (panelW - cardW) / 2; // center card in panel
        const marginY = (panelH - cardH) / 2;

        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'in',
          format: 'letter'
        });

        // ========== PAGE 1: OUTSIDE (Back on left, Front on right) ==========
        const { canvas: page1, ctx: ctx1 } = Utils.createCanvas(pxW, pxH, '#ffffff');

        // Left half = BACK COVER (blank or logo)
        if (greetingBack === 'logo' && greetingLogo?.img) {
          const logo = greetingLogo.img;
          const logoMaxSize = 1 * dpi; // 1 inch max
          const lScale = Math.min(logoMaxSize / logo.width, logoMaxSize / logo.height);
          const lw = logo.width * lScale;
          const lh = logo.height * lScale;
          const lx = marginX + (cardW - lw) / 2;
          const ly = marginY + cardH - lh - (0.5 * dpi); // near bottom
          ctx1.drawImage(logo, lx, ly, lw, lh);
        } else if (greetingBack === 'mirror') {
          const img = greetingFront.img;
          const scale = Math.min(cardW / img.width, cardH / img.height);
          const w = img.width * scale;
          const h = img.height * scale;
          ctx1.drawImage(img, marginX + (cardW - w) / 2, marginY + (cardH - h) / 2, w, h);
        }
        // else blank

        // Right half = FRONT COVER
        const frontImg = greetingFront.img;
        const fScale = Math.min(cardW / frontImg.width, cardH / frontImg.height);
        const fw = frontImg.width * fScale;
        const fh = frontImg.height * fScale;
        const fx = panelW + marginX + (cardW - fw) / 2;
        const fy = marginY + (cardH - fh) / 2;
        ctx1.drawImage(frontImg, fx, fy, fw, fh);

        // Fold line (center)
        if (document.getElementById('greetingCutLines').checked) {
          ctx1.strokeStyle = '#cccccc';
          ctx1.lineWidth = 1;
          ctx1.setLineDash([15, 10]);
          ctx1.beginPath();
          ctx1.moveTo(panelW, 0);
          ctx1.lineTo(panelW, pxH);
          ctx1.stroke();
          ctx1.setLineDash([]);
        }

        pdf.addImage(page1.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pageW, pageH);

        // ========== PAGE 2: INSIDE (Left blank, Right has message/image) ==========
        pdf.addPage('letter', 'landscape');

        const { canvas: page2, ctx: ctx2 } = Utils.createCanvas(pxW, pxH, '#ffffff');

        // Left half = INSIDE LEFT (blank)
        // Right half = INSIDE RIGHT (message or image)
        const message = document.getElementById('greetingMessage').value.trim();

        if (greetingInsideType === 'message' && message) {
          ctx2.fillStyle = '#333333';
          ctx2.font = '60px Georgia, serif';
          ctx2.textAlign = 'center';
          ctx2.textBaseline = 'middle';
          const lines = message.split('\n');
          const lineHeight = 80;
          const centerX = panelW + panelW / 2;
          const centerY = pxH / 2;
          const startY = centerY - (lines.length - 1) * lineHeight / 2;
          lines.forEach((line, i) => {
            ctx2.fillText(line, centerX, startY + i * lineHeight);
          });
        } else if (greetingInsideType === 'image' && greetingInside?.img) {
          const insideImg = greetingInside.img;
          const iScale = Math.min(cardW / insideImg.width, cardH / insideImg.height);
          const iw = insideImg.width * iScale;
          const ih = insideImg.height * iScale;
          const ix = panelW + marginX + (cardW - iw) / 2;
          const iy = marginY + (cardH - ih) / 2;
          ctx2.drawImage(insideImg, ix, iy, iw, ih);
        }

        // Fold line (center)
        if (document.getElementById('greetingCutLines').checked) {
          ctx2.strokeStyle = '#cccccc';
          ctx2.lineWidth = 1;
          ctx2.setLineDash([15, 10]);
          ctx2.beginPath();
          ctx2.moveTo(panelW, 0);
          ctx2.lineTo(panelW, pxH);
          ctx2.stroke();
          ctx2.setLineDash([]);
        }

        pdf.addImage(page2.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pageW, pageH);

        // Download
        const blob = pdf.output('blob');
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${greetingFront.name}_greeting_card.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        Utils.toast('2-page PDF ready! Print double-sided, flip on short edge.');
      } catch (e) {
        console.error('PDF error:', e);
        Utils.toast('Error: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚¨áÔ∏è Download Card PDF';
      }
    }


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Kids Cards -->
<div class="tool-panel" id="panel-kidscard" style="display:none;">
      <h1 class="page-title">üíù Kids Card Sheet Maker</h1>
      <p class="page-subtitle">Create printable card sheets for Valentine's, Birthday, Holiday</p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Card Settings</div>

          <div class="upload-zone" id="kidscardUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop card designs (multiple OK)</div>
            <div class="upload-hint">PNG or JPG</div>
          </div>
          <input type="file" id="kidscardInput" accept="image/*" multiple class="hidden">

          <div id="kidscardDesignsList" style="margin-top:12px;display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <span style="font-size:12px;font-weight:600;">Designs (<span id="kidscardCount">0</span>)</span>
              <button class="btn btn-secondary btn-sm" id="kidscardClearAll" style="padding:4px 8px;font-size:10px;">Clear</button>
            </div>
            <div id="kidscardThumbs" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
          </div>

          <div class="settings-group" style="margin-top:16px;">
            <label>Card Size</label>
            <div class="size-buttons">
              <button class="btn btn-secondary" data-kidsize="2.5x3.5">2.5√ó3.5"</button>
              <button class="btn btn-secondary active" data-kidsize="3.5x2.5">3.5√ó2.5"</button>
              <button class="btn btn-secondary" data-kidsize="3x2">3√ó2"</button>
              <button class="btn btn-secondary" data-kidsize="2.5x2.5">2.5√ó2.5"</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Page</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-kidpage="letter-p">Letter Portrait</button>
              <button class="btn btn-secondary" data-kidpage="letter-l">Letter Landscape</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Fill Mode</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-kidfill="tile">Tile All</button>
              <button class="btn btn-secondary" data-kidfill="rotate">Rotate</button>
              <button class="btn btn-secondary" data-kidfill="random">Random</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Image Fit</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-kidfit="fill">Fill (crop)</button>
              <button class="btn btn-secondary" data-kidfit="fit">Fit (letterbox)</button>
              <button class="btn btn-secondary" data-kidfit="stretch">Stretch</button>
            </div>
          </div>

          <div class="settings-group" style="display:flex;gap:16px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="kidscardCutLines" checked style="width:auto;">
              <span>Cut lines</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="kidscardMultiPage" style="width:auto;">
              <span>Multi-page PDF (use all designs)</span>
            </label>
          </div>

          <div class="action-bar">
            <button class="btn btn-secondary" id="kidscardClear" disabled>üóëÔ∏è Clear All</button>
            <button class="btn btn-primary" id="kidscardDownload" disabled>‚¨áÔ∏è Download PDF</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Preview <span id="kidscardPageNav" style="display:none;margin-left:8px;font-size:12px;font-weight:400;"><button class="btn btn-secondary btn-sm" id="kidscardPrevPage" style="padding:2px 8px;">‚óÄ</button> <span id="kidscardPageNum">1</span>/<span id="kidscardTotalPages">1</span> <button class="btn btn-secondary btn-sm" id="kidscardNextPage" style="padding:2px 8px;">‚ñ∂</button></span></div>
          <div id="kidscardPreview" style="display:flex;align-items:center;justify-content:center;min-height:400px;background:#fff;border-radius:8px;overflow:hidden;">
            <div class="empty-state" style="color:#666;"><p>Upload card designs</p></div>
          </div>
          <div id="kidscardInfo" style="margin-top:8px;text-align:center;font-size:13px;color:var(--text-muted);font-weight:500;"></div>
        </div>
      </div>
    </div>

    <!-- INVITATION MAKER -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: KIDS CARD SHEETS
// ============================================
    // ============================================
    // KIDS CARD SHEET MAKER
    // ============================================
    let kidscardDesigns = [];
    let kidscardCanvases = [];
    let kidscardSize = '3.5x2.5';
    let kidscardPage = 'letter-p';
    let kidscardFill = 'tile';
    let kidscardFit = 'fill';
    let kidscardOrientation = 'portrait';
    let kidscardCurrentPage = 0;

    setupUploadZone('kidscardUpload', 'kidscardInput', async (files) => {
      for (const file of Array.from(files)) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const img = await loadImage(dataUrl);
        kidscardDesigns.push({ img, name: file.name, dataUrl });
      }
      renderKidscardThumbs();
      if (kidscardDesigns.length > 0) generateKidsCardSheet();
    });

    function renderKidscardThumbs() {
      const list = document.getElementById('kidscardDesignsList');
      const thumbs = document.getElementById('kidscardThumbs');
      const count = document.getElementById('kidscardCount');
      
      if (kidscardDesigns.length === 0) {
        list.style.display = 'none';
        document.getElementById('kidscardDownload').disabled = true;
        document.getElementById('kidscardClear').disabled = true;
        document.getElementById('kidscardInfo').textContent = '';
        return;
      }
      
      list.style.display = 'block';
      count.textContent = kidscardDesigns.length;
      document.getElementById('kidscardClear').disabled = false;
      thumbs.innerHTML = kidscardDesigns.map((d, i) => `
        <div style="position:relative;width:44px;height:44px;border-radius:4px;overflow:hidden;border:2px solid var(--border);">
          <img src="${d.dataUrl}" style="width:100%;height:100%;object-fit:cover;">
          <button onclick="removeKidscardDesign(${i})" style="position:absolute;top:-3px;right:-3px;width:16px;height:16px;border-radius:50%;background:#e74c3c;border:none;color:#fff;font-size:9px;cursor:pointer;line-height:1;">‚úï</button>
        </div>
      `).join('');
    }

    window.removeKidscardDesign = function(index) {
      kidscardDesigns.splice(index, 1);
      renderKidscardThumbs();
      if (kidscardDesigns.length > 0) generateKidsCardSheet();
      else {
        document.getElementById('kidscardPreview').innerHTML = '<div class="empty-state" style="color:#666;"><p>Upload card designs</p></div>';
        kidscardCanvases = [];
      }
    };

    function clearKidscard() {
      kidscardDesigns = [];
      kidscardCanvases = [];
      kidscardCurrentPage = 0;
      renderKidscardThumbs();
      document.getElementById('kidscardPreview').innerHTML = '<div class="empty-state" style="color:#666;"><p>Upload card designs</p></div>';
      document.getElementById('kidscardInfo').textContent = '';
      document.getElementById('kidscardPageNav').style.display = 'none';
      document.getElementById('kidscardClear').disabled = true;
      document.getElementById('kidscardDownload').disabled = true;
    }

    document.getElementById('kidscardClearAll').onclick = clearKidscard;
    document.getElementById('kidscardClear').onclick = clearKidscard;

    document.querySelectorAll('#panel-kidscard [data-kidsize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-kidscard [data-kidsize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        kidscardSize = btn.dataset.kidsize;
        if (kidscardDesigns.length > 0) generateKidsCardSheet();
      };
    });

    document.querySelectorAll('#panel-kidscard [data-kidpage]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-kidscard [data-kidpage]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        kidscardPage = btn.dataset.kidpage;
        if (kidscardDesigns.length > 0) generateKidsCardSheet();
      };
    });

    document.querySelectorAll('#panel-kidscard [data-kidfill]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-kidscard [data-kidfill]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        kidscardFill = btn.dataset.kidfill;
        if (kidscardDesigns.length > 0) generateKidsCardSheet();
      };
    });

    document.querySelectorAll('#panel-kidscard [data-kidfit]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-kidscard [data-kidfit]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        kidscardFit = btn.dataset.kidfit;
        if (kidscardDesigns.length > 0) generateKidsCardSheet();
      };
    });

    document.getElementById('kidscardCutLines').onchange = () => { if (kidscardDesigns.length > 0) generateKidsCardSheet(); };
    document.getElementById('kidscardMultiPage').onchange = () => { if (kidscardDesigns.length > 0) generateKidsCardSheet(); };

    document.getElementById('kidscardPrevPage').onclick = () => {
      if (kidscardCurrentPage > 0) {
        kidscardCurrentPage--;
        updateKidscardPreview();
      }
    };

    document.getElementById('kidscardNextPage').onclick = () => {
      if (kidscardCurrentPage < kidscardCanvases.length - 1) {
        kidscardCurrentPage++;
        updateKidscardPreview();
      }
    };

    function updateKidscardPreview() {
      if (kidscardCanvases.length === 0) return;
      const preview = document.getElementById('kidscardPreview');
      preview.innerHTML = `<img src="${kidscardCanvases[kidscardCurrentPage].toDataURL('image/jpeg', 0.85)}" style="max-width:100%;max-height:450px;box-shadow:0 2px 12px rgba(0,0,0,0.15);">`;
      document.getElementById('kidscardPageNum').textContent = kidscardCurrentPage + 1;
    }

    function generateKidsCardSheet() {
      if (kidscardDesigns.length === 0) return;

      const dpi = 300;
      const showCutLines = document.getElementById('kidscardCutLines').checked;
      const multiPage = document.getElementById('kidscardMultiPage').checked;

      // Page dimensions
      const isLandscape = kidscardPage.includes('-l');
      const pageW = isLandscape ? 11 * dpi : 8.5 * dpi;
      const pageH = isLandscape ? 8.5 * dpi : 11 * dpi;

      // Card dimensions - parse from size string
      const [cw, ch] = kidscardSize.split('x').map(Number);
      const cardW = cw * dpi;
      const cardH = ch * dpi;

      // Calculate optimal grid - minimal margins
      const margin = 0.125 * dpi; // 1/8 inch margin
      const gap = 0; // No gap between cards for maximum density
      
      const cols = Math.floor((pageW - margin * 2) / cardW);
      const rows = Math.floor((pageH - margin * 2) / cardH);
      
      if (cols === 0 || rows === 0) {
        Utils.toast('Card too large for page', 'error');
        return;
      }

      // Center the grid exactly
      const gridW = cols * cardW;
      const gridH = rows * cardH;
      const startX = (pageW - gridW) / 2;
      const startY = (pageH - gridH) / 2;

      const cardsPerPage = rows * cols;
      kidscardOrientation = isLandscape ? 'landscape' : 'portrait';

      // Determine how many pages needed
      let totalPages = 1;
      let designQueue = [];
      
      if (multiPage) {
        // Use all designs, randomize, create enough pages
        // Shuffle all designs
        designQueue = [...kidscardDesigns].sort(() => Math.random() - 0.5);
        totalPages = Math.ceil(designQueue.length / cardsPerPage);
      }

      kidscardCanvases = [];

      for (let pageNum = 0; pageNum < totalPages; pageNum++) {
        const { canvas, ctx } = Utils.createCanvas(pageW, pageH, '#ffffff');

        // Build card order for this page
        let cardOrder = [];
        
        if (multiPage) {
          // For multi-page: use sequential designs from shuffled queue
          for (let i = 0; i < cardsPerPage; i++) {
            const designIdx = pageNum * cardsPerPage + i;
            if (designIdx < designQueue.length) {
              cardOrder.push(kidscardDesigns.indexOf(designQueue[designIdx]));
            } else {
              // Fill remaining slots with random designs
              cardOrder.push(Math.floor(Math.random() * kidscardDesigns.length));
            }
          }
        } else {
          // Single page mode
          if (kidscardFill === 'tile' || kidscardFill === 'rotate') {
            for (let i = 0; i < cardsPerPage; i++) {
              cardOrder.push(i % kidscardDesigns.length);
            }
          } else { // random
            for (let i = 0; i < cardsPerPage; i++) {
              cardOrder.push(Math.floor(Math.random() * kidscardDesigns.length));
            }
          }
        }

        // Draw cards
        let idx = 0;
        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const x = startX + col * cardW;
            const y = startY + row * cardH;
            const design = kidscardDesigns[cardOrder[idx]];

            // Draw card background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x, y, cardW, cardH);

            // Draw image based on fit mode
            if (kidscardFit === 'stretch') {
              ctx.drawImage(design.img, x, y, cardW, cardH);
            } else if (kidscardFit === 'fill') {
              const scale = Math.max(cardW / design.img.width, cardH / design.img.height);
              const drawW = design.img.width * scale;
              const drawH = design.img.height * scale;
              const drawX = x + (cardW - drawW) / 2;
              const drawY = y + (cardH - drawH) / 2;
              ctx.save();
              ctx.beginPath();
              ctx.rect(x, y, cardW, cardH);
              ctx.clip();
              ctx.drawImage(design.img, drawX, drawY, drawW, drawH);
              ctx.restore();
            } else {
              const scale = Math.min(cardW / design.img.width, cardH / design.img.height);
              const drawW = design.img.width * scale;
              const drawH = design.img.height * scale;
              const drawX = x + (cardW - drawW) / 2;
              const drawY = y + (cardH - drawH) / 2;
              ctx.drawImage(design.img, drawX, drawY, drawW, drawH);
            }

            // Draw cut lines
            if (showCutLines) {
              ctx.strokeStyle = '#888888';
              ctx.lineWidth = 1;
              ctx.setLineDash([]);
              ctx.strokeRect(x, y, cardW, cardH);
            }

            idx++;
          }
        }

        // Draw outer crop marks
        if (showCutLines) {
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 0.5;
          ctx.setLineDash([]);
          const markLen = 0.125 * dpi;
          
          ctx.beginPath();
          ctx.moveTo(startX - markLen, startY);
          ctx.lineTo(startX - 2, startY);
          ctx.moveTo(startX, startY - markLen);
          ctx.lineTo(startX, startY - 2);
          ctx.moveTo(startX + gridW + 2, startY);
          ctx.lineTo(startX + gridW + markLen, startY);
          ctx.moveTo(startX + gridW, startY - markLen);
          ctx.lineTo(startX + gridW, startY - 2);
          ctx.moveTo(startX - markLen, startY + gridH);
          ctx.lineTo(startX - 2, startY + gridH);
          ctx.moveTo(startX, startY + gridH + 2);
          ctx.lineTo(startX, startY + gridH + markLen);
          ctx.moveTo(startX + gridW + 2, startY + gridH);
          ctx.lineTo(startX + gridW + markLen, startY + gridH);
          ctx.moveTo(startX + gridW, startY + gridH + 2);
          ctx.lineTo(startX + gridW, startY + gridH + markLen);
          ctx.stroke();
        }

        kidscardCanvases.push(canvas);
      }

      // Show/hide page navigation
      const pageNav = document.getElementById('kidscardPageNav');
      if (totalPages > 1) {
        pageNav.style.display = 'inline';
        document.getElementById('kidscardTotalPages').textContent = totalPages;
      } else {
        pageNav.style.display = 'none';
      }

      kidscardCurrentPage = 0;
      updateKidscardPreview();

      // Info
      document.getElementById('kidscardInfo').innerHTML = multiPage 
        ? `<strong>${totalPages} pages</strong> ‚Ä¢ ${cardsPerPage} cards/page ‚Ä¢ ${cw}√ó${ch}" each`
        : `<strong>${cardsPerPage} cards</strong> per page (${cols}√ó${rows}) ‚Ä¢ ${cw}√ó${ch}" each`;
      document.getElementById('kidscardDownload').disabled = false;
    }

    document.getElementById('kidscardDownload').onclick = async () => {
      if (kidscardCanvases.length === 0) return;

      const btn = document.getElementById('kidscardDownload');
      btn.disabled = true;
      btn.textContent = '‚è≥ Creating...';

      try {
        const { jsPDF } = window.jspdf;
        const isLandscape = kidscardOrientation === 'landscape';
        const w = isLandscape ? 11 : 8.5;
        const h = isLandscape ? 8.5 : 11;

        const pdf = new jsPDF({ 
          orientation: kidscardOrientation, 
          unit: 'in', 
          format: 'letter' 
        });
        
        for (let i = 0; i < kidscardCanvases.length; i++) {
          if (i > 0) pdf.addPage();
          const imgData = kidscardCanvases[i].toDataURL('image/jpeg', 0.95);
          pdf.addImage(imgData, 'JPEG', 0, 0, w, h);
        }

        const blob = pdf.output('blob');
        const pageLabel = kidscardCanvases.length > 1 ? `${kidscardCanvases.length}pages` : kidscardOrientation;
        downloadBlob(blob, `kids-cards-${kidscardSize}-${pageLabel}.pdf`);
        Utils.toast(`Downloaded ${kidscardCanvases.length} page PDF!`);
      } catch (e) {
        console.error(e);
        Utils.toast('Error creating PDF', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚¨áÔ∏è Download PDF';
      }
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Invitations -->
<div class="tool-panel" id="panel-invitation" style="display:none;">
      <h1 class="page-title">üíí Invitation Maker</h1>
      <p class="page-subtitle">Create printable invitations ‚Ä¢ Multiple per page ‚Ä¢ Wedding, Party, Baby Shower</p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Invitation Settings</div>

          <div class="upload-zone" id="invitationUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop invitation design</div>
            <div class="upload-hint">PNG or JPG</div>
          </div>
          <input type="file" id="invitationInput" accept="image/*" class="hidden">

          <div class="settings-group" style="margin-top:16px;">
            <label>Invitation Size</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-invsize="5x7">5√ó7"</button>
              <button class="btn btn-secondary" data-invsize="4x6">4√ó6"</button>
              <button class="btn btn-secondary" data-invsize="4x9">4√ó9" (Skinny)</button>
              <button class="btn btn-secondary" data-invsize="5x5">5√ó5" (Square)</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Cards Per Page</label>
            <div class="size-buttons">
              <button class="btn btn-secondary" data-invcount="1">1</button>
              <button class="btn btn-secondary active" data-invcount="2">2</button>
              <button class="btn btn-secondary" data-invcount="4">4</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Page Size</label>
            <select id="invitationPage" style="width:100%;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;color:var(--text);">
              <option value="letter">US Letter (8.5√ó11")</option>
              <option value="a4">A4</option>
              <option value="legal">Legal (8.5√ó14")</option>
            </select>
          </div>

          <div class="settings-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="invitationCutLines" checked style="width:auto;">
              <span>Add trim marks</span>
            </label>
          </div>

          <div class="action-bar">
            <button class="btn btn-primary" id="invitationGenerate" disabled>üìÑ Generate Sheet</button>
            <button class="btn btn-secondary" id="invitationDownload" disabled>‚¨áÔ∏è Download PDF</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Preview</div>
          <div id="invitationPreview" style="display:flex;align-items:center;justify-content:center;min-height:400px;background:#fff;border-radius:8px;overflow:hidden;">
            <div class="empty-state" style="color:#666;">
              <p>Upload an invitation design</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JOURNAL/PLANNER PAGE MAKER -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: INVITATIONS GENERATOR
// ============================================
    // ============================================
    // INVITATION MAKER
    // ============================================
    let invitationDesign = null;
    let invitationCanvas = null;
    let invitationSize = '5x7';
    let invitationCount = 2;

    setupUploadZone('invitationUpload', 'invitationInput', async (files) => {
      const file = files[0];
      if (!file?.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      invitationDesign = await loadImage(dataUrl);
      document.getElementById('invitationGenerate').disabled = false;
      Utils.toast('Invitation loaded!');
      generateInvitationSheet();
    });

    document.querySelectorAll('#panel-invitation [data-invsize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-invitation [data-invsize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        invitationSize = btn.dataset.invsize;
        if (invitationDesign) generateInvitationSheet();
      };
    });

    document.querySelectorAll('#panel-invitation [data-invcount]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-invitation [data-invcount]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        invitationCount = parseInt(btn.dataset.invcount);
        if (invitationDesign) generateInvitationSheet();
      };
    });

    document.getElementById('invitationGenerate').onclick = generateInvitationSheet;

    function generateInvitationSheet() {
      if (!invitationDesign) return;

      const dpi = 300;
      const pageSize = document.getElementById('invitationPage').value;
      const showTrimMarks = document.getElementById('invitationCutLines').checked;

      // Page dimensions
      const pageSizes = {
        'letter': { w: 8.5 * dpi, h: 11 * dpi },
        'a4': { w: 8.27 * dpi, h: 11.69 * dpi },
        'legal': { w: 8.5 * dpi, h: 14 * dpi }
      };
      const pageW = pageSizes[pageSize].w;
      const pageH = pageSizes[pageSize].h;

      // Invitation dimensions
      const invSizes = {
        '5x7': { w: 5 * dpi, h: 7 * dpi },
        '4x6': { w: 4 * dpi, h: 6 * dpi },
        '4x9': { w: 4 * dpi, h: 9 * dpi },
        '5x5': { w: 5 * dpi, h: 5 * dpi }
      };
      const invW = invSizes[invitationSize].w;
      const invH = invSizes[invitationSize].h;

      const { canvas, ctx } = Utils.createCanvas(pageW, pageH, '#ffffff');

      // Layout based on count
      let positions = [];
      if (invitationCount === 1) {
        positions = [{ x: (pageW - invW) / 2, y: (pageH - invH) / 2 }];
      } else if (invitationCount === 2) {
        const gap = 0.25 * dpi;
        positions = [
          { x: (pageW - invW) / 2, y: (pageH - invH * 2 - gap) / 2 },
          { x: (pageW - invW) / 2, y: (pageH - invH * 2 - gap) / 2 + invH + gap }
        ];
      } else if (invitationCount === 4) {
        const gap = 0.25 * dpi;
        positions = [
          { x: (pageW - invW * 2 - gap) / 2, y: (pageH - invH * 2 - gap) / 2 },
          { x: (pageW - invW * 2 - gap) / 2 + invW + gap, y: (pageH - invH * 2 - gap) / 2 },
          { x: (pageW - invW * 2 - gap) / 2, y: (pageH - invH * 2 - gap) / 2 + invH + gap },
          { x: (pageW - invW * 2 - gap) / 2 + invW + gap, y: (pageH - invH * 2 - gap) / 2 + invH + gap }
        ];
      }

      // Draw invitations
      positions.forEach(pos => {
        ctx.drawImage(invitationDesign, pos.x, pos.y, invW, invH);

        if (showTrimMarks) {
          ctx.strokeStyle = '#999';
          ctx.lineWidth = 1;
          const markLen = 15;
          // Corner marks
          [[0,0], [invW,0], [0,invH], [invW,invH]].forEach(([ox, oy]) => {
            const x = pos.x + ox;
            const y = pos.y + oy;
            ctx.beginPath();
            ctx.moveTo(x - (ox === 0 ? markLen : -markLen), y);
            ctx.lineTo(x + (ox === 0 ? -5 : 5), y);
            ctx.moveTo(x, y - (oy === 0 ? markLen : -markLen));
            ctx.lineTo(x, y + (oy === 0 ? -5 : 5));
            ctx.stroke();
          });
        }
      });

      invitationCanvas = canvas;

      const preview = document.getElementById('invitationPreview');
      preview.innerHTML = `<img src="${canvas.toDataURL('image/jpeg', 0.7)}" style="max-width:100%;max-height:450px;">`;

      document.getElementById('invitationDownload').disabled = false;
    }

    document.getElementById('invitationDownload').onclick = async () => {
      if (!invitationCanvas) return;

      const { jsPDF } = window.jspdf;
      const pageSize = document.getElementById('invitationPage').value;

      const pdf = new jsPDF({ orientation: 'portrait', unit: 'in', format: pageSize });
      const imgData = invitationCanvas.toDataURL('image/jpeg', 0.95);

      const sizes = { letter: [8.5, 11], a4: [8.27, 11.69], legal: [8.5, 14] };
      const [w, h] = sizes[pageSize];

      pdf.addImage(imgData, 'JPEG', 0, 0, w, h);

      const blob = pdf.output('blob');
      downloadBlob(blob, 'invitation-sheet.pdf');
      Utils.toast('Downloaded invitation sheet!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Journal Builder -->
<div class="tool-panel" id="panel-journal" style="display:none;">
      <h1 class="page-title">üìì Journal & Planner Page Maker</h1>
      <p class="page-subtitle">Create printable journal pages, planner inserts, and lined pages</p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Page Settings</div>

          <div class="settings-group">
            <label>Page Type</label>
            <select id="journalType" style="width:100%;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;color:var(--text);">
              <option value="lined">Lined Paper</option>
              <option value="dotgrid">Dot Grid</option>
              <option value="graph">Graph Paper</option>
              <option value="blank">Blank</option>
              <option value="cornell">Cornell Notes</option>
              <option value="daily">Daily Planner</option>
              <option value="weekly">Weekly Spread</option>
              <option value="monthly">Monthly Calendar</option>
              <option value="habit">Habit Tracker</option>
              <option value="gratitude">Gratitude Journal</option>
            </select>
          </div>

          <div class="settings-group">
            <label>Page Size</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-journalsize="letter">Letter</button>
              <button class="btn btn-secondary" data-journalsize="a4">A4</button>
              <button class="btn btn-secondary" data-journalsize="a5">A5</button>
              <button class="btn btn-secondary" data-journalsize="half">Half Letter</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Line Spacing <span class="range-value" id="journalSpacingVal">Medium</span></label>
            <input type="range" id="journalSpacing" min="1" max="3" value="2">
          </div>

          <div class="settings-group">
            <label>Line/Grid Darkness <span class="range-value" id="journalDarknessVal">50%</span></label>
            <input type="range" id="journalDarkness" min="0" max="100" value="50">
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:2px;">
              <span>Light</span>
              <span>Dark</span>
            </div>
          </div>

          <div class="settings-group">
            <label>Line/Grid Color</label>
            <div style="display:flex;gap:8px;">
              <input type="color" id="journalLineColor" value="#888888" style="flex:1;height:40px;border:none;border-radius:8px;cursor:pointer;">
              <button class="btn btn-secondary" onclick="document.getElementById('journalLineColor').value='#888888';">Gray</button>
              <button class="btn btn-secondary" onclick="document.getElementById('journalLineColor').value='#6B9BD2';">Blue</button>
              <button class="btn btn-secondary" onclick="document.getElementById('journalLineColor').value='#D4A5A5';">Pink</button>
            </div>
          </div>

          <div class="settings-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="journalHeader" checked style="width:auto;">
              <span>Add header area for date/title</span>
            </label>
          </div>

          <div class="settings-group">
            <label>Background Image (optional)</label>
            <div class="upload-zone" id="journalBgUpload" style="padding:12px;">
              <div class="upload-text" style="font-size:12px;">Drop decorative background</div>
            </div>
            <input type="file" id="journalBgInput" accept="image/*" class="hidden">
            <div id="journalBgOpacityWrap" style="display:none;margin-top:8px;">
              <label>Background Opacity <span class="range-value" id="journalBgOpacityVal">30%</span></label>
              <input type="range" id="journalBgOpacity" min="5" max="100" value="30">
              <button class="btn btn-secondary" onclick="clearJournalBg()" style="margin-top:8px;width:100%;font-size:12px;">‚úï Remove Background</button>
            </div>
          </div>

          <div class="action-bar">
            <button class="btn btn-primary" id="journalGenerate">üìÑ Generate Page</button>
            <button class="btn btn-secondary" id="journalDownload" disabled>‚¨áÔ∏è Download PDF</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Preview</div>
          <div id="journalPreview" style="display:flex;align-items:center;justify-content:center;min-height:450px;background:#fff;border-radius:8px;overflow:hidden;">
            <div class="empty-state" style="color:#666;">
              <p>Click Generate to preview page</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAG GENERATOR --><!-- COLOR PALETTE -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: JOURNAL PAGE BUILDER
// ============================================
    // ============================================
    // JOURNAL/PLANNER PAGE MAKER
    // ============================================
    let journalCanvas = null;
    let journalBgImg = null;
    let journalSize = 'letter';

    setupUploadZone('journalBgUpload', 'journalBgInput', async (files) => {
      const file = files[0];
      if (!file?.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      journalBgImg = await loadImage(dataUrl);
      document.getElementById('journalBgOpacityWrap').style.display = 'block';
      document.querySelector('#journalBgUpload .upload-text').textContent = '‚úÖ Image loaded';
      Utils.toast('Background loaded!');
    });

    function clearJournalBg() {
      journalBgImg = null;
      document.getElementById('journalBgOpacityWrap').style.display = 'none';
      document.querySelector('#journalBgUpload .upload-text').textContent = 'Drop decorative background';
      Utils.toast('Background removed');
    }

    document.querySelectorAll('#panel-journal [data-journalsize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-journal [data-journalsize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        journalSize = btn.dataset.journalsize;
      };
    });

    document.getElementById('journalSpacing').oninput = (e) => {
      const labels = ['Narrow', 'Medium', 'Wide'];
      document.getElementById('journalSpacingVal').textContent = labels[e.target.value - 1];
    };

    document.getElementById('journalDarkness').oninput = (e) => {
      document.getElementById('journalDarknessVal').textContent = e.target.value + '%';
    };

    document.getElementById('journalBgOpacity').oninput = (e) => {
      document.getElementById('journalBgOpacityVal').textContent = e.target.value + '%';
    };

    document.getElementById('journalGenerate').onclick = generateJournalPage;

    function generateJournalPage() {
      const dpi = 300;
      const type = document.getElementById('journalType').value;
      const spacingLevel = parseInt(document.getElementById('journalSpacing').value);
      const baseColor = document.getElementById('journalLineColor').value;
      const darkness = parseInt(document.getElementById('journalDarkness').value) / 100;
      const showHeader = document.getElementById('journalHeader').checked;
      const bgOpacity = parseInt(document.getElementById('journalBgOpacity').value) / 100;

      // Calculate line color based on darkness
      const hexToRgb = (hex) => {
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        return {r, g, b};
      };
      const rgb = hexToRgb(baseColor);
      // Blend with white based on darkness (0 = very light, 1 = full color)
      const blend = (c) => Math.round(255 - (255 - c) * darkness);
      const lineColor = `rgb(${blend(rgb.r)}, ${blend(rgb.g)}, ${blend(rgb.b)})`;

      // Page dimensions
      const pageSizes = {
        'letter': { w: 8.5 * dpi, h: 11 * dpi },
        'a4': { w: 8.27 * dpi, h: 11.69 * dpi },
        'a5': { w: 5.83 * dpi, h: 8.27 * dpi },
        'half': { w: 5.5 * dpi, h: 8.5 * dpi }
      };
      const pageW = pageSizes[journalSize].w;
      const pageH = pageSizes[journalSize].h;

      const { canvas, ctx } = Utils.createCanvas(pageW, pageH, '#ffffff');

      // Draw background image FIRST if provided
      if (journalBgImg) {
        ctx.globalAlpha = bgOpacity;
        ctx.drawImage(journalBgImg, 0, 0, pageW, pageH);
        ctx.globalAlpha = 1;
      }

      const margin = 0.5 * dpi;
      const headerH = showHeader ? 0.75 * dpi : 0;
      const contentTop = margin + headerH;
      const lineSpacing = [20, 28, 36][spacingLevel - 1];

      ctx.strokeStyle = lineColor;
      ctx.fillStyle = lineColor;
      ctx.lineWidth = 1;

      // Draw based on type
      if (type === 'lined') {
        for (let y = contentTop; y < pageH - margin; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }
      } else if (type === 'blank') {
        // Just a blank page with border
        ctx.strokeStyle = lineColor;
        ctx.strokeRect(margin, contentTop, pageW - margin * 2, pageH - contentTop - margin);
      } else if (type === 'dotgrid') {
        const dotSpacing = lineSpacing;
        for (let y = contentTop; y < pageH - margin; y += dotSpacing) {
          for (let x = margin; x < pageW - margin; x += dotSpacing) {
            ctx.beginPath();
            ctx.arc(x, y, 1.5, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      } else if (type === 'graph') {
        const gridSize = lineSpacing;
        for (let y = contentTop; y < pageH - margin; y += gridSize) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }
        for (let x = margin; x < pageW - margin; x += gridSize) {
          ctx.beginPath();
          ctx.moveTo(x, contentTop);
          ctx.lineTo(x, pageH - margin);
          ctx.stroke();
        }
      } else if (type === 'cornell') {
        const cueCol = 2 * dpi; // Left column width
        const summaryH = 1.5 * dpi; // Bottom summary height

        // Main vertical divider
        ctx.beginPath();
        ctx.moveTo(margin + cueCol, contentTop);
        ctx.lineTo(margin + cueCol, pageH - margin - summaryH);
        ctx.stroke();

        // Horizontal line for summary section
        ctx.beginPath();
        ctx.moveTo(margin, pageH - margin - summaryH);
        ctx.lineTo(pageW - margin, pageH - margin - summaryH);
        ctx.stroke();

        // Lines in CUE column (left)
        for (let y = contentTop + lineSpacing; y < pageH - margin - summaryH; y += lineSpacing * 2) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(margin + cueCol - 10, y);
          ctx.stroke();
        }

        // Lines in NOTES column (right)
        for (let y = contentTop + lineSpacing; y < pageH - margin - summaryH; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin + cueCol + 10, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

        // Lines in SUMMARY section (bottom)
        for (let y = pageH - margin - summaryH + lineSpacing; y < pageH - margin; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

        // Labels
        ctx.fillStyle = '#999';
        ctx.font = '10px Georgia, serif';
        ctx.fillText('CUE COLUMN', margin + 5, contentTop + 15);
        ctx.fillText('NOTES', margin + cueCol + 15, contentTop + 15);
        ctx.fillText('SUMMARY', margin + 5, pageH - margin - summaryH + 15);

      } else if (type === 'weekly') {
        // Weekly spread - 7 day columns
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const colWidth = (pageW - margin * 2) / 7;
        const headerHeight = 40;

        ctx.font = 'bold 12px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.strokeStyle = lineColor;

        // Draw week header
        ctx.font = 'bold 16px Georgia, serif';
        ctx.textAlign = 'center';
        ctx.fillText('Week of: _________________', pageW / 2, contentTop + 20);
        ctx.textAlign = 'left';
        ctx.font = 'bold 11px Georgia, serif';

        const gridTop = contentTop + 50;
        const gridHeight = pageH - margin - gridTop;

        // Draw day columns
        days.forEach((day, i) => {
          const x = margin + i * colWidth;

          // Day header
          ctx.fillStyle = '#333';
          ctx.fillText(day, x + 5, gridTop + 15);

          // Vertical line
          if (i > 0) {
            ctx.beginPath();
            ctx.moveTo(x, gridTop);
            ctx.lineTo(x, gridTop + gridHeight);
            ctx.stroke();
          }

          // Horizontal lines in each column
          ctx.strokeStyle = lineColor;
          for (let y = gridTop + headerHeight; y < gridTop + gridHeight; y += lineSpacing) {
            ctx.beginPath();
            ctx.moveTo(x + 2, y);
            ctx.lineTo(x + colWidth - 2, y);
            ctx.stroke();
          }
        });

        // Border around grid
        ctx.strokeStyle = lineColor;
        ctx.strokeRect(margin, gridTop, pageW - margin * 2, gridHeight);

        // Header line under day names
        ctx.beginPath();
        ctx.moveTo(margin, gridTop + headerHeight - 10);
        ctx.lineTo(pageW - margin, gridTop + headerHeight - 10);
        ctx.stroke();

      } else if (type === 'monthly') {
        // Monthly calendar grid
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const cols = 7;
        const rows = 6; // 6 weeks max
        const cellWidth = (pageW - margin * 2) / cols;
        const headerHeight = 50;
        const cellHeight = (pageH - margin - contentTop - headerHeight - 60) / rows;

        ctx.font = 'bold 18px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.fillText('Month: _________________  Year: _______', pageW / 2, contentTop + 25);

        const gridTop = contentTop + headerHeight;

        // Day headers
        ctx.font = 'bold 12px Georgia, serif';
        days.forEach((day, i) => {
          const x = margin + i * cellWidth + cellWidth / 2;
          ctx.fillText(day, x, gridTop + 20);
        });

        // Grid lines
        ctx.strokeStyle = lineColor;
        ctx.textAlign = 'left';
        ctx.font = '14px Georgia, serif';

        const calTop = gridTop + 35;

        // Draw grid
        for (let row = 0; row <= rows; row++) {
          const y = calTop + row * cellHeight;
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

        for (let col = 0; col <= cols; col++) {
          const x = margin + col * cellWidth;
          ctx.beginPath();
          ctx.moveTo(x, calTop);
          ctx.lineTo(x, calTop + rows * cellHeight);
          ctx.stroke();
        }

        // Add date numbers (1-31 placeholder positions)
        ctx.fillStyle = '#999';
        ctx.font = '12px Georgia, serif';
        let date = 1;
        for (let row = 0; row < rows && date <= 31; row++) {
          for (let col = 0; col < cols && date <= 31; col++) {
            const x = margin + col * cellWidth + 8;
            const y = calTop + row * cellHeight + 18;
            ctx.fillText(date.toString(), x, y);
            date++;
          }
        }

        // Notes section at bottom
        ctx.fillStyle = '#333';
        ctx.font = 'bold 12px Georgia, serif';
        const notesY = calTop + rows * cellHeight + 20;
        ctx.fillText('Notes:', margin, notesY);
        ctx.strokeStyle = lineColor;
        for (let y = notesY + 15; y < pageH - margin; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

      } else if (type === 'daily') {
        const availHeight = pageH - contentTop - margin;

        ctx.font = 'bold 14px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.fillText('DATE: _______________', margin, contentTop + 25);

        // Top priorities section
        ctx.fillText('TOP 3 PRIORITIES', margin, contentTop + 65);
        ctx.font = '12px Georgia, serif';
        for (let i = 0; i < 3; i++) {
          const y = contentTop + 90 + i * 28;
          ctx.fillText(`${i + 1}.`, margin, y);
          ctx.beginPath();
          ctx.moveTo(margin + 20, y + 3);
          ctx.lineTo(pageW / 2 - 20, y + 3);
          ctx.stroke();
        }

        // To-do section (right side)
        ctx.font = 'bold 14px Georgia, serif';
        ctx.fillText('TO-DO', pageW / 2 + 20, contentTop + 65);
        ctx.font = '12px Georgia, serif';
        for (let i = 0; i < 6; i++) {
          const y = contentTop + 90 + i * 25;
          ctx.strokeRect(pageW / 2 + 20, y - 10, 12, 12);
          ctx.beginPath();
          ctx.moveTo(pageW / 2 + 40, y + 3);
          ctx.lineTo(pageW - margin, y + 3);
          ctx.stroke();
        }

        // Schedule section
        ctx.font = 'bold 14px Georgia, serif';
        ctx.fillText('SCHEDULE', margin, contentTop + 200);
        ctx.font = '11px Georgia, serif';
        const times = ['6 AM', '7 AM', '8 AM', '9 AM', '10 AM', '11 AM', '12 PM', '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM', '8 PM', '9 PM'];
        const scheduleStart = contentTop + 225;
        const timeSlotHeight = (availHeight - 280) / times.length;

        times.forEach((t, i) => {
          const y = scheduleStart + i * timeSlotHeight;
          ctx.fillStyle = '#333';
          ctx.fillText(t, margin, y + 12);
          ctx.strokeStyle = lineColor;
          ctx.beginPath();
          ctx.moveTo(margin + 45, y + timeSlotHeight);
          ctx.lineTo(pageW - margin, y + timeSlotHeight);
          ctx.stroke();
        });

        // Notes section at bottom
        ctx.fillStyle = '#333';
        ctx.font = 'bold 14px Georgia, serif';
        const notesStart = pageH - margin - 100;
        ctx.fillText('NOTES', margin, notesStart);
        ctx.strokeStyle = lineColor;
        for (let y = notesStart + 20; y < pageH - margin; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

      } else if (type === 'habit') {
        ctx.font = 'bold 18px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.fillText('HABIT TRACKER', pageW / 2, contentTop + 30);
        ctx.textAlign = 'left';

        // Week label
        ctx.font = '12px Georgia, serif';
        ctx.fillText('Week of: _________________', margin, contentTop + 60);

        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const boxSize = Math.min(30, (pageW - margin * 2 - 180) / 7 - 5);
        const startX = margin + 180;
        const rowHeight = boxSize + 12;
        const maxHabits = Math.floor((pageH - contentTop - 120 - margin) / rowHeight);

        ctx.strokeStyle = lineColor;

        // Header row with days
        ctx.font = 'bold 11px Georgia, serif';
        days.forEach((d, i) => {
          ctx.fillText(d, startX + i * (boxSize + 5), contentTop + 90);
        });

        // Habit rows
        ctx.font = '12px Georgia, serif';
        for (let row = 0; row < maxHabits; row++) {
          const y = contentTop + 110 + row * rowHeight;

          // Habit name line
          ctx.beginPath();
          ctx.moveTo(margin, y + boxSize - 5);
          ctx.lineTo(margin + 165, y + boxSize - 5);
          ctx.stroke();

          // Checkbox for each day
          days.forEach((d, i) => {
            ctx.strokeRect(startX + i * (boxSize + 5), y, boxSize, boxSize);
          });
        }

      } else if (type === 'gratitude') {
        ctx.font = 'bold 20px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.fillText('Today I am grateful for...', pageW / 2, contentTop + 40);
        ctx.textAlign = 'left';

        ctx.font = '12px Georgia, serif';
        ctx.fillText('Date: _______________', margin, contentTop + 70);

        // Calculate how many items fit
        const itemHeight = 60;
        const availSpace = pageH - contentTop - 100 - margin;
        const numItems = Math.floor(availSpace / itemHeight);

        ctx.font = '14px Georgia, serif';
        ctx.strokeStyle = lineColor;

        for (let i = 0; i < numItems; i++) {
          const y = contentTop + 110 + i * itemHeight;
          ctx.fillStyle = '#333';
          ctx.fillText(`${i + 1}.`, margin, y + 5);

          // Two lines per item for writing
          ctx.beginPath();
          ctx.moveTo(margin + 25, y + 8);
          ctx.lineTo(pageW - margin, y + 8);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(margin + 25, y + 35);
          ctx.lineTo(pageW - margin, y + 35);
          ctx.stroke();
        }
      }

      // Draw header area
      if (showHeader && type !== 'daily' && type !== 'habit' && type !== 'gratitude') {
        ctx.strokeStyle = lineColor;
        ctx.beginPath();
        ctx.moveTo(margin, contentTop - 10);
        ctx.lineTo(pageW - margin, contentTop - 10);
        ctx.stroke();
      }

      journalCanvas = canvas;

      const preview = document.getElementById('journalPreview');
      preview.innerHTML = `<img src="${canvas.toDataURL('image/jpeg', 0.8)}" style="max-width:100%;max-height:500px;">`;

      document.getElementById('journalDownload').disabled = false;
      Utils.toast('Journal page generated!');
    }

    document.getElementById('journalDownload').onclick = async () => {
      if (!journalCanvas) return;

      const { jsPDF } = window.jspdf;
      const format = journalSize === 'half' ? [5.5, 8.5] : journalSize;

      const pdf = new jsPDF({ orientation: 'portrait', unit: 'in', format });
      const imgData = journalCanvas.toDataURL('image/jpeg', 0.95);

      const sizes = {
        'letter': [8.5, 11],
        'a4': [8.27, 11.69],
        'a5': [5.83, 8.27],
        'half': [5.5, 8.5]
      };
      const [w, h] = sizes[journalSize];

      pdf.addImage(imgData, 'JPEG', 0, 0, w, h);

      const blob = pdf.output('blob');
      const type = document.getElementById('journalType').value;
      downloadBlob(blob, `${type}-page.pdf`);
      Utils.toast('Downloaded journal page!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Sticker Sheet -->
<div class="tool-panel" id="panel-sticker" style="display:none;">
      <h1 class="page-title">üè∑Ô∏è Sticker Sheet Arranger</h1>
      <p class="page-subtitle">Arrange stickers onto printable sheets for Cricut, Silhouette, or print-and-cut</p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Settings</div>
          <div class="upload-zone" id="stickerUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop sticker PNGs</div>
            <div class="upload-hint">Transparent backgrounds work best</div>
          </div>
          <input type="file" id="stickerInput" accept="image/*" multiple class="hidden">

          <div class="settings-group" style="margin-top:16px;">
            <label>Sheet Size</label>
            <select id="stickerSheetSize" style="width:100%;padding:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;color:var(--text);">
              <option value="letter">US Letter (8.5√ó11")</option>
              <option value="a4">A4</option>
              <option value="4x6">4√ó6" Photo</option>
            </select>
          </div>

          <div class="settings-group">
            <label>Sticker Size</label>
            <div class="size-buttons">
              <button class="btn btn-secondary" data-size="0.75">0.75"</button>
              <button class="btn btn-secondary active" data-size="1">1"</button>
              <button class="btn btn-secondary" data-size="1.5">1.5"</button>
              <button class="btn btn-secondary" data-size="2">2"</button>
            </div>
          </div>

          <div class="settings-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="stickerCutLines" checked style="width:auto;">
              <span>Add cut lines (for print & cut)</span>
            </label>
          </div>

          <div class="settings-group">
            <label>Cut Line Style</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-cutstyle="kiss">Kiss Cut</button>
              <button class="btn btn-secondary" data-cutstyle="die">Die Cut</button>
            </div>
          </div>

          <div class="settings-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="stickerRegMarks" style="width:auto;">
              <span>Add registration marks (for print shops)</span>
            </label>
          </div>

          <div class="action-bar">
            <button class="btn btn-primary" id="stickerDownload" disabled>‚¨áÔ∏è Download Sheet</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Sheet Preview <span id="stickerCount">(0 stickers)</span></div>
          <div id="stickerPreview" style="display:flex;align-items:center;justify-content:center;min-height:400px;background:#fff;border-radius:8px;">
            <div class="empty-state" style="color:#666;">
              <p>Add stickers to arrange on sheet</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- GREETING CARD MAKER -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: STICKER SHEET BUILDER
// ============================================
    // ============================================
    // STICKER SHEET
    // ============================================
    let stickerFiles = [];

    setupUploadZone('stickerUpload', 'stickerInput', async (fileList) => {
      const files = Array.from(fileList);
      const statusEl = document.getElementById('stickerCount');
      statusEl.textContent = `(loading ${files.length} files...)`;

      let added = 0;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.startsWith('image/')) continue;
        try {
          statusEl.textContent = `(loading ${i + 1}/${files.length}...)`;
          const dataUrl = await readFileAsDataURL(file);
          const img = await loadImage(dataUrl);
          stickerFiles.push({ img, name: Utils.getBaseName(file.name), dataUrl });
          added++;
        } catch (err) {
          console.error('Failed to load sticker:', file.name, err);
        }
      }
      renderStickerSheet();
      if (added > 0) Utils.toast(`Added ${added} stickers!`);
    });

    document.querySelectorAll('#panel-sticker [data-size]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-sticker [data-size]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderStickerSheet();
      };
    });

    document.getElementById('stickerSheetSize').onchange = renderStickerSheet;
    document.getElementById('stickerCutLines').onchange = renderStickerSheet;

    function renderStickerSheet() {
      const preview = document.getElementById('stickerPreview');
      if (stickerFiles.length === 0) {
        preview.innerHTML = '<div class="empty-state" style="color:#666;"><p>Add stickers to arrange on sheet</p></div>';
        document.getElementById('stickerDownload').disabled = true;
        document.getElementById('stickerCount').textContent = '(0 stickers)';
        return;
      }

      const sheetSize = document.getElementById('stickerSheetSize').value;
      const stickerInch = parseFloat(document.querySelector('#panel-sticker [data-size].active')?.dataset.size || 1);
      const showCutLines = document.getElementById('stickerCutLines').checked;

      const sizes = { letter: [8.5, 11], a4: [8.27, 11.69], '4x6': [4, 6] };
      const [wInch, hInch] = sizes[sheetSize] || sizes.letter;
      const dpi = 300;
      const w = Math.round(wInch * dpi), h = Math.round(hInch * dpi);
      const stickerPx = Math.round(stickerInch * dpi);
      const padding = Math.round(0.25 * dpi);

      const { canvas, ctx } = Utils.createCanvas(w, h, '#ffffff');

      const cols = Math.floor((w - padding * 2) / (stickerPx + padding/2));
      const rows = Math.floor((h - padding * 2) / (stickerPx + padding/2));
      const maxStickers = cols * rows;

      let idx = 0;
      for (let row = 0; row < rows && idx < stickerFiles.length; row++) {
        for (let col = 0; col < cols && idx < stickerFiles.length; col++) {
          const x = padding + col * (stickerPx + padding/2);
          const y = padding + row * (stickerPx + padding/2);
          const sticker = stickerFiles[idx].img;

          const scale = Math.min(stickerPx / sticker.width, stickerPx / sticker.height);
          const sw = sticker.width * scale, sh = sticker.height * scale;
          const sx = x + (stickerPx - sw) / 2, sy = y + (stickerPx - sh) / 2;

          ctx.drawImage(sticker, sx, sy, sw, sh);

          if (showCutLines) {
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(x, y, stickerPx, stickerPx);
            ctx.setLineDash([]);
          }
          idx++;
        }
      }

      window.stickerCanvas = canvas;
      window.stickerFullDataUrl = canvas.toDataURL('image/png', 0.9);
      const sheetsNeeded = Math.ceil(stickerFiles.length / maxStickers);
      const overflow = stickerFiles.length > maxStickers ? `<div style="color:var(--accent-orange);font-size:12px;margin-top:8px;">‚ö†Ô∏è ${stickerFiles.length - maxStickers} stickers overflow - need ${sheetsNeeded} sheets</div>` : '';

      preview.innerHTML = `
        <div style="text-align:center;">
          <img src="${canvas.toDataURL('image/jpeg', 0.5)}" style="max-width:100%;max-height:450px;box-shadow:0 4px 20px rgba(0,0,0,0.2);cursor:zoom-in;" class="preview-thumb" id="stickerPreviewImg">
          <div style="margin-top:8px;font-size:12px;color:var(--text-muted);">Click to enlarge ‚Ä¢ ${cols}√ó${rows} grid (${maxStickers} per sheet)</div>
          ${overflow}
          <button class="btn btn-secondary" style="margin-top:12px;" onclick="stickerFiles=[];renderStickerSheet();">üóëÔ∏è Clear All Stickers</button>
        </div>
      `;

      document.getElementById('stickerPreviewImg').onclick = () => {
        openLightbox(window.stickerFullDataUrl, 0, 'Sticker Sheet Preview');
      };

      document.getElementById('stickerCount').textContent = `(${stickerFiles.length} stickers)`;
      document.getElementById('stickerDownload').disabled = false;
    }

    document.getElementById('stickerDownload').onclick = async () => {
      if (!window.stickerCanvas) return;
      const blob = await Utils.canvasToBlob(window.stickerCanvas, 'image/png');
      downloadBlob(blob, 'sticker-sheet.png');
      Utils.toast('Sticker sheet downloaded!');
    };

    // ============================================
    // STICKER SHEET - Cut Style
    // ============================================
    let stickerCutStyle = 'kiss';

    document.querySelectorAll('#panel-sticker [data-cutstyle]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-sticker [data-cutstyle]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        stickerCutStyle = btn.dataset.cutstyle;
        renderStickerSheet();
      };
    });

    // Track recent files on upload
    const originalSetupUploadZone = setupUploadZone;
    // Note: File tracking is handled within each upload handler


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Color Palette -->
<div class="tool-panel" id="panel-palette" style="display:none;">
      <h1 class="page-title">üé® Color Palette Extractor</h1>
      <p class="page-subtitle">Extract color palettes from your designs for listings and marketing</p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Upload</div>
          <div class="upload-zone" id="paletteUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop image to analyze</div>
          </div>
          <input type="file" id="paletteInput" accept="image/*" class="hidden">

          <div class="settings-group" style="margin-top:16px;">
            <label>Number of Colors</label>
            <div class="size-buttons">
              <button class="btn btn-secondary" data-colors="3">3</button>
              <button class="btn btn-secondary active" data-colors="5">5</button>
              <button class="btn btn-secondary" data-colors="8">8</button>
              <button class="btn btn-secondary" data-colors="10">10</button>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Extracted Palette</div>
          <div id="palettePreview" style="margin-bottom:16px;">
            <div class="empty-state">
              <p>Upload an image to extract colors</p>
            </div>
          </div>
          <div id="paletteColors" style="display:none;">
            <div id="paletteSwatches" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;"></div>
            <div class="action-bar">
              <button class="btn btn-secondary" id="paletteCopyHex">üìã Copy HEX</button>
              <button class="btn btn-secondary" id="paletteCopyRGB">üìã Copy RGB</button>
            </div>
          </div>
        </div>
      </div>
    </div><!-- PHOTO COMPOSER -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: COLOR PALETTE GENERATOR
// ============================================
    // ============================================
    // COLOR PALETTE EXTRACTOR
    // ============================================
    let paletteColors = [];

    setupUploadZone('paletteUpload', 'paletteInput', async (files) => {
      if (!files[0]?.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(files[0]);
      const img = await loadImage(dataUrl);
      extractColors(img);
    });

    document.querySelectorAll('#panel-palette [data-colors]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-palette [data-colors]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      };
    });

    function extractColors(img) {
      const numColors = parseInt(document.querySelector('#panel-palette [data-colors].active')?.dataset.colors || 5);
      const { canvas, ctx } = Utils.createCanvas(100, 100);
      ctx.drawImage(img, 0, 0, 100, 100);
      const data = ctx.getImageData(0, 0, 100, 100).data;

      const colorCounts = {};
      for (let i = 0; i < data.length; i += 4) {
        const r = Math.round(data[i] / 32) * 32;
        const g = Math.round(data[i+1] / 32) * 32;
        const b = Math.round(data[i+2] / 32) * 32;
        const key = `${r},${g},${b}`;
        colorCounts[key] = (colorCounts[key] || 0) + 1;
      }

      paletteColors = Object.entries(colorCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, numColors)
        .map(([key]) => {
          const [r, g, b] = key.split(',').map(Number);
          return { r, g, b, hex: '#' + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join('') };
        });

      renderPalette();
    }

    function renderPalette() {
      const preview = document.getElementById('palettePreview');
      const swatches = document.getElementById('paletteSwatches');
      const colorsDiv = document.getElementById('paletteColors');

      if (paletteColors.length === 0) {
        preview.innerHTML = '<div class="empty-state"><p>Upload an image to extract colors</p></div>';
        colorsDiv.style.display = 'none';
        return;
      }

      preview.innerHTML = '';
      colorsDiv.style.display = 'block';
      swatches.innerHTML = paletteColors.map(c => `
        <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
          <div style="width:50px;height:50px;background:${c.hex};border-radius:8px;border:2px solid var(--border);cursor:pointer;" onclick="navigator.clipboard.writeText('${c.hex}');Utils.toast('Copied ${c.hex}');"></div>
          <span style="font-size:11px;font-family:monospace;">${c.hex}</span>
        </div>
      `).join('');

      state.stats.processed++;
      updateStats();
    }

    document.getElementById('paletteCopyHex').onclick = () => {
      navigator.clipboard.writeText(paletteColors.map(c => c.hex).join('\n'));
      Utils.toast('HEX colors copied!');
    };

    document.getElementById('paletteCopyRGB').onclick = () => {
      navigator.clipboard.writeText(paletteColors.map(c => `rgb(${c.r}, ${c.g}, ${c.b})`).join('\n'));
      Utils.toast('RGB colors copied!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Color Variants -->
<div class="tool-panel" id="panel-colorvariant" style="display:none;">
      <h1 class="page-title">üåà Color Variant Generator</h1>
      <p class="page-subtitle">Create color variations of your designs</p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Upload Design</div>
          <div class="upload-zone" id="colorvariantUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop your design</div>
            <div class="upload-hint">Works best with simple designs</div>
          </div>
          <input type="file" id="colorvariantInput" accept="image/*" class="hidden">

          <div class="settings-group" style="margin-top:16px;">
            <label>Hue Shift Variants</label>
            <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;">
              <label style="display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;">
                <input type="checkbox" data-hue="0" checked> Original
              </label>
              <label style="display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;">
                <input type="checkbox" data-hue="30"> +30¬∞
              </label>
              <label style="display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;">
                <input type="checkbox" data-hue="60"> +60¬∞
              </label>
              <label style="display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;">
                <input type="checkbox" data-hue="120"> +120¬∞
              </label>
              <label style="display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;">
                <input type="checkbox" data-hue="180"> +180¬∞
              </label>
              <label style="display:flex;flex-direction:column;align-items:center;gap:4px;font-size:11px;">
                <input type="checkbox" data-hue="240"> +240¬∞
              </label>
            </div>
          </div>

          <div class="settings-group">
            <label>Additional Variants</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;"><input type="checkbox" data-variant="grayscale"> Grayscale</label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;"><input type="checkbox" data-variant="sepia"> Sepia</label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;"><input type="checkbox" data-variant="invert"> Inverted</label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;"><input type="checkbox" data-variant="saturate"> Saturated</label>
            </div>
          </div>

          <div class="action-bar">
            <button class="btn btn-primary" id="colorvariantGenerate" disabled>üé® Generate Variants</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Variants</div>
          <div id="colorvariantResults" class="image-grid">
            <div class="empty-state"><p>Upload a design to generate variants</p></div>
          </div>
        </div>
      </div>

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: COLOR VARIANTS
// ============================================
    // ============================================
    // COLOR VARIANT GENERATOR
    // ============================================
    let colorvariantImage = null;

    setupUploadZone('colorvariantUpload', 'colorvariantInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      const img = await loadImage(dataUrl);
      colorvariantImage = { name: Utils.getBaseName(file.name), img, dataUrl };
      document.getElementById('colorvariantGenerate').disabled = false;
      document.getElementById('colorvariantResults').innerHTML = `<img src="${dataUrl}" style="max-width:100%;border-radius:8px;">`;
    });

    document.getElementById('colorvariantGenerate').onclick = async () => {
      if (!colorvariantImage) return;

      const results = document.getElementById('colorvariantResults');
      results.innerHTML = '<div style="text-align:center;padding:20px;">Generating variants...</div>';

      const variants = [];
      const img = colorvariantImage.img;

      // Hue shifts
      document.querySelectorAll('#panel-colorvariant [data-hue]:checked').forEach(cb => {
        const hue = parseInt(cb.dataset.hue);
        const { canvas, ctx } = Utils.createCanvas(img.width, img.height);
        ctx.filter = hue === 0 ? 'none' : `hue-rotate(${hue}deg)`;
        ctx.drawImage(img, 0, 0);
        variants.push({ canvas, label: hue === 0 ? 'Original' : `Hue +${hue}¬∞` });
      });

      // Additional variants
      const variantFilters = {
        grayscale: 'grayscale(100%)',
        sepia: 'sepia(100%)',
        invert: 'invert(100%)',
        saturate: 'saturate(200%)'
      };

      document.querySelectorAll('#panel-colorvariant [data-variant]:checked').forEach(cb => {
        const variant = cb.dataset.variant;
        const { canvas, ctx } = Utils.createCanvas(img.width, img.height);
        ctx.filter = variantFilters[variant];
        ctx.drawImage(img, 0, 0);
        variants.push({ canvas, label: variant.charAt(0).toUpperCase() + variant.slice(1) });
      });

      if (variants.length === 0) {
        results.innerHTML = '<div class="empty-state"><p>Select at least one variant type</p></div>';
        return;
      }

      results.innerHTML = '<div class="image-grid">' + variants.map((v, i) => `
        <div class="image-card">
          <div class="image-card-preview"><img src="${v.canvas.toDataURL()}" alt="${v.label}"></div>
          <div style="text-align:center;padding:8px;font-size:12px;">${v.label}</div>
        </div>
      `).join('') + '</div>';

      // Auto-download as ZIP
      const files = variants.map(v => ({
        canvas: v.canvas,
        name: `${colorvariantImage.name}_${v.label.toLowerCase().replace(/[^a-z0-9]/g, '_')}.png`
      }));
      await Utils.downloadZip(files, `${colorvariantImage.name}_variants`);
      Utils.toast(`Generated ${variants.length} variants!`);
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Photo Composer -->
<div class="tool-panel" id="panel-photocomposer" style="display:none;">
      <h1 class="page-title">üì∑ Listing Photo Composer</h1>
      <p class="page-subtitle">Create grid layouts for Etsy listing photos</p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Upload Images</div>
          <div class="upload-zone" id="composerUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop images here</div>
            <div class="upload-hint">Upload 2-9 images for grid</div>
          </div>
          <input type="file" id="composerInput" accept="image/*" multiple class="hidden">

          <div class="settings-group" style="margin-top:16px;">
            <label>Grid Layout</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-grid="2x1">2√ó1</button>
              <button class="btn btn-secondary" data-grid="2x2">2√ó2</button>
              <button class="btn btn-secondary" data-grid="3x2">3√ó2</button>
              <button class="btn btn-secondary" data-grid="3x3">3√ó3</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Gap Size: <span id="composerGapVal">10</span>px</label>
            <input type="range" id="composerGap" min="0" max="50" value="10">
          </div>

          <div class="settings-group">
            <label>Background Color</label>
            <input type="color" id="composerBg" value="#ffffff" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer;">
          </div>

          <div class="action-bar">
            <button class="btn btn-secondary" id="composerClear">üóëÔ∏è Clear</button>
            <button class="btn btn-primary" id="composerDownload" disabled>‚¨áÔ∏è Download</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Preview</div>
          <div id="composerPreview" class="preview-area">
            <div class="empty-state"><p>Upload images to preview grid</p></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SIZE GUIDE CREATOR --><!-- KEYWORD TOOL --><!-- SHOP BANNER MAKER -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: PHOTO COMPOSER
// ============================================
    // ============================================
    // PHOTO COMPOSER
    // ============================================
    let composerImages = [];
    let composerGrid = '2x2';

    setupUploadZone('composerUpload', 'composerInput', async (fileList) => {
      for (const file of Array.from(fileList)) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const img = await loadImage(dataUrl);
        composerImages.push({ name: Utils.getBaseName(file.name), img, dataUrl });
      }
      renderComposerPreview();
      document.getElementById('composerDownload').disabled = composerImages.length < 2;
    });

    document.querySelectorAll('#panel-photocomposer [data-grid]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-photocomposer [data-grid]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        composerGrid = btn.dataset.grid;
        renderComposerPreview();
      };
    });

    document.getElementById('composerGap').oninput = (e) => {
      document.getElementById('composerGapVal').textContent = e.target.value;
      renderComposerPreview();
    };

    document.getElementById('composerBg').oninput = () => renderComposerPreview();

    document.getElementById('composerClear').onclick = () => {
      composerImages = [];
      document.getElementById('composerDownload').disabled = true;
      document.getElementById('composerPreview').innerHTML = '<div class="empty-state"><p>Upload images to preview grid</p></div>';
    };

    function renderComposerPreview() {
      const preview = document.getElementById('composerPreview');
      if (composerImages.length < 2) {
        preview.innerHTML = '<div class="empty-state"><p>Upload at least 2 images</p></div>';
        return;
      }

      const [cols, rows] = composerGrid.split('x').map(Number);
      const gap = parseInt(document.getElementById('composerGap').value);
      const bg = document.getElementById('composerBg').value;

      const cellSize = 150;
      const width = cols * cellSize + (cols - 1) * gap;
      const height = rows * cellSize + (rows - 1) * gap;

      const { canvas, ctx } = Utils.createCanvas(width, height, bg);

      for (let i = 0; i < Math.min(composerImages.length, cols * rows); i++) {
        const col = i % cols;
        const row = Math.floor(i / cols);
        const x = col * (cellSize + gap);
        const y = row * (cellSize + gap);

        const img = composerImages[i].img;
        const scale = Math.max(cellSize / img.width, cellSize / img.height);
        const w = img.width * scale;
        const h = img.height * scale;

        ctx.save();
        ctx.beginPath();
        ctx.rect(x, y, cellSize, cellSize);
        ctx.clip();
        ctx.drawImage(img, x + (cellSize - w) / 2, y + (cellSize - h) / 2, w, h);
        ctx.restore();
      }

      preview.innerHTML = `<img src="${canvas.toDataURL()}" style="max-width:100%;border-radius:8px;">`;
    }

    document.getElementById('composerDownload').onclick = async () => {
      if (composerImages.length < 2) return;

      const [cols, rows] = composerGrid.split('x').map(Number);
      const gap = parseInt(document.getElementById('composerGap').value) * 4;
      const bg = document.getElementById('composerBg').value;

      const cellSize = 600;
      const width = cols * cellSize + (cols - 1) * gap;
      const height = rows * cellSize + (rows - 1) * gap;

      const { canvas, ctx } = Utils.createCanvas(width, height, bg);

      for (let i = 0; i < Math.min(composerImages.length, cols * rows); i++) {
        const col = i % cols;
        const row = Math.floor(i / cols);
        const x = col * (cellSize + gap);
        const y = row * (cellSize + gap);

        const img = composerImages[i].img;
        const scale = Math.max(cellSize / img.width, cellSize / img.height);
        const w = img.width * scale;
        const h = img.height * scale;

        ctx.save();
        ctx.beginPath();
        ctx.rect(x, y, cellSize, cellSize);
        ctx.clip();
        ctx.drawImage(img, x + (cellSize - w) / 2, y + (cellSize - h) / 2, w, h);
        ctx.restore();
      }

      const blob = await Utils.canvasToBlob(canvas, 'image/jpeg', 0.95);
      downloadBlob(blob, `listing_grid_${composerGrid}.jpg`);
      Utils.toast('Grid image downloaded!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Shop Banner -->
<div class="tool-panel" id="panel-banner" style="display:none;">
      <h1 class="page-title">üè™ Etsy Shop Banner Maker</h1>
      <p class="page-subtitle">Create professional banners for your Etsy shop ‚Ä¢ Big banner (1200√ó300) & Mini (1200√ó160)</p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Banner Settings</div>

          <div class="settings-group">
            <label>Banner Size</label>
            <div class="size-buttons">
              <button class="btn btn-secondary active" data-bannersize="big">Big (1200√ó300)</button>
              <button class="btn btn-secondary" data-bannersize="mini">Mini (1200√ó160)</button>
              <button class="btn btn-secondary" data-bannersize="mobile">Mobile (1200√ó180)</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Background</label>
            <div class="size-buttons" style="margin-bottom:8px;">
              <button class="btn btn-secondary active" data-bannerbg="color">Solid Color</button>
              <button class="btn btn-secondary" data-bannerbg="gradient">Gradient</button>
              <button class="btn btn-secondary" data-bannerbg="image">Image</button>
            </div>
            <div id="bannerBgColor">
              <input type="color" id="bannerColor1" value="#f5f5f4" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer;">
            </div>
            <div id="bannerBgGradient" style="display:none;">
              <div style="display:flex;gap:8px;margin-bottom:8px;">
                <input type="color" id="bannerGrad1" value="#fef3c7" style="flex:1;height:40px;border:none;border-radius:8px;cursor:pointer;">
                <input type="color" id="bannerGrad2" value="#fecaca" style="flex:1;height:40px;border:none;border-radius:8px;cursor:pointer;">
              </div>
              <select id="bannerGradDir" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;color:var(--text);">
                <option value="to right">Left ‚Üí Right</option>
                <option value="to left">Right ‚Üí Left</option>
                <option value="to bottom">Top ‚Üí Bottom</option>
                <option value="to bottom right">Diagonal ‚Üò</option>
              </select>
            </div>
            <div id="bannerBgImage" style="display:none;">
              <div class="upload-zone" id="bannerBgUpload" style="padding:16px;">
                <div class="upload-text" style="font-size:13px;">Drop background image</div>
              </div>
              <input type="file" id="bannerBgInput" accept="image/*" class="hidden">
            </div>
          </div>

          <div class="settings-group">
            <label>Shop Name</label>
            <input type="text" id="bannerShopName" placeholder="Your Shop Name">
          </div>

          <div class="settings-group">
            <label>Tagline (optional)</label>
            <input type="text" id="bannerTagline" placeholder="Handmade with love">
          </div>

          <div class="settings-group">
            <label>Text Style</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label style="font-size:11px;color:var(--text-muted);">Font</label>
                <select id="bannerFont" style="width:100%;padding:8px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
                  <option value="Georgia, serif">Georgia (Classic)</option>
                  <option value="'DM Sans', sans-serif">DM Sans (Modern)</option>
                  <option value="'Playfair Display', serif">Playfair (Elegant)</option>
                  <option value="'Courier New', monospace">Courier (Typewriter)</option>
                  <option value="Impact, sans-serif">Impact (Bold)</option>
                  <option value="'Brush Script MT', cursive">Script (Handwritten)</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px;color:var(--text-muted);">Text Color</label>
                <input type="color" id="bannerTextColor" value="#1f1f1f" style="width:100%;height:36px;border:none;border-radius:8px;cursor:pointer;">
              </div>
            </div>
          </div>

          <div class="settings-group">
            <label>Text Position</label>
            <div class="size-buttons">
              <button class="btn btn-secondary" data-textpos="left">Left</button>
              <button class="btn btn-secondary active" data-textpos="center">Center</button>
              <button class="btn btn-secondary" data-textpos="right">Right</button>
            </div>
          </div>

          <div class="settings-group">
            <label>Add Logo/Icon (optional)</label>
            <div class="upload-zone" id="bannerLogoUpload" style="padding:16px;">
              <div class="upload-text" style="font-size:13px;">Drop logo image</div>
            </div>
            <input type="file" id="bannerLogoInput" accept="image/*" class="hidden">
            <div id="bannerLogoPreview" style="display:none;margin-top:8px;text-align:center;">
              <img id="bannerLogoImg" style="max-height:50px;border-radius:4px;">
              <button class="btn btn-secondary btn-sm" onclick="clearBannerLogo()" style="margin-left:8px;">‚úï Remove</button>
            </div>
          </div>

          <div class="action-bar">
            <button class="btn btn-secondary" id="bannerPreviewBtn">üëÅÔ∏è Preview</button>
            <button class="btn btn-primary" id="bannerDownload">‚¨áÔ∏è Download</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">Preview</div>
          <div id="bannerPreview" style="background:var(--surface-2);border-radius:8px;padding:16px;min-height:200px;display:flex;align-items:center;justify-content:center;">
            <div class="empty-state">
              <p>Configure your banner and click Preview</p>
            </div>
          </div>

          <div style="margin-top:16px;padding:12px;background:var(--surface-2);border-radius:8px;">
            <div style="font-size:12px;font-weight:600;margin-bottom:8px;">üìê Etsy Banner Sizes:</div>
            <div style="font-size:11px;color:var(--text-muted);line-height:1.6;">
              ‚Ä¢ <strong>Big Banner:</strong> 1200√ó300px (desktop header)<br>
              ‚Ä¢ <strong>Mini Banner:</strong> 1200√ó160px (condensed view)<br>
              ‚Ä¢ <strong>Mobile:</strong> 1200√ó180px (mobile app)<br>
              <span style="color:var(--accent-orange);">Tip: Create all 3 sizes for best appearance!</span>
            </div>
          </div>

          <div style="margin-top:12px;padding:12px;background:var(--surface-2);border-radius:8px;">
            <div style="font-size:12px;font-weight:600;margin-bottom:8px;">üé® Quick Presets</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;">
              <button class="btn btn-secondary btn-sm" onclick="applyBannerPreset('minimal')">Minimal</button>
              <button class="btn btn-secondary btn-sm" onclick="applyBannerPreset('warm')">Warm & Cozy</button>
              <button class="btn btn-secondary btn-sm" onclick="applyBannerPreset('elegant')">Elegant</button>
              <button class="btn btn-secondary btn-sm" onclick="applyBannerPreset('bold')">Bold</button>
              <button class="btn btn-secondary btn-sm" onclick="applyBannerPreset('nature')">Nature</button>
              <button class="btn btn-secondary btn-sm" onclick="applyBannerPreset('pastel')">Pastel</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BUNDLE CREATOR -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: SHOP BANNER BUILDER
// ============================================
    // ============================================
    // SHOP BANNER MAKER
    // ============================================
    let bannerSize = 'big';
    let bannerBgType = 'color';
    let bannerTextPos = 'center';
    let bannerBgImg = null;
    let bannerLogoImg = null;

    const bannerSizes = {
      big: { width: 1200, height: 300 },
      mini: { width: 1200, height: 160 },
      mobile: { width: 1200, height: 180 }
    };

    // Banner size buttons
    document.querySelectorAll('#panel-banner [data-bannersize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-banner [data-bannersize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bannerSize = btn.dataset.bannersize;
        renderBannerPreview();
      };
    });

    // Background type buttons
    document.querySelectorAll('#panel-banner [data-bannerbg]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-banner [data-bannerbg]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bannerBgType = btn.dataset.bannerbg;
        document.getElementById('bannerBgColor').style.display = bannerBgType === 'color' ? 'block' : 'none';
        document.getElementById('bannerBgGradient').style.display = bannerBgType === 'gradient' ? 'block' : 'none';
        document.getElementById('bannerBgImage').style.display = bannerBgType === 'image' ? 'block' : 'none';
        renderBannerPreview();
      };
    });

    // Text position buttons
    document.querySelectorAll('#panel-banner [data-textpos]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-banner [data-textpos]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bannerTextPos = btn.dataset.textpos;
        renderBannerPreview();
      };
    });

    // Background image upload
    setupUploadZone('bannerBgUpload', 'bannerBgInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      bannerBgImg = await loadImage(dataUrl);
      renderBannerPreview();
    });

    // Logo upload
    setupUploadZone('bannerLogoUpload', 'bannerLogoInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      bannerLogoImg = await loadImage(dataUrl);
      document.getElementById('bannerLogoPreview').style.display = 'block';
      document.getElementById('bannerLogoImg').src = dataUrl;
      renderBannerPreview();
    });

    window.clearBannerLogo = () => {
      bannerLogoImg = null;
      document.getElementById('bannerLogoPreview').style.display = 'none';
      renderBannerPreview();
    };

    // Live preview on input changes
    ['bannerShopName', 'bannerTagline', 'bannerFont', 'bannerTextColor', 'bannerColor1', 'bannerGrad1', 'bannerGrad2', 'bannerGradDir'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', renderBannerPreview);
    });

    document.getElementById('bannerPreviewBtn').onclick = renderBannerPreview;

    function renderBannerPreview() {
      const { width, height } = bannerSizes[bannerSize];
      const { canvas, ctx } = Utils.createCanvas(width, height);

      // Draw background
      if (bannerBgType === 'color') {
        ctx.fillStyle = document.getElementById('bannerColor1').value;
        ctx.fillRect(0, 0, width, height);
      } else if (bannerBgType === 'gradient') {
        const dir = document.getElementById('bannerGradDir').value;
        let grad;
        if (dir === 'to right') grad = ctx.createLinearGradient(0, 0, width, 0);
        else if (dir === 'to left') grad = ctx.createLinearGradient(width, 0, 0, 0);
        else if (dir === 'to bottom') grad = ctx.createLinearGradient(0, 0, 0, height);
        else grad = ctx.createLinearGradient(0, 0, width, height);
        grad.addColorStop(0, document.getElementById('bannerGrad1').value);
        grad.addColorStop(1, document.getElementById('bannerGrad2').value);
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, width, height);
      } else if (bannerBgType === 'image' && bannerBgImg) {
        const scale = Math.max(width / bannerBgImg.width, height / bannerBgImg.height);
        const w = bannerBgImg.width * scale;
        const h = bannerBgImg.height * scale;
        ctx.drawImage(bannerBgImg, (width - w) / 2, (height - h) / 2, w, h);
      } else {
        ctx.fillStyle = '#f5f5f4';
        ctx.fillRect(0, 0, width, height);
      }

      // Get text settings
      const shopName = document.getElementById('bannerShopName').value || 'Your Shop Name';
      const tagline = document.getElementById('bannerTagline').value;
      const font = document.getElementById('bannerFont').value;
      const textColor = document.getElementById('bannerTextColor').value;

      // Calculate text position
      let textX = width / 2;
      let textAlign = 'center';
      if (bannerTextPos === 'left') {
        textX = bannerLogoImg ? 200 : 60;
        textAlign = 'left';
      } else if (bannerTextPos === 'right') {
        textX = width - 60;
        textAlign = 'right';
      }

      // Draw logo if present
      if (bannerLogoImg) {
        const logoMaxH = height * 0.6;
        const logoScale = Math.min(logoMaxH / bannerLogoImg.height, 150 / bannerLogoImg.width);
        const logoW = bannerLogoImg.width * logoScale;
        const logoH = bannerLogoImg.height * logoScale;

        let logoX = 40;
        if (bannerTextPos === 'center') logoX = (width - logoW) / 2 - 200;
        else if (bannerTextPos === 'right') logoX = width - logoW - 250;

        ctx.drawImage(bannerLogoImg, logoX, (height - logoH) / 2, logoW, logoH);

        // Adjust text position if logo present and centered
        if (bannerTextPos === 'center') {
          textX = width / 2 + 60;
        }
      }

      // Draw shop name
      ctx.fillStyle = textColor;
      ctx.textAlign = textAlign;
      ctx.textBaseline = 'middle';

      const mainFontSize = bannerSize === 'big' ? 56 : bannerSize === 'mini' ? 36 : 40;
      ctx.font = `bold ${mainFontSize}px ${font}`;

      const textY = tagline ? height / 2 - 20 : height / 2;
      ctx.fillText(shopName, textX, textY);

      // Draw tagline
      if (tagline) {
        const taglineFontSize = bannerSize === 'big' ? 24 : 18;
        ctx.font = `${taglineFontSize}px ${font}`;
        ctx.globalAlpha = 0.7;
        ctx.fillText(tagline, textX, textY + mainFontSize * 0.7);
        ctx.globalAlpha = 1;
      }

      // Display preview
      const preview = document.getElementById('bannerPreview');
      preview.innerHTML = `<img src="${canvas.toDataURL()}" style="max-width:100%;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">`;

      // Store canvas for download
      preview.dataset.canvasData = canvas.toDataURL('image/png');
    }

    // Download banner
    document.getElementById('bannerDownload').onclick = async () => {
      renderBannerPreview();

      const preview = document.getElementById('bannerPreview');
      const dataUrl = preview.dataset.canvasData;

      if (!dataUrl) {
        Utils.toast('Generate a preview first', 'error');
        return;
      }

      const { width, height } = bannerSizes[bannerSize];
      const shopName = document.getElementById('bannerShopName').value || 'shop';
      const filename = `${shopName.replace(/\s+/g, '_')}_banner_${width}x${height}.png`;

      // Create download link directly from data URL
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      Utils.toast(`Downloaded: ${filename}`);
    };

    // Preset styles
    window.applyBannerPreset = (preset) => {
      const presets = {
        minimal: { bg: 'color', color1: '#ffffff', textColor: '#1f1f1f', font: "'DM Sans', sans-serif" },
        warm: { bg: 'gradient', grad1: '#fef3c7', grad2: '#fed7aa', textColor: '#78350f', font: 'Georgia, serif' },
        elegant: { bg: 'color', color1: '#1f1f1f', textColor: '#fafafa', font: "'Playfair Display', serif" },
        bold: { bg: 'color', color1: '#dc2626', textColor: '#ffffff', font: 'Impact, sans-serif' },
        nature: { bg: 'gradient', grad1: '#d1fae5', grad2: '#a7f3d0', textColor: '#064e3b', font: 'Georgia, serif' },
        pastel: { bg: 'gradient', grad1: '#fce7f3', grad2: '#ddd6fe', textColor: '#581c87', font: "'Brush Script MT', cursive" }
      };

      const p = presets[preset];
      if (!p) return;

      // Set background type
      document.querySelectorAll('#panel-banner [data-bannerbg]').forEach(b => b.classList.remove('active'));
      document.querySelector(`#panel-banner [data-bannerbg="${p.bg}"]`).classList.add('active');
      bannerBgType = p.bg;
      document.getElementById('bannerBgColor').style.display = p.bg === 'color' ? 'block' : 'none';
      document.getElementById('bannerBgGradient').style.display = p.bg === 'gradient' ? 'block' : 'none';
      document.getElementById('bannerBgImage').style.display = p.bg === 'image' ? 'block' : 'none';

      // Set colors
      if (p.color1) document.getElementById('bannerColor1').value = p.color1;
      if (p.grad1) document.getElementById('bannerGrad1').value = p.grad1;
      if (p.grad2) document.getElementById('bannerGrad2').value = p.grad2;
      document.getElementById('bannerTextColor').value = p.textColor;
      document.getElementById('bannerFont').value = p.font;

      renderBannerPreview();
      Utils.toast(`Applied "${preset}" preset`);
    };

    // Initial render
    renderBannerPreview();


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Simple Frames -->
<div class="tool-panel" id="panel-frames" style="display:none;">
      <h1 class="page-title">üñºÔ∏è Simple Frames</h1>
      <p class="page-subtitle">Add decorative frames to your artwork for listings</p>
      <div class="grid-2">
        <div class="panel">
          <div class="panel-title">Settings</div>
          <div class="upload-zone" id="framesUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop artwork image</div>
          </div>
          <input type="file" id="framesInput" accept="image/*" class="hidden">
          <div class="settings-group" style="margin-top:16px;">
            <label>Frame Style</label>
            <div class="size-buttons" id="frameStyles">
              <button class="btn btn-secondary active" data-frame="thin-black">Thin Black</button>
              <button class="btn btn-secondary" data-frame="thick-white">Thick White</button>
              <button class="btn btn-secondary" data-frame="wood">Wood</button>
              <button class="btn btn-secondary" data-frame="gold">Gold</button>
              <button class="btn btn-secondary" data-frame="shadow">Shadow</button>
            </div>
          </div>
          <div class="settings-group">
            <label>Mat Width: <span id="matWidthVal">10%</span></label>
            <input type="range" id="matWidth" min="0" max="25" value="10" style="width:100%;">
          </div>
          <button class="btn btn-primary" id="framesDownload" disabled style="width:100%;margin-top:12px;">‚¨áÔ∏è Download</button>
        </div>
        <div class="panel">
          <div class="panel-title">Preview</div>
          <div id="framesPreview" style="display:flex;justify-content:center;align-items:center;min-height:300px;background:var(--surface-1);border-radius:8px;">
            <canvas id="framesCanvas" style="max-width:100%;max-height:400px;display:none;"></canvas>
            <span style="color:var(--text-dim);" id="framesEmpty">Upload an image</span>
          </div>
        </div>
      </div>
    </div>

    <!-- IMAGE CONVERTER --><!-- ASPECT RATIO CALCULATOR --><!-- COLOR VARIANT GENERATOR -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: SIMPLE FRAMES
// ============================================
    // ============================================
    // SIMPLE FRAMES
    // ============================================
    let framesImage = null;
    setupUploadZone('framesUpload', 'framesInput', async files => {
      const file = files[0];
      if (!file?.type.startsWith('image/')) return;
      framesImage = { img: await loadImage(await readFileAsDataURL(file)), name: Utils.getBaseName(file.name) };
      document.getElementById('framesEmpty').style.display = 'none';
      document.getElementById('framesCanvas').style.display = 'block';
      document.getElementById('framesDownload').disabled = false;
      renderFrame();
    });
    document.querySelectorAll('#frameStyles button').forEach(btn => {
      btn.onclick = () => { document.querySelectorAll('#frameStyles button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderFrame(); };
    });
    document.getElementById('matWidth').oninput = e => { document.getElementById('matWidthVal').textContent = e.target.value + '%'; renderFrame(); };
    function renderFrame() {
      if (!framesImage) return;
      const style = document.querySelector('#frameStyles .active').dataset.frame;
      const matPct = parseInt(document.getElementById('matWidth').value) / 100;
      const img = framesImage.img;
      const pad = Math.round(Math.max(img.width, img.height) * matPct);
      const frameW = style === 'thick-white' ? 20 : 8;
      const canvas = document.getElementById('framesCanvas');
      canvas.width = img.width + pad * 2 + frameW * 2;
      canvas.height = img.height + pad * 2 + frameW * 2;
      const ctx = canvas.getContext('2d');
      // Frame
      const colors = { 'thin-black': '#222', 'thick-white': '#fff', 'wood': '#8B4513', 'gold': '#D4AF37', 'shadow': '#333' };
      ctx.fillStyle = colors[style] || '#222';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      // Mat (white)
      ctx.fillStyle = '#fff';
      ctx.fillRect(frameW, frameW, canvas.width - frameW * 2, canvas.height - frameW * 2);
      // Image
      ctx.drawImage(img, frameW + pad, frameW + pad);
      // Shadow effect
      if (style === 'shadow') { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width - 10, canvas.height - 10); ctx.drawImage(img, pad, pad); }
    }
    document.getElementById('framesDownload').onclick = async () => {
      if (!framesImage) return;
      const blob = await Utils.canvasToBlob(document.getElementById('framesCanvas'));
      downloadBlob(blob, framesImage.name + '-framed.png');
      Utils.toast('Framed image downloaded!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

    <!-- Bundle Creator -->
<div class="tool-panel" id="panel-bundle" style="display:none;">
      <h1 class="page-title">üì¶ Bundle Creator</h1>
      <p class="page-subtitle">Combine files into organized ZIP bundles for digital delivery</p>
      <div class="grid-2">
        <div class="panel">
          <div class="panel-title">Add Files</div>
          <div class="upload-zone" id="bundleUpload">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <div class="upload-text">Drop any files here</div>
            <div class="upload-hint">Images, PDFs, documents - anything</div>
          </div>
          <input type="file" id="bundleInput" multiple class="hidden">
          <div class="settings-group" style="margin-top:16px;">
            <label>Bundle Name</label>
            <input type="text" id="bundleName" value="digital-download" placeholder="my-bundle">
          </div>
          <div class="action-bar">
            <button class="btn btn-secondary" id="bundleClear">Clear All</button>
            <button class="btn btn-primary" id="bundleDownload" disabled>üì¶ Create ZIP</button>
          </div>
        </div>
        <div class="panel">
          <div class="panel-title">Files (<span id="bundleCount">0</span>)</div>
          <div id="bundleList" style="min-height:200px;max-height:400px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>

    <!-- SIMPLE FRAMES -->

<!-- Lightbox overlay -->
<div id="lightbox" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;cursor:pointer;">
  <img id="lightboxImg" style="max-width:95vw;max-height:95vh;object-fit:contain;">
  <div id="lightboxInfo" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#aaa;font-size:13px;"></div>
  <button class="lightbox-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚óÄ</button>
  <button class="lightbox-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:24px;padding:12px;border-radius:50%;cursor:pointer;">‚ñ∂</button>
</div>

<script>
// Wrap everything in DOMContentLoaded to ensure HTML is ready
document.addEventListener('DOMContentLoaded', function() {


// ============================================
// STANDALONE TOOL - SHARED UTILITIES
// ============================================

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
    const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };
      },

      // Convert canvas to blob with size optimization
      async canvasToBlob(canvas, type = 'image/png', quality = 1) {
        return new Promise(resolve => {
          canvas.toBlob(blob => {
            // If PNG is too large, try reducing or switch to JPEG
            if (blob.size > this.config.MAX_SIZE_MB * 1024 * 1024 && type === 'image/png') {
              canvas.toBlob(resolve, 'image/jpeg', 0.92);
            } else {
              resolve(blob);
            }
          }, type, quality);
        });
      },

      // Download blob as file
      downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      },

      // Download multiple files as ZIP
      async downloadZip(files, zipName) {
        const zip = new JSZip();
        for (const file of files) {
          if (file.blob) {
            zip.file(file.name, file.blob);
          } else if (file.canvas) {
            const blob = await this.canvasToBlob(file.canvas, file.type || 'image/png', file.quality || 1);
            zip.file(file.name, blob);
          } else if (file.data) {
            zip.file(file.name, file.data);
          }
        }
        const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
        this.downloadBlob(blob, zipName.endsWith('.zip') ? zipName : zipName + '.zip');
      },

      // Show toast notification
      toast(message, type = 'success', duration = 3000) {
        // Remove existing toast
        const existing = document.querySelector('.utils-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'utils-toast';
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
        toast.style.cssText = `
          position:fixed;bottom:20px;right:20px;padding:12px 20px;
          background:var(--surface);border:1px solid ${type === 'error' ? 'var(--accent-orange)' : 'var(--accent-green)'};
          border-radius:8px;font-size:14px;z-index:9999;
          animation:toastIn 0.3s ease;box-shadow:0 10px 40px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastOut 0.3s ease forwards';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Debounce function for performance
      debounce(fn, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
        };
      }
    };

    // Add toast animations
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    `;
    document.head.appendChild(toastStyle);


// ============================================
// LIGHTBOX (with null guards)
// ============================================
    // ============================================
    // LIGHTBOX SYSTEM
    // ============================================
    let lightboxImages = [];
    let lightboxIndex = 0;

    function openLightbox(images, index = 0, info = '') {
      lightboxImages = Array.isArray(images) ? images : [images];
      lightboxIndex = index;

      const lightbox = document.getElementById('lightbox');
      const img = document.getElementById('lightboxImg');
      const infoEl = document.getElementById('lightboxInfo');

      img.src = lightboxImages[lightboxIndex];
      infoEl.textContent = info || `${lightboxIndex + 1} of ${lightboxImages.length}`;

      // Show/hide nav buttons
      document.querySelector('.lightbox-prev').style.display = lightboxImages.length > 1 ? 'flex' : 'none';
      document.querySelector('.lightbox-next').style.display = lightboxImages.length > 1 ? 'flex' : 'none';

      lightbox.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('open');
      document.body.style.overflow = '';
    }

    function lightboxNav(dir) {
      lightboxIndex = (lightboxIndex + dir + lightboxImages.length) % lightboxImages.length;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
      document.getElementById('lightboxInfo').textContent = `${lightboxIndex + 1} of ${lightboxImages.length}`;
    }

    // Close on backdrop click
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    // Close on Escape, navigate with arrows
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('lightbox').classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxNav(-1);
      if (e.key === 'ArrowRight') lightboxNav(1);
    });


// ============================================
// STATE & PRESETS
// ============================================
    // ============================================
    // GLOBAL STATE & UTILITIES
    // ============================================
    const state = {
      clipboard: null, // Stored dimensions string
      stats: {
        processed: 0,
        downloaded: 0      },
      upscaler: { files: [] },
      coloring: { files: [], selected: new Set() },      presets: JSON.parse(localStorage.getItem('etsy-toolkit-presets') || '{}')
    };

    // Presets system
    function savePreset(tool, name) {
      if (!state.presets[tool]) state.presets[tool] = {};
      const settings = getToolSettings(tool);
      state.presets[tool][name] = settings;
      localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
      Utils.toast('Preset saved: ' + name);
      renderPresetButtons(tool);
    }

    function loadPreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        applyToolSettings(tool, state.presets[tool][name]);
        Utils.toast('Loaded: ' + name);
      }
    }

    function deletePreset(tool, name) {
      if (state.presets[tool]?.[name]) {
        delete state.presets[tool][name];
        localStorage.setItem('etsy-toolkit-presets', JSON.stringify(state.presets));
        Utils.toast('Deleted: ' + name);
        renderPresetButtons(tool);
      }
    }


    function getToolSettings(tool) {
      switch(tool) {
        case 'cropper':
          return { ratio: document.querySelector('#panel-cropper [data-ratio].active')?.dataset.ratio };
        default:
          return {};
      }
    }

    function applyToolSettings(tool, settings) {
      switch(tool) {
        case 'cropper':
          if (settings.ratio) {
            document.querySelectorAll('#panel-cropper [data-ratio]').forEach(b => b.classList.remove('active'));
            document.querySelector(`#panel-cropper [data-ratio="${settings.ratio}"]`)?.classList.add('active');
            cropperRatio = settings.ratio;
            renderCropperPreview();
          }
          break;
      }
    }

    function renderPresetButtons(tool) {
      const container = document.getElementById(tool + 'Presets');
      if (!container) return;
      const presets = state.presets[tool] || {};
      const names = Object.keys(presets);
      if (names.length === 0) {
        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No saved presets</span>';
        return;
      }
      container.innerHTML = names.map(name => `
        <button class="btn btn-secondary btn-sm" onclick="loadPreset('${tool}','${name}')" style="position:relative;">
          ${name}
          <span onclick="event.stopPropagation();deletePreset('${tool}','${name}')" style="margin-left:6px;color:var(--text-muted);">√ó</span>

// ============================================  
// SAFE NAV STUBS (prevent crashes in standalone mode)
// ============================================
// Navigation dropdown - only init if elements exist
(function() {
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    if (!navDropdownBtn) return; // standalone mode, skip nav setup
    
    const navDropdown = document.querySelector('.nav-dropdown');
    const navDropdownMenu = document.getElementById('navDropdownMenu');
    navDropdownBtn.addEventListener('click', () => {
      navDropdown.classList.toggle('open');
      navDropdownMenu.classList.toggle('hidden');
    });
})();

// Clipboard stub
function updateClipboard(dims) {
    // No-op in standalone mode
}

function updateStats() {
    // No-op in standalone mode
}

// ============================================
// FILE HELPERS
// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: BUNDLE CREATOR
// ============================================
    // ============================================
    // BUNDLE CREATOR
    // ============================================
    let bundleFiles = [];
    setupUploadZone('bundleUpload', 'bundleInput', files => {
      bundleFiles.push(...Array.from(files));
      renderBundleList();
    });
    function renderBundleList() {
      const list = document.getElementById('bundleList');
      document.getElementById('bundleCount').textContent = bundleFiles.length;
      document.getElementById('bundleDownload').disabled = bundleFiles.length === 0;
      if (!bundleFiles.length) { list.innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center;">No files added</div>'; return; }
      list.innerHTML = bundleFiles.map((f, i) => `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid var(--border);"><span style="font-size:13px;">${f.name}</span><button class="btn btn-secondary btn-sm" onclick="bundleFiles.splice(${i},1);renderBundleList();">√ó</button></div>`).join('');
    }
    document.getElementById('bundleClear').onclick = () => { bundleFiles = []; renderBundleList(); };
    document.getElementById('bundleDownload').onclick = async () => {
      const zip = new JSZip();
      for (const f of bundleFiles) zip.file(f.name, f);
      const blob = await zip.generateAsync({ type: 'blob' });
      downloadBlob(blob, (document.getElementById('bundleName').value || 'bundle') + '.zip');
      Utils.toast('Bundle created!');
    };
    renderBundleList();


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

} catch(e) { /* theme settings - optional */ }

}); // end DOMContentLoaded
</script>
    </div>

  </div>

  <!-- Lightbox Modal -->
  <div class="lightbox-overlay" id="lightbox" style="display:none;">
    <div class="lightbox-container">
      <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
      <img class="lightbox-img" id="lightboxImg" src="" alt="Preview">
      <div class="lightbox-info" id="lightboxInfo"></div>
    </div>
    <button class="lightbox-prev" onclick="lightboxNav(-1)">‚óÄ</button>
    <button class="lightbox-next" onclick="lightboxNav(1)">‚ñ∂</button>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Settings</div>
        <button class="modal-close" onclick="document.getElementById('settingsModal').style.display='none'">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h3>Favorites</h3>
          <div id="favoriteTools"></div>
        </div>
        <div class="settings-section">
          <h3>Recent Files</h3>
          <div id="recentFilesList"></div>
          <button class="btn btn-secondary btn-sm" onclick="clearRecentFiles()">Clear History</button>
        </div>
        <div class="settings-section">
          <h3>Export/Import</h3>
          <button class="btn btn-secondary" onclick="exportPresets()">Export Settings</button>
          <label class="btn btn-secondary" style="margin-left:10px;">
            Import Settings
            <input type="file" id="importPresets" accept=".json" style="display:none;">
          </label>
        </div>
      </div>
    </div>
  </div>

  <script>
  // Wrap everything in DOMContentLoaded
  document.addEventListener('DOMContentLoaded', function() {

    // ============================================
    // UNIFIED TOOLKIT UTILITIES
    // ============================================
const Utils = {
      // Configuration
      config: {
        DPI: 300,
        JPEG_QUALITY: 0.92,
        PNG_QUALITY: 1,
        MAX_SIZE_MB: 20 // Etsy limit
      },

      // Format filename using pattern - STANDARD ACROSS ALL TOOLS
      formatFilename(pattern, vars) {
        let result = pattern;
        for (const [key, value] of Object.entries(vars)) {
          result = result.replace(new RegExp(`\\{${key}\\}`, 'gi'), value);
        }
        return result.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_').trim();
      },

      // Get base name without extension
      getBaseName(filename) {
        return filename.replace(/\.[^/.]+$/, '');
      },

      // Get file extension
      getExtension(filename) {
        const match = filename.match(/\.([^/.]+)$/);
        return match ? match[1].toLowerCase() : '';
      },

      // Format dimensions string consistently
      formatDimensions(width, height, unit = 'px') {
        return `${width}√ó${height}${unit}`;
      },

      // Parse dimensions from string
      parseDimensions(str) {
        const match = str.match(/(\d+)\s*[√óx]\s*(\d+)/i);
        return match ? { width: parseInt(match[1]), height: parseInt(match[2]) } : null;
      },

      // Calculate print size at 300 DPI
      pxToInches(px) {
        return (px / this.config.DPI).toFixed(1);
      },

      inchesToPx(inches) {
        return Math.round(inches * this.config.DPI);
      },

      // Create canvas with options
      createCanvas(width, height, bgOrOptions = null) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // Handle background - can be string color or options object
        let bg = null;
        if (typeof bgOrOptions === 'string') {
          bg = bgOrOptions;
        } else if (bgOrOptions && bgOrOptions.background) {
          bg = bgOrOptions.background;
        }

        if (bg) {
          ctx.fillStyle = bg;
          ctx.fillRect(0, 0, width, height);
        }

        return { canvas, ctx };

function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }





    // ============================================
    // NAVIGATION & STATE MANAGEMENT
    // ============================================
    
    const toolMap = {
      'upscaler': { name: 'PNG Upscaler', icon: 'üñºÔ∏è' },
      'wallart': { name: 'Wall Art Resizer', icon: 'üé®' },
      'coloring': { name: 'Coloring Book', icon: 'üé®' },
      'greeting': { name: 'Greeting Cards', icon: 'üíå' },
      'kids': { name: 'Kids Cards', icon: 'üéà' },
      'invitations': { name: 'Invitations', icon: '‚úâÔ∏è' },
      'journal': { name: 'Journal Builder', icon: 'üìì' },
      'sticker': { name: 'Sticker Sheet', icon: 'üè∑Ô∏è' },
      'palette': { name: 'Color Palette', icon: 'üé®' },
      'variants': { name: 'Color Variants', icon: 'üåà' },
      'composer': { name: 'Photo Composer', icon: 'üì∑' },
      'banner': { name: 'Shop Banner', icon: 'üè™' },
      'frames': { name: 'Simple Frames', icon: 'üñºÔ∏è' },
      'bundle': { name: 'Bundle Creator', icon: 'üì¶' },
    };

    let currentTool = 'upscaler';
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function switchTab(toolId, icon, name) {
      // Hide all panels
      document.querySelectorAll('.tool-panel').forEach(panel => {
        panel.style.display = 'none';
        panel.classList.remove('active');
      });
      
      // Show selected panel
      const panel = document.getElementById('panel-' + toolId);
      if (panel) {
        panel.style.display = 'block';
        panel.classList.add('active');
      }
      
      // Update header
      document.getElementById('currentToolIcon').textContent = icon;
      document.getElementById('currentToolName').textContent = name;
      currentTool = toolId;
      
      // Close dropdown
      document.querySelector('.nav-dropdown').classList.remove('open');
      document.getElementById('navDropdownMenu').classList.add('hidden');
    }

    // Navigation dropdown toggle
    document.getElementById('navDropdownBtn').addEventListener('click', () => {
      document.querySelector('.nav-dropdown').classList.toggle('open');
      document.getElementById('navDropdownMenu').classList.toggle('hidden');
    });

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', () => {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('etsy-toolkit-theme', newTheme);
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme');
    if (savedTheme) {
      document.documentElement.setAttribute('data-theme', savedTheme);
    }

    // Favorites management
    function toggleFavorite(tool) {
      const index = favorites.indexOf(tool);
      if (index > -1) {
        favorites.splice(index, 1);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast && Utils.toast('Recent files cleared');
    }

    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast && Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        location.reload();
      } catch (err) {
        Utils.toast && Utils.toast('Invalid settings file', 'error');
      }
    };

    // Initialize
    renderFavorites();
    renderRecentFiles();


    // ============================================
    // TOOL: PNG UPSCALER
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: PNG UPSCALER
// ============================================
    // ============================================
    // PNG UPSCALER
    // ============================================
    setupUploadZone('upscalerUpload', 'upscalerInput', handleUpscalerFiles);

    // All preset buttons in upscaler panel - attach after page load
    function initUpscalerPresets() {
      var btns = document.querySelectorAll('#panel-upscaler .preset-btn');
      for (var i = 0; i < btns.length; i++) {
        (function(btn) {
          if (btn.getAttribute('data-mode')) {
            btn.style.cursor = 'pointer';
            btn.onclick = function() {
              if (this.classList.contains('active')) {
                this.classList.remove('active');
              } else {
                this.classList.add('active');
              }
            };
          }
        })(btns[i]);
      }
    }
    initUpscalerPresets();

    document.getElementById('upscalerCopyDims').addEventListener('click', () => {
      if (state.upscaler.files.length) {
        const dims = state.upscaler.files.map(f => f.dimString).filter(d => d).join('\n');
        if (!dims) {
          Utils.toast('Process images first to get dimensions', 'error');
          return;
        }
        // Try clipboard API, fallback to execCommand
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(dims).then(() => {
            updateClipboard(dims);
            const btn = document.getElementById('upscalerCopyDims');
            btn.textContent = '‚úì Copied!';
            setTimeout(() => btn.textContent = 'üìã Copy Dimensions', 2000);
          }).catch(() => {
            fallbackCopy(dims);
          });
        } else {
          fallbackCopy(dims);
        }
      }
    });

    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      updateClipboard(text);
      const btn = document.getElementById('upscalerCopyDims');
      btn.textContent = '‚úì Copied!';
      setTimeout(() => btn.textContent = 'üìã Copy Dimensions', 2000);
    }

    // Export format buttons
    let upscalerExportFormat = 'png';
    document.querySelectorAll('#panel-upscaler [data-export]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#panel-upscaler [data-export]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        upscalerExportFormat = btn.dataset.export;
      });
    });

    document.getElementById('upscalerDownload').addEventListener('click', async () => {
      if (state.upscaler.files.length === 0) return;

      const format = upscalerExportFormat;
      const zip = new JSZip();
      
      for (const f of state.upscaler.files) {
        // Recreate canvas from blob for format conversion
        const img = await loadImage(f.previewUrl);
        const canvas = document.createElement('canvas');
        canvas.width = f.width;
        canvas.height = f.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, f.width, f.height);

        if (format === 'png' || format === 'all') {
          const pngBlob = await new Promise(r => canvas.toBlob(r, 'image/png'));
          zip.file(f.name + '.png', pngBlob);
        }

        if (format === 'jpg' || format === 'all') {
          // Add white background for JPG
          const jpgCanvas = document.createElement('canvas');
          jpgCanvas.width = f.width;
          jpgCanvas.height = f.height;
          const jpgCtx = jpgCanvas.getContext('2d');
          jpgCtx.fillStyle = '#ffffff';
          jpgCtx.fillRect(0, 0, f.width, f.height);
          jpgCtx.drawImage(canvas, 0, 0);
          const jpgBlob = await new Promise(r => jpgCanvas.toBlob(r, 'image/jpeg', 0.92));
          zip.file(f.name + '.jpg', jpgBlob);
        }

        if (format === 'pdf' || format === 'all') {
          const { jsPDF } = window.jspdf;
          const inchW = f.width / 300;
          const inchH = f.height / 300;

          if (!pdfDoc) {
            pdfDoc = new jsPDF({ orientation: inchW > inchH ? 'landscape' : 'portrait', unit: 'in', format: [inchW, inchH] });
          } else {
            pdfDoc.addPage([inchW, inchH], inchW > inchH ? 'landscape' : 'portrait');
          }

          // Start with high quality, reduce if needed for 20MB limit
          let quality = 0.92;
          let imgData = canvas.toDataURL('image/jpeg', quality);

          // Estimate size and reduce quality if too large
          while (imgData.length > 15000000 && quality > 0.5) {
            quality -= 0.1;
            imgData = canvas.toDataURL('image/jpeg', quality);
          }

          pdfDoc.addImage(imgData, 'JPEG', 0, 0, inchW, inchH);
        }
      }

      // Handle PDF as single file
      if ((format === 'pdf' || format === 'all') && pdfDoc) {
        if (format === 'pdf') {
          // PDF only - download directly
          const pdfBlob = pdfDoc.output('blob');
          downloadBlob(pdfBlob, 'upscaled-images.pdf');
          Utils.toast(`Downloaded PDF with ${state.upscaler.files.length} pages`);
          return;
        } else {
          // All formats - add PDF to zip
          zip.file('all-images.pdf', pdfDoc.output('blob'));
        }
      }

      const blob = await zip.generateAsync({ type: 'blob' });
      const suffix = format === 'all' ? 'all-formats' : format;
      downloadBlob(blob, `upscaled-${suffix}.zip`);
      Utils.toast(`Downloaded ${state.upscaler.files.length} files as ${format.toUpperCase()}`);
    });

    async function handleUpscalerFiles(files) {
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const img = await loadImage(dataUrl);
        state.upscaler.files.push({
          id: Date.now() + Math.random(),
          name: file.name.replace(/\.[^/.]+$/, ''),
          original: img,
          dataUrl,
          originalUrl: dataUrl
        });
      }
      document.getElementById('upscalerProcess').disabled = false;
      Utils.toast(state.upscaler.files.length + ' image(s) ready - select sizes and click Process');
    }

    document.getElementById('upscalerProcess').addEventListener('click', () => {
      if (state.upscaler.files.length > 0) {
        processUpscaler();
      }
    });

    async function processUpscaler() {
      // Gather presets from ALL preset groups
      const presets = Array.from(document.querySelectorAll('#panel-upscaler .preset-btn.active')).map(btn => ({
        mode: btn.dataset.mode,
        min: parseInt(btn.dataset.min) || 0,
        w: parseInt(btn.dataset.w) || 0,
        h: parseInt(btn.dataset.h) || 0,
        label: btn.dataset.label || 'min'
      })).filter(p => p.mode); // Filter out non-preset buttons

      if (presets.length === 0) {
        Utils.toast('Select at least one size preset', 'error');
        return;
      }

      const keepRatio = document.getElementById('upscalerKeepRatio').checked;
      const output = document.getElementById('upscalerOutput');
      output.innerHTML = '<div style="text-align:center;padding:40px;"><div class="spinner" style="margin:0 auto;"></div><p style="margin-top:16px;color:var(--text-muted);">Processing...</p></div>';

      const results = [];

      for (const file of state.upscaler.files) {
        for (const preset of presets) {
          const img = file.original;
          let newW, newH, suffix;

          if (preset.mode === 'minimum') {
            // Minimum mode: scale so smallest side is at least the minimum
            const minDim = Math.min(img.width, img.height);
            const scale = minDim >= preset.min ? 1 : preset.min / minDim;
            newW = Math.round(img.width * scale);
            newH = Math.round(img.height * scale);
            suffix = preset.min + 'px';
          } else if (keepRatio) {
            // Keep ratio mode: scale proportionally to fit within target, maintain original aspect ratio
            const imgRatio = img.width / img.height;
            const targetRatio = preset.w / preset.h;
            
            if (imgRatio > targetRatio) {
              // Image is wider - scale based on width
              newW = preset.w;
              newH = Math.round(preset.w / imgRatio);
            } else {
              // Image is taller - scale based on height
              newH = preset.h;
              newW = Math.round(preset.h * imgRatio);
            }
            suffix = preset.label.replace(' ', '') + '_ratio';
          } else {
            // Exact mode: stretch/distort to exact dimensions
            newW = preset.w;
            newH = preset.h;
            suffix = preset.label.replace(' ', '');
          }

          const canvas = document.createElement('canvas');
          canvas.width = newW;
          canvas.height = newH;
          const ctx = canvas.getContext('2d', { alpha: true });
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, 0, 0, newW, newH);

          const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
          const previewUrl = canvas.toDataURL('image/png');

          const inchW = (newW / 300).toFixed(1);
          const inchH = (newH / 300).toFixed(1);
          const dimString = `${inchW}" x ${inchH}" - ${newW} x ${newH} px`;

          results.push({
            id: Date.now() + Math.random(),
            name: `${file.name}_${suffix}_300dpi`,
            blob,
            previewUrl,
            originalUrl: file.originalUrl || file.dataUrl,
            width: newW,
            height: newH,
            dimString
          });
        }
      }

      state.upscaler.files = results;
      state.stats.processed += results.length;
      updateStats();
      renderUpscalerOutput();
    }

    function renderUpscalerOutput() {
      const output = document.getElementById('upscalerOutput');
      const compare = document.getElementById('upscalerCompare');

      if (state.upscaler.files.length === 0) {
        output.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><p>Upload images to upscale</p></div>';
        document.getElementById('upscalerCopyDims').disabled = true;
        document.getElementById('upscalerDownload').disabled = true;
        compare.style.display = 'none';
        return;
      }

      // Show before/after comparison for first image
      const first = state.upscaler.files[0];
      if (first.originalUrl && first.previewUrl) {
        compare.style.display = 'block';
        document.getElementById('compareBefore').src = first.originalUrl;
        document.getElementById('compareAfter').src = first.previewUrl;
        initCompareSlider();
      }

      output.innerHTML = state.upscaler.files.map((f, i) => `
        <div class="output-item">
          <div class="output-thumb preview-thumb" onclick="openUpscalerLightbox(${i})" title="Click to enlarge"><img src="${f.previewUrl}" alt=""></div>
          <div class="output-info">
            <input class="output-name" value="${f.name}" data-idx="${i}">
            <div class="output-dims">${f.width} √ó ${f.height}px ¬∑ ${(f.width/300).toFixed(1)}" √ó ${(f.height/300).toFixed(1)}"</div>
          </div>
          <div class="output-actions">
            <button class="copy-btn" data-copy="${f.dimString}" title="Copy dims"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
            <button class="primary" onclick="downloadBlob(state.upscaler.files[${i}].blob, state.upscaler.files[${i}].name + '.png')">‚¨á</button>
          </div>
        </div>
      `).join('');

      output.querySelectorAll('.output-name').forEach(input => {
        input.addEventListener('change', e => {
          state.upscaler.files[parseInt(e.target.dataset.idx)].name = e.target.value;
        });
      });

      output.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          navigator.clipboard.writeText(btn.dataset.copy);
          btn.classList.add('copied');
          setTimeout(() => btn.classList.remove('copied'), 1000);
        });
      });

      document.getElementById('upscalerCopyDims').disabled = false;
      document.getElementById('upscalerDownload').disabled = false;
    }

    function initCompareSlider() {
      const container = document.getElementById('compareContainer');
      const slider = document.getElementById('compareSlider');
      const clip = document.getElementById('compareClip');
      if (!container || !slider) return;

      let isDragging = false;

      function updateSlider(clientX) {
        const rect = container.getBoundingClientRect();
        let x = (clientX - rect.left) / rect.width;
        x = Math.max(0, Math.min(1, x));
        slider.style.left = (x * 100) + '%';
        clip.style.width = (x * 100) + '%';
      }

      slider.addEventListener('mousedown', () => isDragging = true);
      slider.addEventListener('touchstart', () => isDragging = true, {passive: true});

      document.addEventListener('mousemove', e => { if (isDragging) updateSlider(e.clientX); });
      document.addEventListener('touchmove', e => { if (isDragging && e.touches[0]) updateSlider(e.touches[0].clientX); }, {passive: true});

      document.addEventListener('mouseup', () => isDragging = false);
      document.addEventListener('touchend', () => isDragging = false);

      container.addEventListener('click', e => updateSlider(e.clientX));
    }

    function openUpscalerLightbox(index) {
      const images = state.upscaler.files.map(f => f.previewUrl);
      const file = state.upscaler.files[index];
      openLightbox(images, index, `${file.name} ‚Ä¢ ${file.width}√ó${file.height}px`);
    }


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: WALL ART RESIZER
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: WALL ART RESIZER
// ============================================
    // ============================================
    // WALL ART RESIZER (Batch Processing)
    // ============================================
    let wallartImages = [];

    // Size toggle buttons
    document.querySelectorAll('#wallartSizes .preset-btn, #wallartSizesSquare .preset-btn').forEach(btn => {
      btn.onclick = function() {
        this.classList.toggle('active');
      };
    });

    setupUploadZone('wallartUpload', 'wallartInput', async (files) => {
      for (const file of Array.from(files)) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const img = await loadImage(dataUrl);
        wallartImages.push({ img, name: file.name.replace(/\.[^/.]+$/, ''), dataUrl });
      }
      renderWallartThumbs();
      if (wallartImages.length > 0) {
        document.getElementById('wallartDownload').disabled = false;
        // Show first image preview
        document.getElementById('wallartPreview').innerHTML = `<img src="${wallartImages[0].dataUrl}" style="max-width:100%;max-height:350px;border-radius:8px;">`;
      }
    });

    function renderWallartThumbs() {
      const list = document.getElementById('wallartFileList');
      const thumbs = document.getElementById('wallartThumbs');
      const count = document.getElementById('wallartFileCount');
      
      if (wallartImages.length === 0) {
        list.style.display = 'none';
        document.getElementById('wallartDownload').disabled = true;
        return;
      }
      
      list.style.display = 'block';
      count.textContent = wallartImages.length;
      thumbs.innerHTML = wallartImages.map((d, i) => `
        <div style="position:relative;width:44px;height:44px;border-radius:4px;overflow:hidden;border:2px solid var(--border);cursor:pointer;" onclick="previewWallartImage(${i})">
          <img src="${d.dataUrl}" style="width:100%;height:100%;object-fit:cover;">
          <button onclick="event.stopPropagation();removeWallartImage(${i})" style="position:absolute;top:-3px;right:-3px;width:16px;height:16px;border-radius:50%;background:#e74c3c;border:none;color:#fff;font-size:9px;cursor:pointer;line-height:1;">‚úï</button>
        </div>
      `).join('');
    }

    window.previewWallartImage = function(index) {
      if (wallartImages[index]) {
        document.getElementById('wallartPreview').innerHTML = `<img src="${wallartImages[index].dataUrl}" style="max-width:100%;max-height:350px;border-radius:8px;">`;
      }
    };

    window.removeWallartImage = function(index) {
      wallartImages.splice(index, 1);
      renderWallartThumbs();
      if (wallartImages.length > 0) {
        document.getElementById('wallartPreview').innerHTML = `<img src="${wallartImages[0].dataUrl}" style="max-width:100%;max-height:350px;border-radius:8px;">`;
      } else {
        document.getElementById('wallartPreview').innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><p>Upload artwork to preview</p></div>`;
      }
    };

    document.getElementById('wallartClearAll').onclick = () => {
      wallartImages = [];
      renderWallartThumbs();
      document.getElementById('wallartPreview').innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><p>Upload artwork to preview</p></div>`;
    };

    document.getElementById('wallartDownload').addEventListener('click', async () => {
      if (wallartImages.length === 0) return;

      const btn = document.getElementById('wallartDownload');
      const progressDiv = document.getElementById('wallartProgress');
      const progressBar = document.getElementById('wallartProgressBar');
      const progressText = document.getElementById('wallartProgressText');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Processing...';
      progressDiv.style.display = 'block';

      try {
        // Get selected sizes
        const selectedSizes = Array.from(document.querySelectorAll('#wallartSizes .preset-btn.active, #wallartSizesSquare .preset-btn.active')).map(btn => ({
          name: btn.dataset.wallsize,
          w: parseInt(btn.dataset.w),
          h: parseInt(btn.dataset.h)
        }));

        if (selectedSizes.length === 0) {
          Utils.toast('Select at least one size', 'error');
          btn.disabled = false;
          btn.textContent = '‚¨áÔ∏è Download ZIP';
          progressDiv.style.display = 'none';
          return;
        }

        const zip = new JSZip();
        const totalOps = wallartImages.length * selectedSizes.length;
        let completed = 0;

        for (const wallart of wallartImages) {
          const img = wallart.img;
          
          // Create folder for each image if multiple images
          const folder = wallartImages.length > 1 ? zip.folder(wallart.name) : zip;

          for (const size of selectedSizes) {
            const canvas = document.createElement('canvas');
            canvas.width = size.w;
            canvas.height = size.h;
            const ctx = canvas.getContext('2d');

            // Stretch to fill entire canvas
            ctx.drawImage(img, 0, 0, size.w, size.h);

            const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.95));
            folder.file(`${wallart.name}_${size.name}.jpg`, blob);
            
            completed++;
            const pct = Math.round((completed / totalOps) * 100);
            progressBar.style.width = pct + '%';
            progressText.textContent = `Processing ${completed}/${totalOps} files...`;
          }
        }

        progressText.textContent = 'Creating ZIP...';
        const blob = await zip.generateAsync({ type: 'blob' });
        
        const filename = wallartImages.length === 1 
          ? `${wallartImages[0].name}_wall-art-${selectedSizes.length}sizes.zip`
          : `wall-art-batch-${wallartImages.length}images-${selectedSizes.length}sizes.zip`;
        
        downloadBlob(blob, filename);
        Utils.toast(`Downloaded ${wallartImages.length} images √ó ${selectedSizes.length} sizes!`);
      } catch (e) {
        console.error(e);
        Utils.toast('Error creating files', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚¨áÔ∏è Download ZIP';
        progressDiv.style.display = 'none';
        progressBar.style.width = '0%';
      }
    });



// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: COLORING BOOK
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: COLORING BOOK CREATOR
// ============================================
    // ============================================
    // COLORING BOOK (Simplified)
    // ============================================
    setupUploadZone('coloringUpload', 'coloringInput', handleColoringFiles);

    let coloringMode = 'edges';
    document.getElementById('coloringEdges').addEventListener('click', () => {
      coloringMode = 'edges';
      document.getElementById('coloringEdges').classList.add('active');
      document.getElementById('coloringSketch').classList.remove('active');
      processColoringPages();
    });
    document.getElementById('coloringSketch').addEventListener('click', () => {
      coloringMode = 'sketch';
      document.getElementById('coloringSketch').classList.add('active');
      document.getElementById('coloringEdges').classList.remove('active');
      processColoringPages();
    });

    document.getElementById('coloringSensitivity').addEventListener('input', e => {
      document.getElementById('coloringSensVal').textContent = e.target.value + '%';
    });
    document.getElementById('coloringStrength').addEventListener('input', e => {
      document.getElementById('coloringStrVal').textContent = (e.target.value / 10).toFixed(1) + 'x';
    });

    document.getElementById('coloringSelectAll').addEventListener('click', () => {
      if (state.coloring.selected.size === state.coloring.files.length) {
        state.coloring.selected.clear();
      } else {
        state.coloring.files.forEach(f => state.coloring.selected.add(f.id));
      }
      renderColoringGrid();
    });

    document.getElementById('coloringDownload').addEventListener('click', downloadColoringPDF);

    async function handleColoringFiles(files) {
      const fileArray = Array.from(files);

      // First, load all files and show them immediately
      for (const file of fileArray) {
        if (!file.type.startsWith('image/')) continue;
        try {
          const dataUrl = await readFileAsDataURL(file);
          const img = await loadImage(dataUrl);
          const id = Date.now() + Math.random();
          state.coloring.files.push({ id, img, dataUrl, processed: null, processing: true });
          state.coloring.selected.add(id);
        } catch (e) {
          console.error('Error loading image:', e);
        }
      }

      // Show grid immediately with loading state
      renderColoringGrid();

      // Then process each one
      await processColoringPages();
    }

    async function processColoringPages() {
      const sensitivity = parseInt(document.getElementById('coloringSensitivity').value) / 100;
      const strength = parseInt(document.getElementById('coloringStrength').value) / 10;

      for (const file of state.coloring.files) {
        if (file.processed && !file.needsReprocess) continue; // Skip already processed

        try {
          const canvas = document.createElement('canvas');
          const maxSize = 1200; // Increased for better quality
          const scale = Math.min(maxSize / file.img.width, maxSize / file.img.height, 1);
          canvas.width = Math.floor(file.img.width * scale);
          canvas.height = Math.floor(file.img.height * scale);
          const ctx = canvas.getContext('2d');

          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(file.img, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          const w = canvas.width, h = canvas.height;

          // Simple edge detection
          const gray = new Float32Array(w * h);
          for (let i = 0; i < data.length; i += 4) {
            gray[i / 4] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
          }

          const edges = new Float32Array(w * h);
          for (let y = 1; y < h - 1; y++) {
            for (let x = 1; x < w - 1; x++) {
              const idx = y * w + x;
              const gx = -gray[idx - w - 1] - 2 * gray[idx - 1] - gray[idx + w - 1] + gray[idx - w + 1] + 2 * gray[idx + 1] + gray[idx + w + 1];
              const gy = -gray[idx - w - 1] - 2 * gray[idx - w] - gray[idx - w + 1] + gray[idx + w - 1] + 2 * gray[idx + w] + gray[idx + w + 1];
              edges[idx] = Math.sqrt(gx * gx + gy * gy) / 255;
            }
          }

          // Find max without spread operator (avoids stack overflow)
          let maxE = 0;
          for (let i = 0; i < edges.length; i++) {
            if (edges[i] > maxE) maxE = edges[i];
          }
          maxE = maxE || 1;
          for (let i = 0; i < data.length; i += 4) {
            const e = edges[i / 4];
            if (e > sensitivity) {
              const v = 255 - Math.min(255, (e / maxE) * 255 * strength);
              data[i] = data[i + 1] = data[i + 2] = v;
            } else {
              data[i] = data[i + 1] = data[i + 2] = 255;
            }
            data[i + 3] = 255;
          }

          ctx.putImageData(imageData, 0, 0);
          file.processed = canvas.toDataURL('image/jpeg', 0.9);
          file.processing = false;
          file.needsReprocess = false;

          // Update grid after each image processes
          renderColoringGrid();

          // Small delay to let UI update
          await new Promise(r => setTimeout(r, 10));
        } catch (e) {
          console.error('Error processing image:', e);
          file.processing = false;
        }
      }

      state.stats.processed += state.coloring.files.filter(f => f.processed).length;
      updateStats();
      renderColoringGrid();
    }

    function renderColoringGrid() {
      const grid = document.getElementById('coloringGrid');
      const count = document.getElementById('coloringCount');

      count.textContent = `(${state.coloring.files.length})`;
      document.getElementById('coloringDownload').disabled = state.coloring.selected.size === 0;

      if (state.coloring.files.length === 0) {
        grid.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><p>Upload images to create coloring pages</p></div>';
        return;
      }

      grid.innerHTML = state.coloring.files.map((f, i) => `
        <div class="image-card ${state.coloring.selected.has(f.id) ? 'selected' : ''}" data-id="${f.id}">
          <div class="image-card-preview preview-thumb" style="position:relative;" onclick="openColoringLightbox(${i})">
            <img src="${f.processed || f.dataUrl}" alt="">
            ${f.processing ? '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;"><div class="spinner"></div></div>' : '<div style="position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,0.6);padding:2px 6px;border-radius:4px;font-size:10px;">üîç Click to enlarge</div>'}
          </div>
          <div class="image-card-actions">
            <button onclick="event.stopPropagation(); state.coloring.selected.has(${f.id}) ? state.coloring.selected.delete(${f.id}) : state.coloring.selected.add(${f.id}); renderColoringGrid();">
              ${state.coloring.selected.has(f.id) ? '‚úì' : '‚óã'}
            </button>
            <button onclick="event.stopPropagation(); state.coloring.files.splice(${i}, 1); state.coloring.selected.delete(${f.id}); renderColoringGrid();">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function openColoringLightbox(index) {
      const images = state.coloring.files.filter(f => f.processed || f.dataUrl).map(f => f.processed || f.dataUrl);
      const names = state.coloring.files.map(f => f.name);
      openLightbox(images, index, `${names[index]} ‚Ä¢ ${index + 1} of ${images.length}`);
    }

    async function downloadColoringPDF() {
      const selected = state.coloring.files.filter(f => state.coloring.selected.has(f.id) && f.processed);
      if (selected.length === 0) {
        Utils.toast('No processed images selected', 'error');
        return;
      }

      const btn = document.getElementById('coloringDownload');
      btn.disabled = true;
      btn.textContent = '‚è≥ Creating PDF...';

      // Get options
      const addPageNumbers = document.getElementById('coloringPageNumbers').checked;
      const addCover = document.getElementById('coloringCoverPage').checked;
      const addInstructions = document.getElementById('coloringInstructions').checked;
      const coverTitle = document.getElementById('coloringCoverTitle').value || 'Coloring Book';

      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'in', format: 'letter' });

        let pageNum = 0;

        // Add cover page
        if (addCover) {
          const { canvas: coverCanvas, ctx: coverCtx } = Utils.createCanvas(2550, 3300, { background: 'white' });

          // Draw decorative border
          coverCtx.strokeStyle = '#333';
          coverCtx.lineWidth = 8;
          coverCtx.strokeRect(100, 100, 2350, 3100);

          // Title
          coverCtx.fillStyle = '#333';
          coverCtx.font = 'bold 120px Georgia, serif';
          coverCtx.textAlign = 'center';
          coverCtx.fillText(coverTitle, 1275, 1500);

          // Subtitle
          coverCtx.font = '48px Georgia, serif';
          coverCtx.fillStyle = '#666';
          coverCtx.fillText(`${selected.length} Pages`, 1275, 1650);

          const coverData = coverCanvas.toDataURL('image/jpeg', 0.9);
          pdf.addImage(coverData, 'JPEG', 0, 0, 8.5, 11);
          pageNum++;
        }

        // Add instructions page
        if (addInstructions) {
          if (pageNum > 0) pdf.addPage('letter', 'portrait');

          const { canvas: instCanvas, ctx: instCtx } = Utils.createCanvas(2550, 3300, { background: 'white' });

          instCtx.fillStyle = '#333';
          instCtx.font = 'bold 72px Georgia, serif';
          instCtx.textAlign = 'center';
          instCtx.fillText('How to Use This Book', 1275, 400);

          instCtx.font = '36px Georgia, serif';
          instCtx.textAlign = 'left';
          const instructions = [
            '1. Print pages on high-quality paper (cardstock works great!)',
            '2. Use colored pencils, markers, or crayons',
            '3. Take your time and enjoy the process',
            '4. Frame your favorites or give them as gifts!',
            '',
            'Tips for Best Results:',
            '‚Ä¢ Use printer setting "Best Quality"',
            '‚Ä¢ Let ink dry before coloring',
            '‚Ä¢ Test markers on a scrap first',
            '',
            'Enjoy your coloring journey! ‚ú®'
          ];

          instructions.forEach((line, i) => {
            instCtx.fillText(line, 200, 600 + i * 80);
          });

          const instData = instCanvas.toDataURL('image/jpeg', 0.9);
          pdf.addImage(instData, 'JPEG', 0, 0, 8.5, 11);
          pageNum++;
        }

        // Add coloring pages
        for (let i = 0; i < selected.length; i++) {
          if (pageNum > 0) pdf.addPage('letter', 'portrait');
          pageNum++;

          btn.textContent = `‚è≥ Page ${i + 1}/${selected.length}...`;

          const processedImg = await loadImage(selected[i].processed);
          const { canvas, ctx } = Utils.createCanvas(2550, 3300, { background: 'white' });

          // Scale to fit with margins
          const margin = 150;
          const maxW = canvas.width - (margin * 2);
          const maxH = canvas.height - (margin * 2) - (addPageNumbers ? 100 : 0);
          const scale = Math.min(maxW / processedImg.width, maxH / processedImg.height);
          const drawW = processedImg.width * scale;
          const drawH = processedImg.height * scale;
          const x = (canvas.width - drawW) / 2;
          const y = (canvas.height - drawH - (addPageNumbers ? 50 : 0)) / 2;

          ctx.drawImage(processedImg, x, y, drawW, drawH);

          // Add page number
          if (addPageNumbers) {
            ctx.fillStyle = '#999';
            ctx.font = '36px Georgia, serif';
            ctx.textAlign = 'center';
            ctx.fillText(`- ${i + 1} -`, canvas.width / 2, canvas.height - 80);
          }

          const jpgData = canvas.toDataURL('image/jpeg', 0.9);
          pdf.addImage(jpgData, 'JPEG', 0, 0, 8.5, 11);

          await new Promise(r => setTimeout(r, 50));
        }

        const filename = document.getElementById('coloringFilename').value.trim() || 'coloring-book';

        // Use blob method for better compatibility
        const blob = pdf.output('blob');
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename + '.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        Utils.toast(`Downloaded: ${filename}.pdf (${pageNum} pages)`);
      } catch (e) {
        console.error('PDF error:', e);
        Utils.toast('Error creating PDF: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚¨áÔ∏è Download PDF';
      }
    }


    // ============================================
    // ENHANCED COLORING BOOK - Cover & Page Numbers
    // ============================================
    document.getElementById('coloringCoverPage').onchange = (e) => {
      document.getElementById('coloringCoverSettings').style.display = e.target.checked ? 'block' : 'none';
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: GREETING CARDS
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: GREETING CARD CREATOR
// ============================================
    // ============================================
    // GREETING CARD MAKER
    // ============================================
    let greetingFront = null;
    let greetingLogo = null;
    let greetingInside = null;
    let greetingSize = '5x7';
    let greetingFold = 'half';
    let greetingBack = 'blank';
    let greetingInsideType = 'blank';

    function showGreetingPreview(tab) {
      document.getElementById('greetingPreviewFront').style.display = tab === 'front' ? 'flex' : 'none';
      document.getElementById('greetingPreviewInside').style.display = tab === 'inside' ? 'flex' : 'none';
      document.getElementById('greetingPreviewFrontBtn').classList.toggle('active', tab === 'front');
      document.getElementById('greetingPreviewInsideBtn').classList.toggle('active', tab === 'inside');
    }

    // Inside content type toggle
    document.querySelectorAll('#panel-greeting [data-inside]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-greeting [data-inside]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        greetingInsideType = btn.dataset.inside;
        document.getElementById('greetingMessageGroup').style.display = greetingInsideType === 'message' ? 'block' : 'none';
        document.getElementById('greetingInsideImageGroup').style.display = greetingInsideType === 'image' ? 'block' : 'none';
        renderGreetingInsidePreview();
      };
    });

    setupUploadZone('greetingUpload', 'greetingInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;

      const dataUrl = await readFileAsDataURL(file);
      const img = await loadImage(dataUrl);
      greetingFront = { name: Utils.getBaseName(file.name), img, dataUrl };

      renderGreetingPreview();
      document.getElementById('greetingDownload').disabled = false;
      Utils.toast('Front design loaded!');
    });

    setupUploadZone('greetingInsideUpload', 'greetingInsideInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;

      const dataUrl = await readFileAsDataURL(file);
      const img = await loadImage(dataUrl);
      greetingInside = { img, dataUrl };

      renderGreetingInsidePreview();
      Utils.toast('Inside image loaded!');
    });

    setupUploadZone('greetingLogoUpload', 'greetingLogoInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;

      const dataUrl = await readFileAsDataURL(file);
      const img = await loadImage(dataUrl);
      greetingLogo = { img, dataUrl };

      renderGreetingPreview();
      Utils.toast('Logo loaded!');
    });

    document.querySelectorAll('#panel-greeting [data-cardsize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-greeting [data-cardsize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        greetingSize = btn.dataset.cardsize;
        renderGreetingPreview();
      };
    });

    document.querySelectorAll('#panel-greeting [data-fold]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-greeting [data-fold]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        greetingFold = btn.dataset.fold;
        renderGreetingPreview();
      };
    });

    document.querySelectorAll('#panel-greeting [data-back]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-greeting [data-back]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        greetingBack = btn.dataset.back;
        document.getElementById('greetingLogoGroup').style.display = greetingBack === 'logo' ? 'block' : 'none';
        renderGreetingPreview();
      };
    });

    function getCardDimensions(size, fold) {
      // Dimensions in inches for FOLDED card
      const sizes = {
        '5x7': { w: 5, h: 7 },
        '4x6': { w: 4, h: 6 },
        'a2': { w: 4.25, h: 5.5 },
        'a7': { w: 5, h: 7 }
      };

      const folded = sizes[size] || sizes['5x7'];

      // Flat dimensions depend on fold type
      if (fold === 'half') {
        return { flatW: folded.w, flatH: folded.h * 2, foldedW: folded.w, foldedH: folded.h };
      } else if (fold === 'side') {
        return { flatW: folded.w * 2, flatH: folded.h, foldedW: folded.w, foldedH: folded.h };
      } else { // quarter
        return { flatW: folded.w * 2, flatH: folded.h * 2, foldedW: folded.w, foldedH: folded.h };
      }
    }

    function renderGreetingPreview() {
      const preview = document.getElementById('greetingPreviewFront');

      if (!greetingFront?.img) {
        preview.innerHTML = '<div class="empty-state"><p>Upload a design to preview card</p></div>';
        return;
      }

      const dims = getCardDimensions(greetingSize, greetingFold);
      const dpi = 300;
      const bleed = document.getElementById('greetingBleed').checked ? 0.125 : 0;

      // Create preview canvas (scaled down for display)
      const scale = 0.3;
      const flatW = (dims.flatW + bleed * 2) * dpi * scale;
      const flatH = (dims.flatH + bleed * 2) * dpi * scale;

      const { canvas, ctx } = Utils.createCanvas(flatW, flatH, '#ffffff');

      // Draw front panel
      const frontX = bleed * dpi * scale;
      const frontY = bleed * dpi * scale;
      const panelW = dims.foldedW * dpi * scale;
      const panelH = dims.foldedH * dpi * scale;

      // Position front based on fold type
      let fx, fy;
      if (greetingFold === 'half') {
        fx = frontX;
        fy = frontY + panelH; // Front is bottom half
      } else if (greetingFold === 'side') {
        fx = frontX + panelW; // Front is right half
        fy = frontY;
      } else { // quarter - front is bottom right
        fx = frontX + panelW;
        fy = frontY + panelH;
      }

      // Draw front image (fit to panel)
      const fScale = Math.min(panelW / greetingFront.img.width, panelH / greetingFront.img.height);
      const fw = greetingFront.img.width * fScale;
      const fh = greetingFront.img.height * fScale;
      ctx.drawImage(greetingFront.img, fx + (panelW - fw) / 2, fy + (panelH - fh) / 2, fw, fh);

      // Draw back panel
      if (greetingBack === 'mirror') {
        let bx, by;
        if (greetingFold === 'half') {
          bx = frontX; by = frontY;
        } else if (greetingFold === 'side') {
          bx = frontX; by = frontY;
        } else {
          bx = frontX; by = frontY;
        }
        ctx.drawImage(greetingFront.img, bx + (panelW - fw) / 2, by + (panelH - fh) / 2, fw, fh);
      } else if (greetingBack === 'logo' && greetingLogo?.img) {
        let bx, by;
        if (greetingFold === 'half') {
          bx = frontX; by = frontY;
        } else if (greetingFold === 'side') {
          bx = frontX; by = frontY;
        } else {
          bx = frontX; by = frontY;
        }
        const logoSize = Math.min(panelW, panelH) * 0.3;
        const lScale = Math.min(logoSize / greetingLogo.img.width, logoSize / greetingLogo.img.height);
        const lw = greetingLogo.img.width * lScale;
        const lh = greetingLogo.img.height * lScale;
        ctx.drawImage(greetingLogo.img, bx + (panelW - lw) / 2, by + panelH - lh - 20 * scale, lw, lh);
      }

      // Draw fold lines
      if (document.getElementById('greetingCutLines').checked) {
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);

        if (greetingFold === 'half') {
          ctx.beginPath();
          ctx.moveTo(0, flatH / 2);
          ctx.lineTo(flatW, flatH / 2);
          ctx.stroke();
        } else if (greetingFold === 'side') {
          ctx.beginPath();
          ctx.moveTo(flatW / 2, 0);
          ctx.lineTo(flatW / 2, flatH);
          ctx.stroke();
        } else {
          ctx.beginPath();
          ctx.moveTo(0, flatH / 2);
          ctx.lineTo(flatW, flatH / 2);
          ctx.moveTo(flatW / 2, 0);
          ctx.lineTo(flatW / 2, flatH);
          ctx.stroke();
        }
        ctx.setLineDash([]);
      }

      // Draw border
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 1;
      ctx.strokeRect(0, 0, flatW, flatH);

      preview.innerHTML = `
        <div style="text-align:center;">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Flat Layout (${dims.flatW}" √ó ${dims.flatH}")</div>
          <canvas id="greetingCanvas" style="max-width:100%;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,0.1);"></canvas>
          <div style="font-size:11px;color:var(--text-muted);margin-top:12px;">Folded size: ${dims.foldedW}" √ó ${dims.foldedH}"</div>
        </div>
      `;

      const displayCanvas = document.getElementById('greetingCanvas');
      displayCanvas.width = flatW;
      displayCanvas.height = flatH;
      displayCanvas.getContext('2d').drawImage(canvas, 0, 0);
    }

    document.getElementById('greetingCutLines').onchange = renderGreetingPreview;
    document.getElementById('greetingBleed').onchange = renderGreetingPreview;
    document.getElementById('greetingMessage').addEventListener('input', renderGreetingInsidePreview);

    function renderGreetingInsidePreview() {
      const preview = document.getElementById('greetingPreviewInside');
      const dims = getCardDimensions(greetingSize, greetingFold);
      const dpi = 300;
      const scale = 0.3;
      const panelW = dims.foldedW * dpi * scale;
      const panelH = dims.foldedH * dpi * scale;

      if (greetingInsideType === 'blank') {
        preview.innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="5" width="18" height="14" rx="2"/></svg><p>Inside will be blank</p></div>`;
        return;
      }

      const { canvas, ctx } = Utils.createCanvas(panelW, panelH, '#ffffff');

      if (greetingInsideType === 'message') {
        const message = document.getElementById('greetingMessage').value.trim();
        if (!message) {
          preview.innerHTML = `<div class="empty-state"><p>Enter a message above</p></div>`;
          return;
        }
        ctx.fillStyle = '#333';
        ctx.font = `${14 * scale}px Georgia, serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const lines = message.split('\n');
        const lineHeight = 20 * scale;
        const startY = panelH / 2 - (lines.length - 1) * lineHeight / 2;
        lines.forEach((line, i) => {
          ctx.fillText(line, panelW / 2, startY + i * lineHeight);
        });
      } else if (greetingInsideType === 'image' && greetingInside?.img) {
        const img = greetingInside.img;
        const iScale = Math.min(panelW / img.width, panelH / img.height) * 0.9;
        const iw = img.width * iScale;
        const ih = img.height * iScale;
        ctx.drawImage(img, (panelW - iw) / 2, (panelH - ih) / 2, iw, ih);
      } else if (greetingInsideType === 'image') {
        preview.innerHTML = `<div class="empty-state"><p>Upload inside image above</p></div>`;
        return;
      }

      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 1;
      ctx.strokeRect(0, 0, panelW, panelH);

      preview.innerHTML = `
        <div style="text-align:center;">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Inside Preview</div>
          <canvas id="greetingInsideCanvas" style="max-width:100%;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,0.1);"></canvas>
        </div>
      `;

      const displayCanvas = document.getElementById('greetingInsideCanvas');
      displayCanvas.width = panelW;
      displayCanvas.height = panelH;
      displayCanvas.getContext('2d').drawImage(canvas, 0, 0);
    }

    document.getElementById('greetingDownload').addEventListener('click', downloadGreetingCard);

    async function downloadGreetingCard() {
      if (!greetingFront?.img) {
        Utils.toast('Please upload a front design first', 'error');
        return;
      }

      const btn = document.getElementById('greetingDownload');
      btn.disabled = true;
      btn.textContent = '‚è≥ Creating PDF...';

      try {
        const { jsPDF } = window.jspdf;
        const dpi = 300;

        // US Letter: 8.5 x 11 inches
        const pageW = 11; // landscape
        const pageH = 8.5;
        const pxW = pageW * dpi; // 3300
        const pxH = pageH * dpi; // 2550

        // Each panel is 5.5 x 8.5, but card area is 5 x 7 centered
        const panelW = pxW / 2; // 1650px = 5.5"
        const panelH = pxH;     // 2550px = 8.5"
        const cardW = 5 * dpi;  // 1500px
        const cardH = 7 * dpi;  // 2100px
        const marginX = (panelW - cardW) / 2; // center card in panel
        const marginY = (panelH - cardH) / 2;

        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'in',
          format: 'letter'
        });

        // ========== PAGE 1: OUTSIDE (Back on left, Front on right) ==========
        const { canvas: page1, ctx: ctx1 } = Utils.createCanvas(pxW, pxH, '#ffffff');

        // Left half = BACK COVER (blank or logo)
        if (greetingBack === 'logo' && greetingLogo?.img) {
          const logo = greetingLogo.img;
          const logoMaxSize = 1 * dpi; // 1 inch max
          const lScale = Math.min(logoMaxSize / logo.width, logoMaxSize / logo.height);
          const lw = logo.width * lScale;
          const lh = logo.height * lScale;
          const lx = marginX + (cardW - lw) / 2;
          const ly = marginY + cardH - lh - (0.5 * dpi); // near bottom
          ctx1.drawImage(logo, lx, ly, lw, lh);
        } else if (greetingBack === 'mirror') {
          const img = greetingFront.img;
          const scale = Math.min(cardW / img.width, cardH / img.height);
          const w = img.width * scale;
          const h = img.height * scale;
          ctx1.drawImage(img, marginX + (cardW - w) / 2, marginY + (cardH - h) / 2, w, h);
        }
        // else blank

        // Right half = FRONT COVER
        const frontImg = greetingFront.img;
        const fScale = Math.min(cardW / frontImg.width, cardH / frontImg.height);
        const fw = frontImg.width * fScale;
        const fh = frontImg.height * fScale;
        const fx = panelW + marginX + (cardW - fw) / 2;
        const fy = marginY + (cardH - fh) / 2;
        ctx1.drawImage(frontImg, fx, fy, fw, fh);

        // Fold line (center)
        if (document.getElementById('greetingCutLines').checked) {
          ctx1.strokeStyle = '#cccccc';
          ctx1.lineWidth = 1;
          ctx1.setLineDash([15, 10]);
          ctx1.beginPath();
          ctx1.moveTo(panelW, 0);
          ctx1.lineTo(panelW, pxH);
          ctx1.stroke();
          ctx1.setLineDash([]);
        }

        pdf.addImage(page1.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pageW, pageH);

        // ========== PAGE 2: INSIDE (Left blank, Right has message/image) ==========
        pdf.addPage('letter', 'landscape');

        const { canvas: page2, ctx: ctx2 } = Utils.createCanvas(pxW, pxH, '#ffffff');

        // Left half = INSIDE LEFT (blank)
        // Right half = INSIDE RIGHT (message or image)
        const message = document.getElementById('greetingMessage').value.trim();

        if (greetingInsideType === 'message' && message) {
          ctx2.fillStyle = '#333333';
          ctx2.font = '60px Georgia, serif';
          ctx2.textAlign = 'center';
          ctx2.textBaseline = 'middle';
          const lines = message.split('\n');
          const lineHeight = 80;
          const centerX = panelW + panelW / 2;
          const centerY = pxH / 2;
          const startY = centerY - (lines.length - 1) * lineHeight / 2;
          lines.forEach((line, i) => {
            ctx2.fillText(line, centerX, startY + i * lineHeight);
          });
        } else if (greetingInsideType === 'image' && greetingInside?.img) {
          const insideImg = greetingInside.img;
          const iScale = Math.min(cardW / insideImg.width, cardH / insideImg.height);
          const iw = insideImg.width * iScale;
          const ih = insideImg.height * iScale;
          const ix = panelW + marginX + (cardW - iw) / 2;
          const iy = marginY + (cardH - ih) / 2;
          ctx2.drawImage(insideImg, ix, iy, iw, ih);
        }

        // Fold line (center)
        if (document.getElementById('greetingCutLines').checked) {
          ctx2.strokeStyle = '#cccccc';
          ctx2.lineWidth = 1;
          ctx2.setLineDash([15, 10]);
          ctx2.beginPath();
          ctx2.moveTo(panelW, 0);
          ctx2.lineTo(panelW, pxH);
          ctx2.stroke();
          ctx2.setLineDash([]);
        }

        pdf.addImage(page2.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pageW, pageH);

        // Download
        const blob = pdf.output('blob');
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${greetingFront.name}_greeting_card.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        Utils.toast('2-page PDF ready! Print double-sided, flip on short edge.');
      } catch (e) {
        console.error('PDF error:', e);
        Utils.toast('Error: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚¨áÔ∏è Download Card PDF';
      }
    }


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: KIDS CARDS
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: KIDS CARD SHEETS
// ============================================
    // ============================================
    // KIDS CARD SHEET MAKER
    // ============================================
    let kidscardDesigns = [];
    let kidscardCanvases = [];
    let kidscardSize = '3.5x2.5';
    let kidscardPage = 'letter-p';
    let kidscardFill = 'tile';
    let kidscardFit = 'fill';
    let kidscardOrientation = 'portrait';
    let kidscardCurrentPage = 0;

    setupUploadZone('kidscardUpload', 'kidscardInput', async (files) => {
      for (const file of Array.from(files)) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const img = await loadImage(dataUrl);
        kidscardDesigns.push({ img, name: file.name, dataUrl });
      }
      renderKidscardThumbs();
      if (kidscardDesigns.length > 0) generateKidsCardSheet();
    });

    function renderKidscardThumbs() {
      const list = document.getElementById('kidscardDesignsList');
      const thumbs = document.getElementById('kidscardThumbs');
      const count = document.getElementById('kidscardCount');
      
      if (kidscardDesigns.length === 0) {
        list.style.display = 'none';
        document.getElementById('kidscardDownload').disabled = true;
        document.getElementById('kidscardClear').disabled = true;
        document.getElementById('kidscardInfo').textContent = '';
        return;
      }
      
      list.style.display = 'block';
      count.textContent = kidscardDesigns.length;
      document.getElementById('kidscardClear').disabled = false;
      thumbs.innerHTML = kidscardDesigns.map((d, i) => `
        <div style="position:relative;width:44px;height:44px;border-radius:4px;overflow:hidden;border:2px solid var(--border);">
          <img src="${d.dataUrl}" style="width:100%;height:100%;object-fit:cover;">
          <button onclick="removeKidscardDesign(${i})" style="position:absolute;top:-3px;right:-3px;width:16px;height:16px;border-radius:50%;background:#e74c3c;border:none;color:#fff;font-size:9px;cursor:pointer;line-height:1;">‚úï</button>
        </div>
      `).join('');
    }

    window.removeKidscardDesign = function(index) {
      kidscardDesigns.splice(index, 1);
      renderKidscardThumbs();
      if (kidscardDesigns.length > 0) generateKidsCardSheet();
      else {
        document.getElementById('kidscardPreview').innerHTML = '<div class="empty-state" style="color:#666;"><p>Upload card designs</p></div>';
        kidscardCanvases = [];
      }
    };

    function clearKidscard() {
      kidscardDesigns = [];
      kidscardCanvases = [];
      kidscardCurrentPage = 0;
      renderKidscardThumbs();
      document.getElementById('kidscardPreview').innerHTML = '<div class="empty-state" style="color:#666;"><p>Upload card designs</p></div>';
      document.getElementById('kidscardInfo').textContent = '';
      document.getElementById('kidscardPageNav').style.display = 'none';
      document.getElementById('kidscardClear').disabled = true;
      document.getElementById('kidscardDownload').disabled = true;
    }

    document.getElementById('kidscardClearAll').onclick = clearKidscard;
    document.getElementById('kidscardClear').onclick = clearKidscard;

    document.querySelectorAll('#panel-kidscard [data-kidsize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-kidscard [data-kidsize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        kidscardSize = btn.dataset.kidsize;
        if (kidscardDesigns.length > 0) generateKidsCardSheet();
      };
    });

    document.querySelectorAll('#panel-kidscard [data-kidpage]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-kidscard [data-kidpage]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        kidscardPage = btn.dataset.kidpage;
        if (kidscardDesigns.length > 0) generateKidsCardSheet();
      };
    });

    document.querySelectorAll('#panel-kidscard [data-kidfill]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-kidscard [data-kidfill]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        kidscardFill = btn.dataset.kidfill;
        if (kidscardDesigns.length > 0) generateKidsCardSheet();
      };
    });

    document.querySelectorAll('#panel-kidscard [data-kidfit]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-kidscard [data-kidfit]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        kidscardFit = btn.dataset.kidfit;
        if (kidscardDesigns.length > 0) generateKidsCardSheet();
      };
    });

    document.getElementById('kidscardCutLines').onchange = () => { if (kidscardDesigns.length > 0) generateKidsCardSheet(); };
    document.getElementById('kidscardMultiPage').onchange = () => { if (kidscardDesigns.length > 0) generateKidsCardSheet(); };

    document.getElementById('kidscardPrevPage').onclick = () => {
      if (kidscardCurrentPage > 0) {
        kidscardCurrentPage--;
        updateKidscardPreview();
      }
    };

    document.getElementById('kidscardNextPage').onclick = () => {
      if (kidscardCurrentPage < kidscardCanvases.length - 1) {
        kidscardCurrentPage++;
        updateKidscardPreview();
      }
    };

    function updateKidscardPreview() {
      if (kidscardCanvases.length === 0) return;
      const preview = document.getElementById('kidscardPreview');
      preview.innerHTML = `<img src="${kidscardCanvases[kidscardCurrentPage].toDataURL('image/jpeg', 0.85)}" style="max-width:100%;max-height:450px;box-shadow:0 2px 12px rgba(0,0,0,0.15);">`;
      document.getElementById('kidscardPageNum').textContent = kidscardCurrentPage + 1;
    }

    function generateKidsCardSheet() {
      if (kidscardDesigns.length === 0) return;

      const dpi = 300;
      const showCutLines = document.getElementById('kidscardCutLines').checked;
      const multiPage = document.getElementById('kidscardMultiPage').checked;

      // Page dimensions
      const isLandscape = kidscardPage.includes('-l');
      const pageW = isLandscape ? 11 * dpi : 8.5 * dpi;
      const pageH = isLandscape ? 8.5 * dpi : 11 * dpi;

      // Card dimensions - parse from size string
      const [cw, ch] = kidscardSize.split('x').map(Number);
      const cardW = cw * dpi;
      const cardH = ch * dpi;

      // Calculate optimal grid - minimal margins
      const margin = 0.125 * dpi; // 1/8 inch margin
      const gap = 0; // No gap between cards for maximum density
      
      const cols = Math.floor((pageW - margin * 2) / cardW);
      const rows = Math.floor((pageH - margin * 2) / cardH);
      
      if (cols === 0 || rows === 0) {
        Utils.toast('Card too large for page', 'error');
        return;
      }

      // Center the grid exactly
      const gridW = cols * cardW;
      const gridH = rows * cardH;
      const startX = (pageW - gridW) / 2;
      const startY = (pageH - gridH) / 2;

      const cardsPerPage = rows * cols;
      kidscardOrientation = isLandscape ? 'landscape' : 'portrait';

      // Determine how many pages needed
      let totalPages = 1;
      let designQueue = [];
      
      if (multiPage) {
        // Use all designs, randomize, create enough pages
        // Shuffle all designs
        designQueue = [...kidscardDesigns].sort(() => Math.random() - 0.5);
        totalPages = Math.ceil(designQueue.length / cardsPerPage);
      }

      kidscardCanvases = [];

      for (let pageNum = 0; pageNum < totalPages; pageNum++) {
        const { canvas, ctx } = Utils.createCanvas(pageW, pageH, '#ffffff');

        // Build card order for this page
        let cardOrder = [];
        
        if (multiPage) {
          // For multi-page: use sequential designs from shuffled queue
          for (let i = 0; i < cardsPerPage; i++) {
            const designIdx = pageNum * cardsPerPage + i;
            if (designIdx < designQueue.length) {
              cardOrder.push(kidscardDesigns.indexOf(designQueue[designIdx]));
            } else {
              // Fill remaining slots with random designs
              cardOrder.push(Math.floor(Math.random() * kidscardDesigns.length));
            }
          }
        } else {
          // Single page mode
          if (kidscardFill === 'tile' || kidscardFill === 'rotate') {
            for (let i = 0; i < cardsPerPage; i++) {
              cardOrder.push(i % kidscardDesigns.length);
            }
          } else { // random
            for (let i = 0; i < cardsPerPage; i++) {
              cardOrder.push(Math.floor(Math.random() * kidscardDesigns.length));
            }
          }
        }

        // Draw cards
        let idx = 0;
        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const x = startX + col * cardW;
            const y = startY + row * cardH;
            const design = kidscardDesigns[cardOrder[idx]];

            // Draw card background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x, y, cardW, cardH);

            // Draw image based on fit mode
            if (kidscardFit === 'stretch') {
              ctx.drawImage(design.img, x, y, cardW, cardH);
            } else if (kidscardFit === 'fill') {
              const scale = Math.max(cardW / design.img.width, cardH / design.img.height);
              const drawW = design.img.width * scale;
              const drawH = design.img.height * scale;
              const drawX = x + (cardW - drawW) / 2;
              const drawY = y + (cardH - drawH) / 2;
              ctx.save();
              ctx.beginPath();
              ctx.rect(x, y, cardW, cardH);
              ctx.clip();
              ctx.drawImage(design.img, drawX, drawY, drawW, drawH);
              ctx.restore();
            } else {
              const scale = Math.min(cardW / design.img.width, cardH / design.img.height);
              const drawW = design.img.width * scale;
              const drawH = design.img.height * scale;
              const drawX = x + (cardW - drawW) / 2;
              const drawY = y + (cardH - drawH) / 2;
              ctx.drawImage(design.img, drawX, drawY, drawW, drawH);
            }

            // Draw cut lines
            if (showCutLines) {
              ctx.strokeStyle = '#888888';
              ctx.lineWidth = 1;
              ctx.setLineDash([]);
              ctx.strokeRect(x, y, cardW, cardH);
            }

            idx++;
          }
        }

        // Draw outer crop marks
        if (showCutLines) {
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 0.5;
          ctx.setLineDash([]);
          const markLen = 0.125 * dpi;
          
          ctx.beginPath();
          ctx.moveTo(startX - markLen, startY);
          ctx.lineTo(startX - 2, startY);
          ctx.moveTo(startX, startY - markLen);
          ctx.lineTo(startX, startY - 2);
          ctx.moveTo(startX + gridW + 2, startY);
          ctx.lineTo(startX + gridW + markLen, startY);
          ctx.moveTo(startX + gridW, startY - markLen);
          ctx.lineTo(startX + gridW, startY - 2);
          ctx.moveTo(startX - markLen, startY + gridH);
          ctx.lineTo(startX - 2, startY + gridH);
          ctx.moveTo(startX, startY + gridH + 2);
          ctx.lineTo(startX, startY + gridH + markLen);
          ctx.moveTo(startX + gridW + 2, startY + gridH);
          ctx.lineTo(startX + gridW + markLen, startY + gridH);
          ctx.moveTo(startX + gridW, startY + gridH + 2);
          ctx.lineTo(startX + gridW, startY + gridH + markLen);
          ctx.stroke();
        }

        kidscardCanvases.push(canvas);
      }

      // Show/hide page navigation
      const pageNav = document.getElementById('kidscardPageNav');
      if (totalPages > 1) {
        pageNav.style.display = 'inline';
        document.getElementById('kidscardTotalPages').textContent = totalPages;
      } else {
        pageNav.style.display = 'none';
      }

      kidscardCurrentPage = 0;
      updateKidscardPreview();

      // Info
      document.getElementById('kidscardInfo').innerHTML = multiPage 
        ? `<strong>${totalPages} pages</strong> ‚Ä¢ ${cardsPerPage} cards/page ‚Ä¢ ${cw}√ó${ch}" each`
        : `<strong>${cardsPerPage} cards</strong> per page (${cols}√ó${rows}) ‚Ä¢ ${cw}√ó${ch}" each`;
      document.getElementById('kidscardDownload').disabled = false;
    }

    document.getElementById('kidscardDownload').onclick = async () => {
      if (kidscardCanvases.length === 0) return;

      const btn = document.getElementById('kidscardDownload');
      btn.disabled = true;
      btn.textContent = '‚è≥ Creating...';

      try {
        const { jsPDF } = window.jspdf;
        const isLandscape = kidscardOrientation === 'landscape';
        const w = isLandscape ? 11 : 8.5;
        const h = isLandscape ? 8.5 : 11;

        const pdf = new jsPDF({ 
          orientation: kidscardOrientation, 
          unit: 'in', 
          format: 'letter' 
        });
        
        for (let i = 0; i < kidscardCanvases.length; i++) {
          if (i > 0) pdf.addPage();
          const imgData = kidscardCanvases[i].toDataURL('image/jpeg', 0.95);
          pdf.addImage(imgData, 'JPEG', 0, 0, w, h);
        }

        const blob = pdf.output('blob');
        const pageLabel = kidscardCanvases.length > 1 ? `${kidscardCanvases.length}pages` : kidscardOrientation;
        downloadBlob(blob, `kids-cards-${kidscardSize}-${pageLabel}.pdf`);
        Utils.toast(`Downloaded ${kidscardCanvases.length} page PDF!`);
      } catch (e) {
        console.error(e);
        Utils.toast('Error creating PDF', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚¨áÔ∏è Download PDF';
      }
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: INVITATIONS
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: INVITATIONS GENERATOR
// ============================================
    // ============================================
    // INVITATION MAKER
    // ============================================
    let invitationDesign = null;
    let invitationCanvas = null;
    let invitationSize = '5x7';
    let invitationCount = 2;

    setupUploadZone('invitationUpload', 'invitationInput', async (files) => {
      const file = files[0];
      if (!file?.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      invitationDesign = await loadImage(dataUrl);
      document.getElementById('invitationGenerate').disabled = false;
      Utils.toast('Invitation loaded!');
      generateInvitationSheet();
    });

    document.querySelectorAll('#panel-invitation [data-invsize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-invitation [data-invsize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        invitationSize = btn.dataset.invsize;
        if (invitationDesign) generateInvitationSheet();
      };
    });

    document.querySelectorAll('#panel-invitation [data-invcount]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-invitation [data-invcount]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        invitationCount = parseInt(btn.dataset.invcount);
        if (invitationDesign) generateInvitationSheet();
      };
    });

    document.getElementById('invitationGenerate').onclick = generateInvitationSheet;

    function generateInvitationSheet() {
      if (!invitationDesign) return;

      const dpi = 300;
      const pageSize = document.getElementById('invitationPage').value;
      const showTrimMarks = document.getElementById('invitationCutLines').checked;

      // Page dimensions
      const pageSizes = {
        'letter': { w: 8.5 * dpi, h: 11 * dpi },
        'a4': { w: 8.27 * dpi, h: 11.69 * dpi },
        'legal': { w: 8.5 * dpi, h: 14 * dpi }
      };
      const pageW = pageSizes[pageSize].w;
      const pageH = pageSizes[pageSize].h;

      // Invitation dimensions
      const invSizes = {
        '5x7': { w: 5 * dpi, h: 7 * dpi },
        '4x6': { w: 4 * dpi, h: 6 * dpi },
        '4x9': { w: 4 * dpi, h: 9 * dpi },
        '5x5': { w: 5 * dpi, h: 5 * dpi }
      };
      const invW = invSizes[invitationSize].w;
      const invH = invSizes[invitationSize].h;

      const { canvas, ctx } = Utils.createCanvas(pageW, pageH, '#ffffff');

      // Layout based on count
      let positions = [];
      if (invitationCount === 1) {
        positions = [{ x: (pageW - invW) / 2, y: (pageH - invH) / 2 }];
      } else if (invitationCount === 2) {
        const gap = 0.25 * dpi;
        positions = [
          { x: (pageW - invW) / 2, y: (pageH - invH * 2 - gap) / 2 },
          { x: (pageW - invW) / 2, y: (pageH - invH * 2 - gap) / 2 + invH + gap }
        ];
      } else if (invitationCount === 4) {
        const gap = 0.25 * dpi;
        positions = [
          { x: (pageW - invW * 2 - gap) / 2, y: (pageH - invH * 2 - gap) / 2 },
          { x: (pageW - invW * 2 - gap) / 2 + invW + gap, y: (pageH - invH * 2 - gap) / 2 },
          { x: (pageW - invW * 2 - gap) / 2, y: (pageH - invH * 2 - gap) / 2 + invH + gap },
          { x: (pageW - invW * 2 - gap) / 2 + invW + gap, y: (pageH - invH * 2 - gap) / 2 + invH + gap }
        ];
      }

      // Draw invitations
      positions.forEach(pos => {
        ctx.drawImage(invitationDesign, pos.x, pos.y, invW, invH);

        if (showTrimMarks) {
          ctx.strokeStyle = '#999';
          ctx.lineWidth = 1;
          const markLen = 15;
          // Corner marks
          [[0,0], [invW,0], [0,invH], [invW,invH]].forEach(([ox, oy]) => {
            const x = pos.x + ox;
            const y = pos.y + oy;
            ctx.beginPath();
            ctx.moveTo(x - (ox === 0 ? markLen : -markLen), y);
            ctx.lineTo(x + (ox === 0 ? -5 : 5), y);
            ctx.moveTo(x, y - (oy === 0 ? markLen : -markLen));
            ctx.lineTo(x, y + (oy === 0 ? -5 : 5));
            ctx.stroke();
          });
        }
      });

      invitationCanvas = canvas;

      const preview = document.getElementById('invitationPreview');
      preview.innerHTML = `<img src="${canvas.toDataURL('image/jpeg', 0.7)}" style="max-width:100%;max-height:450px;">`;

      document.getElementById('invitationDownload').disabled = false;
    }

    document.getElementById('invitationDownload').onclick = async () => {
      if (!invitationCanvas) return;

      const { jsPDF } = window.jspdf;
      const pageSize = document.getElementById('invitationPage').value;

      const pdf = new jsPDF({ orientation: 'portrait', unit: 'in', format: pageSize });
      const imgData = invitationCanvas.toDataURL('image/jpeg', 0.95);

      const sizes = { letter: [8.5, 11], a4: [8.27, 11.69], legal: [8.5, 14] };
      const [w, h] = sizes[pageSize];

      pdf.addImage(imgData, 'JPEG', 0, 0, w, h);

      const blob = pdf.output('blob');
      downloadBlob(blob, 'invitation-sheet.pdf');
      Utils.toast('Downloaded invitation sheet!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: JOURNAL BUILDER
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: JOURNAL PAGE BUILDER
// ============================================
    // ============================================
    // JOURNAL/PLANNER PAGE MAKER
    // ============================================
    let journalCanvas = null;
    let journalBgImg = null;
    let journalSize = 'letter';

    setupUploadZone('journalBgUpload', 'journalBgInput', async (files) => {
      const file = files[0];
      if (!file?.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      journalBgImg = await loadImage(dataUrl);
      document.getElementById('journalBgOpacityWrap').style.display = 'block';
      document.querySelector('#journalBgUpload .upload-text').textContent = '‚úÖ Image loaded';
      Utils.toast('Background loaded!');
    });

    function clearJournalBg() {
      journalBgImg = null;
      document.getElementById('journalBgOpacityWrap').style.display = 'none';
      document.querySelector('#journalBgUpload .upload-text').textContent = 'Drop decorative background';
      Utils.toast('Background removed');
    }

    document.querySelectorAll('#panel-journal [data-journalsize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-journal [data-journalsize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        journalSize = btn.dataset.journalsize;
      };
    });

    document.getElementById('journalSpacing').oninput = (e) => {
      const labels = ['Narrow', 'Medium', 'Wide'];
      document.getElementById('journalSpacingVal').textContent = labels[e.target.value - 1];
    };

    document.getElementById('journalDarkness').oninput = (e) => {
      document.getElementById('journalDarknessVal').textContent = e.target.value + '%';
    };

    document.getElementById('journalBgOpacity').oninput = (e) => {
      document.getElementById('journalBgOpacityVal').textContent = e.target.value + '%';
    };

    document.getElementById('journalGenerate').onclick = generateJournalPage;

    function generateJournalPage() {
      const dpi = 300;
      const type = document.getElementById('journalType').value;
      const spacingLevel = parseInt(document.getElementById('journalSpacing').value);
      const baseColor = document.getElementById('journalLineColor').value;
      const darkness = parseInt(document.getElementById('journalDarkness').value) / 100;
      const showHeader = document.getElementById('journalHeader').checked;
      const bgOpacity = parseInt(document.getElementById('journalBgOpacity').value) / 100;

      // Calculate line color based on darkness
      const hexToRgb = (hex) => {
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        return {r, g, b};
      };
      const rgb = hexToRgb(baseColor);
      // Blend with white based on darkness (0 = very light, 1 = full color)
      const blend = (c) => Math.round(255 - (255 - c) * darkness);
      const lineColor = `rgb(${blend(rgb.r)}, ${blend(rgb.g)}, ${blend(rgb.b)})`;

      // Page dimensions
      const pageSizes = {
        'letter': { w: 8.5 * dpi, h: 11 * dpi },
        'a4': { w: 8.27 * dpi, h: 11.69 * dpi },
        'a5': { w: 5.83 * dpi, h: 8.27 * dpi },
        'half': { w: 5.5 * dpi, h: 8.5 * dpi }
      };
      const pageW = pageSizes[journalSize].w;
      const pageH = pageSizes[journalSize].h;

      const { canvas, ctx } = Utils.createCanvas(pageW, pageH, '#ffffff');

      // Draw background image FIRST if provided
      if (journalBgImg) {
        ctx.globalAlpha = bgOpacity;
        ctx.drawImage(journalBgImg, 0, 0, pageW, pageH);
        ctx.globalAlpha = 1;
      }

      const margin = 0.5 * dpi;
      const headerH = showHeader ? 0.75 * dpi : 0;
      const contentTop = margin + headerH;
      const lineSpacing = [20, 28, 36][spacingLevel - 1];

      ctx.strokeStyle = lineColor;
      ctx.fillStyle = lineColor;
      ctx.lineWidth = 1;

      // Draw based on type
      if (type === 'lined') {
        for (let y = contentTop; y < pageH - margin; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }
      } else if (type === 'blank') {
        // Just a blank page with border
        ctx.strokeStyle = lineColor;
        ctx.strokeRect(margin, contentTop, pageW - margin * 2, pageH - contentTop - margin);
      } else if (type === 'dotgrid') {
        const dotSpacing = lineSpacing;
        for (let y = contentTop; y < pageH - margin; y += dotSpacing) {
          for (let x = margin; x < pageW - margin; x += dotSpacing) {
            ctx.beginPath();
            ctx.arc(x, y, 1.5, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      } else if (type === 'graph') {
        const gridSize = lineSpacing;
        for (let y = contentTop; y < pageH - margin; y += gridSize) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }
        for (let x = margin; x < pageW - margin; x += gridSize) {
          ctx.beginPath();
          ctx.moveTo(x, contentTop);
          ctx.lineTo(x, pageH - margin);
          ctx.stroke();
        }
      } else if (type === 'cornell') {
        const cueCol = 2 * dpi; // Left column width
        const summaryH = 1.5 * dpi; // Bottom summary height

        // Main vertical divider
        ctx.beginPath();
        ctx.moveTo(margin + cueCol, contentTop);
        ctx.lineTo(margin + cueCol, pageH - margin - summaryH);
        ctx.stroke();

        // Horizontal line for summary section
        ctx.beginPath();
        ctx.moveTo(margin, pageH - margin - summaryH);
        ctx.lineTo(pageW - margin, pageH - margin - summaryH);
        ctx.stroke();

        // Lines in CUE column (left)
        for (let y = contentTop + lineSpacing; y < pageH - margin - summaryH; y += lineSpacing * 2) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(margin + cueCol - 10, y);
          ctx.stroke();
        }

        // Lines in NOTES column (right)
        for (let y = contentTop + lineSpacing; y < pageH - margin - summaryH; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin + cueCol + 10, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

        // Lines in SUMMARY section (bottom)
        for (let y = pageH - margin - summaryH + lineSpacing; y < pageH - margin; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

        // Labels
        ctx.fillStyle = '#999';
        ctx.font = '10px Georgia, serif';
        ctx.fillText('CUE COLUMN', margin + 5, contentTop + 15);
        ctx.fillText('NOTES', margin + cueCol + 15, contentTop + 15);
        ctx.fillText('SUMMARY', margin + 5, pageH - margin - summaryH + 15);

      } else if (type === 'weekly') {
        // Weekly spread - 7 day columns
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const colWidth = (pageW - margin * 2) / 7;
        const headerHeight = 40;

        ctx.font = 'bold 12px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.strokeStyle = lineColor;

        // Draw week header
        ctx.font = 'bold 16px Georgia, serif';
        ctx.textAlign = 'center';
        ctx.fillText('Week of: _________________', pageW / 2, contentTop + 20);
        ctx.textAlign = 'left';
        ctx.font = 'bold 11px Georgia, serif';

        const gridTop = contentTop + 50;
        const gridHeight = pageH - margin - gridTop;

        // Draw day columns
        days.forEach((day, i) => {
          const x = margin + i * colWidth;

          // Day header
          ctx.fillStyle = '#333';
          ctx.fillText(day, x + 5, gridTop + 15);

          // Vertical line
          if (i > 0) {
            ctx.beginPath();
            ctx.moveTo(x, gridTop);
            ctx.lineTo(x, gridTop + gridHeight);
            ctx.stroke();
          }

          // Horizontal lines in each column
          ctx.strokeStyle = lineColor;
          for (let y = gridTop + headerHeight; y < gridTop + gridHeight; y += lineSpacing) {
            ctx.beginPath();
            ctx.moveTo(x + 2, y);
            ctx.lineTo(x + colWidth - 2, y);
            ctx.stroke();
          }
        });

        // Border around grid
        ctx.strokeStyle = lineColor;
        ctx.strokeRect(margin, gridTop, pageW - margin * 2, gridHeight);

        // Header line under day names
        ctx.beginPath();
        ctx.moveTo(margin, gridTop + headerHeight - 10);
        ctx.lineTo(pageW - margin, gridTop + headerHeight - 10);
        ctx.stroke();

      } else if (type === 'monthly') {
        // Monthly calendar grid
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const cols = 7;
        const rows = 6; // 6 weeks max
        const cellWidth = (pageW - margin * 2) / cols;
        const headerHeight = 50;
        const cellHeight = (pageH - margin - contentTop - headerHeight - 60) / rows;

        ctx.font = 'bold 18px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.fillText('Month: _________________  Year: _______', pageW / 2, contentTop + 25);

        const gridTop = contentTop + headerHeight;

        // Day headers
        ctx.font = 'bold 12px Georgia, serif';
        days.forEach((day, i) => {
          const x = margin + i * cellWidth + cellWidth / 2;
          ctx.fillText(day, x, gridTop + 20);
        });

        // Grid lines
        ctx.strokeStyle = lineColor;
        ctx.textAlign = 'left';
        ctx.font = '14px Georgia, serif';

        const calTop = gridTop + 35;

        // Draw grid
        for (let row = 0; row <= rows; row++) {
          const y = calTop + row * cellHeight;
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

        for (let col = 0; col <= cols; col++) {
          const x = margin + col * cellWidth;
          ctx.beginPath();
          ctx.moveTo(x, calTop);
          ctx.lineTo(x, calTop + rows * cellHeight);
          ctx.stroke();
        }

        // Add date numbers (1-31 placeholder positions)
        ctx.fillStyle = '#999';
        ctx.font = '12px Georgia, serif';
        let date = 1;
        for (let row = 0; row < rows && date <= 31; row++) {
          for (let col = 0; col < cols && date <= 31; col++) {
            const x = margin + col * cellWidth + 8;
            const y = calTop + row * cellHeight + 18;
            ctx.fillText(date.toString(), x, y);
            date++;
          }
        }

        // Notes section at bottom
        ctx.fillStyle = '#333';
        ctx.font = 'bold 12px Georgia, serif';
        const notesY = calTop + rows * cellHeight + 20;
        ctx.fillText('Notes:', margin, notesY);
        ctx.strokeStyle = lineColor;
        for (let y = notesY + 15; y < pageH - margin; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

      } else if (type === 'daily') {
        const availHeight = pageH - contentTop - margin;

        ctx.font = 'bold 14px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.fillText('DATE: _______________', margin, contentTop + 25);

        // Top priorities section
        ctx.fillText('TOP 3 PRIORITIES', margin, contentTop + 65);
        ctx.font = '12px Georgia, serif';
        for (let i = 0; i < 3; i++) {
          const y = contentTop + 90 + i * 28;
          ctx.fillText(`${i + 1}.`, margin, y);
          ctx.beginPath();
          ctx.moveTo(margin + 20, y + 3);
          ctx.lineTo(pageW / 2 - 20, y + 3);
          ctx.stroke();
        }

        // To-do section (right side)
        ctx.font = 'bold 14px Georgia, serif';
        ctx.fillText('TO-DO', pageW / 2 + 20, contentTop + 65);
        ctx.font = '12px Georgia, serif';
        for (let i = 0; i < 6; i++) {
          const y = contentTop + 90 + i * 25;
          ctx.strokeRect(pageW / 2 + 20, y - 10, 12, 12);
          ctx.beginPath();
          ctx.moveTo(pageW / 2 + 40, y + 3);
          ctx.lineTo(pageW - margin, y + 3);
          ctx.stroke();
        }

        // Schedule section
        ctx.font = 'bold 14px Georgia, serif';
        ctx.fillText('SCHEDULE', margin, contentTop + 200);
        ctx.font = '11px Georgia, serif';
        const times = ['6 AM', '7 AM', '8 AM', '9 AM', '10 AM', '11 AM', '12 PM', '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM', '8 PM', '9 PM'];
        const scheduleStart = contentTop + 225;
        const timeSlotHeight = (availHeight - 280) / times.length;

        times.forEach((t, i) => {
          const y = scheduleStart + i * timeSlotHeight;
          ctx.fillStyle = '#333';
          ctx.fillText(t, margin, y + 12);
          ctx.strokeStyle = lineColor;
          ctx.beginPath();
          ctx.moveTo(margin + 45, y + timeSlotHeight);
          ctx.lineTo(pageW - margin, y + timeSlotHeight);
          ctx.stroke();
        });

        // Notes section at bottom
        ctx.fillStyle = '#333';
        ctx.font = 'bold 14px Georgia, serif';
        const notesStart = pageH - margin - 100;
        ctx.fillText('NOTES', margin, notesStart);
        ctx.strokeStyle = lineColor;
        for (let y = notesStart + 20; y < pageH - margin; y += lineSpacing) {
          ctx.beginPath();
          ctx.moveTo(margin, y);
          ctx.lineTo(pageW - margin, y);
          ctx.stroke();
        }

      } else if (type === 'habit') {
        ctx.font = 'bold 18px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.fillText('HABIT TRACKER', pageW / 2, contentTop + 30);
        ctx.textAlign = 'left';

        // Week label
        ctx.font = '12px Georgia, serif';
        ctx.fillText('Week of: _________________', margin, contentTop + 60);

        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const boxSize = Math.min(30, (pageW - margin * 2 - 180) / 7 - 5);
        const startX = margin + 180;
        const rowHeight = boxSize + 12;
        const maxHabits = Math.floor((pageH - contentTop - 120 - margin) / rowHeight);

        ctx.strokeStyle = lineColor;

        // Header row with days
        ctx.font = 'bold 11px Georgia, serif';
        days.forEach((d, i) => {
          ctx.fillText(d, startX + i * (boxSize + 5), contentTop + 90);
        });

        // Habit rows
        ctx.font = '12px Georgia, serif';
        for (let row = 0; row < maxHabits; row++) {
          const y = contentTop + 110 + row * rowHeight;

          // Habit name line
          ctx.beginPath();
          ctx.moveTo(margin, y + boxSize - 5);
          ctx.lineTo(margin + 165, y + boxSize - 5);
          ctx.stroke();

          // Checkbox for each day
          days.forEach((d, i) => {
            ctx.strokeRect(startX + i * (boxSize + 5), y, boxSize, boxSize);
          });
        }

      } else if (type === 'gratitude') {
        ctx.font = 'bold 20px Georgia, serif';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.fillText('Today I am grateful for...', pageW / 2, contentTop + 40);
        ctx.textAlign = 'left';

        ctx.font = '12px Georgia, serif';
        ctx.fillText('Date: _______________', margin, contentTop + 70);

        // Calculate how many items fit
        const itemHeight = 60;
        const availSpace = pageH - contentTop - 100 - margin;
        const numItems = Math.floor(availSpace / itemHeight);

        ctx.font = '14px Georgia, serif';
        ctx.strokeStyle = lineColor;

        for (let i = 0; i < numItems; i++) {
          const y = contentTop + 110 + i * itemHeight;
          ctx.fillStyle = '#333';
          ctx.fillText(`${i + 1}.`, margin, y + 5);

          // Two lines per item for writing
          ctx.beginPath();
          ctx.moveTo(margin + 25, y + 8);
          ctx.lineTo(pageW - margin, y + 8);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(margin + 25, y + 35);
          ctx.lineTo(pageW - margin, y + 35);
          ctx.stroke();
        }
      }

      // Draw header area
      if (showHeader && type !== 'daily' && type !== 'habit' && type !== 'gratitude') {
        ctx.strokeStyle = lineColor;
        ctx.beginPath();
        ctx.moveTo(margin, contentTop - 10);
        ctx.lineTo(pageW - margin, contentTop - 10);
        ctx.stroke();
      }

      journalCanvas = canvas;

      const preview = document.getElementById('journalPreview');
      preview.innerHTML = `<img src="${canvas.toDataURL('image/jpeg', 0.8)}" style="max-width:100%;max-height:500px;">`;

      document.getElementById('journalDownload').disabled = false;
      Utils.toast('Journal page generated!');
    }

    document.getElementById('journalDownload').onclick = async () => {
      if (!journalCanvas) return;

      const { jsPDF } = window.jspdf;
      const format = journalSize === 'half' ? [5.5, 8.5] : journalSize;

      const pdf = new jsPDF({ orientation: 'portrait', unit: 'in', format });
      const imgData = journalCanvas.toDataURL('image/jpeg', 0.95);

      const sizes = {
        'letter': [8.5, 11],
        'a4': [8.27, 11.69],
        'a5': [5.83, 8.27],
        'half': [5.5, 8.5]
      };
      const [w, h] = sizes[journalSize];

      pdf.addImage(imgData, 'JPEG', 0, 0, w, h);

      const blob = pdf.output('blob');
      const type = document.getElementById('journalType').value;
      downloadBlob(blob, `${type}-page.pdf`);
      Utils.toast('Downloaded journal page!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: STICKER SHEET
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: STICKER SHEET BUILDER
// ============================================
    // ============================================
    // STICKER SHEET
    // ============================================
    let stickerFiles = [];

    setupUploadZone('stickerUpload', 'stickerInput', async (fileList) => {
      const files = Array.from(fileList);
      const statusEl = document.getElementById('stickerCount');
      statusEl.textContent = `(loading ${files.length} files...)`;

      let added = 0;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.startsWith('image/')) continue;
        try {
          statusEl.textContent = `(loading ${i + 1}/${files.length}...)`;
          const dataUrl = await readFileAsDataURL(file);
          const img = await loadImage(dataUrl);
          stickerFiles.push({ img, name: Utils.getBaseName(file.name), dataUrl });
          added++;
        } catch (err) {
          console.error('Failed to load sticker:', file.name, err);
        }
      }
      renderStickerSheet();
      if (added > 0) Utils.toast(`Added ${added} stickers!`);
    });

    document.querySelectorAll('#panel-sticker [data-size]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-sticker [data-size]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderStickerSheet();
      };
    });

    document.getElementById('stickerSheetSize').onchange = renderStickerSheet;
    document.getElementById('stickerCutLines').onchange = renderStickerSheet;

    function renderStickerSheet() {
      const preview = document.getElementById('stickerPreview');
      if (stickerFiles.length === 0) {
        preview.innerHTML = '<div class="empty-state" style="color:#666;"><p>Add stickers to arrange on sheet</p></div>';
        document.getElementById('stickerDownload').disabled = true;
        document.getElementById('stickerCount').textContent = '(0 stickers)';
        return;
      }

      const sheetSize = document.getElementById('stickerSheetSize').value;
      const stickerInch = parseFloat(document.querySelector('#panel-sticker [data-size].active')?.dataset.size || 1);
      const showCutLines = document.getElementById('stickerCutLines').checked;

      const sizes = { letter: [8.5, 11], a4: [8.27, 11.69], '4x6': [4, 6] };
      const [wInch, hInch] = sizes[sheetSize] || sizes.letter;
      const dpi = 300;
      const w = Math.round(wInch * dpi), h = Math.round(hInch * dpi);
      const stickerPx = Math.round(stickerInch * dpi);
      const padding = Math.round(0.25 * dpi);

      const { canvas, ctx } = Utils.createCanvas(w, h, '#ffffff');

      const cols = Math.floor((w - padding * 2) / (stickerPx + padding/2));
      const rows = Math.floor((h - padding * 2) / (stickerPx + padding/2));
      const maxStickers = cols * rows;

      let idx = 0;
      for (let row = 0; row < rows && idx < stickerFiles.length; row++) {
        for (let col = 0; col < cols && idx < stickerFiles.length; col++) {
          const x = padding + col * (stickerPx + padding/2);
          const y = padding + row * (stickerPx + padding/2);
          const sticker = stickerFiles[idx].img;

          const scale = Math.min(stickerPx / sticker.width, stickerPx / sticker.height);
          const sw = sticker.width * scale, sh = sticker.height * scale;
          const sx = x + (stickerPx - sw) / 2, sy = y + (stickerPx - sh) / 2;

          ctx.drawImage(sticker, sx, sy, sw, sh);

          if (showCutLines) {
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(x, y, stickerPx, stickerPx);
            ctx.setLineDash([]);
          }
          idx++;
        }
      }

      window.stickerCanvas = canvas;
      window.stickerFullDataUrl = canvas.toDataURL('image/png', 0.9);
      const sheetsNeeded = Math.ceil(stickerFiles.length / maxStickers);
      const overflow = stickerFiles.length > maxStickers ? `<div style="color:var(--accent-orange);font-size:12px;margin-top:8px;">‚ö†Ô∏è ${stickerFiles.length - maxStickers} stickers overflow - need ${sheetsNeeded} sheets</div>` : '';

      preview.innerHTML = `
        <div style="text-align:center;">
          <img src="${canvas.toDataURL('image/jpeg', 0.5)}" style="max-width:100%;max-height:450px;box-shadow:0 4px 20px rgba(0,0,0,0.2);cursor:zoom-in;" class="preview-thumb" id="stickerPreviewImg">
          <div style="margin-top:8px;font-size:12px;color:var(--text-muted);">Click to enlarge ‚Ä¢ ${cols}√ó${rows} grid (${maxStickers} per sheet)</div>
          ${overflow}
          <button class="btn btn-secondary" style="margin-top:12px;" onclick="stickerFiles=[];renderStickerSheet();">üóëÔ∏è Clear All Stickers</button>
        </div>
      `;

      document.getElementById('stickerPreviewImg').onclick = () => {
        openLightbox(window.stickerFullDataUrl, 0, 'Sticker Sheet Preview');
      };

      document.getElementById('stickerCount').textContent = `(${stickerFiles.length} stickers)`;
      document.getElementById('stickerDownload').disabled = false;
    }

    document.getElementById('stickerDownload').onclick = async () => {
      if (!window.stickerCanvas) return;
      const blob = await Utils.canvasToBlob(window.stickerCanvas, 'image/png');
      downloadBlob(blob, 'sticker-sheet.png');
      Utils.toast('Sticker sheet downloaded!');
    };

    // ============================================
    // STICKER SHEET - Cut Style
    // ============================================
    let stickerCutStyle = 'kiss';

    document.querySelectorAll('#panel-sticker [data-cutstyle]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-sticker [data-cutstyle]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        stickerCutStyle = btn.dataset.cutstyle;
        renderStickerSheet();
      };
    });

    // Track recent files on upload
    const originalSetupUploadZone = setupUploadZone;
    // Note: File tracking is handled within each upload handler


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: COLOR PALETTE
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: COLOR PALETTE GENERATOR
// ============================================
    // ============================================
    // COLOR PALETTE EXTRACTOR
    // ============================================
    let paletteColors = [];

    setupUploadZone('paletteUpload', 'paletteInput', async (files) => {
      if (!files[0]?.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(files[0]);
      const img = await loadImage(dataUrl);
      extractColors(img);
    });

    document.querySelectorAll('#panel-palette [data-colors]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-palette [data-colors]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      };
    });

    function extractColors(img) {
      const numColors = parseInt(document.querySelector('#panel-palette [data-colors].active')?.dataset.colors || 5);
      const { canvas, ctx } = Utils.createCanvas(100, 100);
      ctx.drawImage(img, 0, 0, 100, 100);
      const data = ctx.getImageData(0, 0, 100, 100).data;

      const colorCounts = {};
      for (let i = 0; i < data.length; i += 4) {
        const r = Math.round(data[i] / 32) * 32;
        const g = Math.round(data[i+1] / 32) * 32;
        const b = Math.round(data[i+2] / 32) * 32;
        const key = `${r},${g},${b}`;
        colorCounts[key] = (colorCounts[key] || 0) + 1;
      }

      paletteColors = Object.entries(colorCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, numColors)
        .map(([key]) => {
          const [r, g, b] = key.split(',').map(Number);
          return { r, g, b, hex: '#' + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join('') };
        });

      renderPalette();
    }

    function renderPalette() {
      const preview = document.getElementById('palettePreview');
      const swatches = document.getElementById('paletteSwatches');
      const colorsDiv = document.getElementById('paletteColors');

      if (paletteColors.length === 0) {
        preview.innerHTML = '<div class="empty-state"><p>Upload an image to extract colors</p></div>';
        colorsDiv.style.display = 'none';
        return;
      }

      preview.innerHTML = '';
      colorsDiv.style.display = 'block';
      swatches.innerHTML = paletteColors.map(c => `
        <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
          <div style="width:50px;height:50px;background:${c.hex};border-radius:8px;border:2px solid var(--border);cursor:pointer;" onclick="navigator.clipboard.writeText('${c.hex}');Utils.toast('Copied ${c.hex}');"></div>
          <span style="font-size:11px;font-family:monospace;">${c.hex}</span>
        </div>
      `).join('');

      state.stats.processed++;
      updateStats();
    }

    document.getElementById('paletteCopyHex').onclick = () => {
      navigator.clipboard.writeText(paletteColors.map(c => c.hex).join('\n'));
      Utils.toast('HEX colors copied!');
    };

    document.getElementById('paletteCopyRGB').onclick = () => {
      navigator.clipboard.writeText(paletteColors.map(c => `rgb(${c.r}, ${c.g}, ${c.b})`).join('\n'));
      Utils.toast('RGB colors copied!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: COLOR VARIANTS
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: COLOR VARIANTS
// ============================================
    // ============================================
    // COLOR VARIANT GENERATOR
    // ============================================
    let colorvariantImage = null;

    setupUploadZone('colorvariantUpload', 'colorvariantInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      const img = await loadImage(dataUrl);
      colorvariantImage = { name: Utils.getBaseName(file.name), img, dataUrl };
      document.getElementById('colorvariantGenerate').disabled = false;
      document.getElementById('colorvariantResults').innerHTML = `<img src="${dataUrl}" style="max-width:100%;border-radius:8px;">`;
    });

    document.getElementById('colorvariantGenerate').onclick = async () => {
      if (!colorvariantImage) return;

      const results = document.getElementById('colorvariantResults');
      results.innerHTML = '<div style="text-align:center;padding:20px;">Generating variants...</div>';

      const variants = [];
      const img = colorvariantImage.img;

      // Hue shifts
      document.querySelectorAll('#panel-colorvariant [data-hue]:checked').forEach(cb => {
        const hue = parseInt(cb.dataset.hue);
        const { canvas, ctx } = Utils.createCanvas(img.width, img.height);
        ctx.filter = hue === 0 ? 'none' : `hue-rotate(${hue}deg)`;
        ctx.drawImage(img, 0, 0);
        variants.push({ canvas, label: hue === 0 ? 'Original' : `Hue +${hue}¬∞` });
      });

      // Additional variants
      const variantFilters = {
        grayscale: 'grayscale(100%)',
        sepia: 'sepia(100%)',
        invert: 'invert(100%)',
        saturate: 'saturate(200%)'
      };

      document.querySelectorAll('#panel-colorvariant [data-variant]:checked').forEach(cb => {
        const variant = cb.dataset.variant;
        const { canvas, ctx } = Utils.createCanvas(img.width, img.height);
        ctx.filter = variantFilters[variant];
        ctx.drawImage(img, 0, 0);
        variants.push({ canvas, label: variant.charAt(0).toUpperCase() + variant.slice(1) });
      });

      if (variants.length === 0) {
        results.innerHTML = '<div class="empty-state"><p>Select at least one variant type</p></div>';
        return;
      }

      results.innerHTML = '<div class="image-grid">' + variants.map((v, i) => `
        <div class="image-card">
          <div class="image-card-preview"><img src="${v.canvas.toDataURL()}" alt="${v.label}"></div>
          <div style="text-align:center;padding:8px;font-size:12px;">${v.label}</div>
        </div>
      `).join('') + '</div>';

      // Auto-download as ZIP
      const files = variants.map(v => ({
        canvas: v.canvas,
        name: `${colorvariantImage.name}_${v.label.toLowerCase().replace(/[^a-z0-9]/g, '_')}.png`
      }));
      await Utils.downloadZip(files, `${colorvariantImage.name}_variants`);
      Utils.toast(`Generated ${variants.length} variants!`);
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: PHOTO COMPOSER
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: PHOTO COMPOSER
// ============================================
    // ============================================
    // PHOTO COMPOSER
    // ============================================
    let composerImages = [];
    let composerGrid = '2x2';

    setupUploadZone('composerUpload', 'composerInput', async (fileList) => {
      for (const file of Array.from(fileList)) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await readFileAsDataURL(file);
        const img = await loadImage(dataUrl);
        composerImages.push({ name: Utils.getBaseName(file.name), img, dataUrl });
      }
      renderComposerPreview();
      document.getElementById('composerDownload').disabled = composerImages.length < 2;
    });

    document.querySelectorAll('#panel-photocomposer [data-grid]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-photocomposer [data-grid]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        composerGrid = btn.dataset.grid;
        renderComposerPreview();
      };
    });

    document.getElementById('composerGap').oninput = (e) => {
      document.getElementById('composerGapVal').textContent = e.target.value;
      renderComposerPreview();
    };

    document.getElementById('composerBg').oninput = () => renderComposerPreview();

    document.getElementById('composerClear').onclick = () => {
      composerImages = [];
      document.getElementById('composerDownload').disabled = true;
      document.getElementById('composerPreview').innerHTML = '<div class="empty-state"><p>Upload images to preview grid</p></div>';
    };

    function renderComposerPreview() {
      const preview = document.getElementById('composerPreview');
      if (composerImages.length < 2) {
        preview.innerHTML = '<div class="empty-state"><p>Upload at least 2 images</p></div>';
        return;
      }

      const [cols, rows] = composerGrid.split('x').map(Number);
      const gap = parseInt(document.getElementById('composerGap').value);
      const bg = document.getElementById('composerBg').value;

      const cellSize = 150;
      const width = cols * cellSize + (cols - 1) * gap;
      const height = rows * cellSize + (rows - 1) * gap;

      const { canvas, ctx } = Utils.createCanvas(width, height, bg);

      for (let i = 0; i < Math.min(composerImages.length, cols * rows); i++) {
        const col = i % cols;
        const row = Math.floor(i / cols);
        const x = col * (cellSize + gap);
        const y = row * (cellSize + gap);

        const img = composerImages[i].img;
        const scale = Math.max(cellSize / img.width, cellSize / img.height);
        const w = img.width * scale;
        const h = img.height * scale;

        ctx.save();
        ctx.beginPath();
        ctx.rect(x, y, cellSize, cellSize);
        ctx.clip();
        ctx.drawImage(img, x + (cellSize - w) / 2, y + (cellSize - h) / 2, w, h);
        ctx.restore();
      }

      preview.innerHTML = `<img src="${canvas.toDataURL()}" style="max-width:100%;border-radius:8px;">`;
    }

    document.getElementById('composerDownload').onclick = async () => {
      if (composerImages.length < 2) return;

      const [cols, rows] = composerGrid.split('x').map(Number);
      const gap = parseInt(document.getElementById('composerGap').value) * 4;
      const bg = document.getElementById('composerBg').value;

      const cellSize = 600;
      const width = cols * cellSize + (cols - 1) * gap;
      const height = rows * cellSize + (rows - 1) * gap;

      const { canvas, ctx } = Utils.createCanvas(width, height, bg);

      for (let i = 0; i < Math.min(composerImages.length, cols * rows); i++) {
        const col = i % cols;
        const row = Math.floor(i / cols);
        const x = col * (cellSize + gap);
        const y = row * (cellSize + gap);

        const img = composerImages[i].img;
        const scale = Math.max(cellSize / img.width, cellSize / img.height);
        const w = img.width * scale;
        const h = img.height * scale;

        ctx.save();
        ctx.beginPath();
        ctx.rect(x, y, cellSize, cellSize);
        ctx.clip();
        ctx.drawImage(img, x + (cellSize - w) / 2, y + (cellSize - h) / 2, w, h);
        ctx.restore();
      }

      const blob = await Utils.canvasToBlob(canvas, 'image/jpeg', 0.95);
      downloadBlob(blob, `listing_grid_${composerGrid}.jpg`);
      Utils.toast('Grid image downloaded!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: SHOP BANNER
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: SHOP BANNER BUILDER
// ============================================
    // ============================================
    // SHOP BANNER MAKER
    // ============================================
    let bannerSize = 'big';
    let bannerBgType = 'color';
    let bannerTextPos = 'center';
    let bannerBgImg = null;
    let bannerLogoImg = null;

    const bannerSizes = {
      big: { width: 1200, height: 300 },
      mini: { width: 1200, height: 160 },
      mobile: { width: 1200, height: 180 }
    };

    // Banner size buttons
    document.querySelectorAll('#panel-banner [data-bannersize]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-banner [data-bannersize]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bannerSize = btn.dataset.bannersize;
        renderBannerPreview();
      };
    });

    // Background type buttons
    document.querySelectorAll('#panel-banner [data-bannerbg]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-banner [data-bannerbg]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bannerBgType = btn.dataset.bannerbg;
        document.getElementById('bannerBgColor').style.display = bannerBgType === 'color' ? 'block' : 'none';
        document.getElementById('bannerBgGradient').style.display = bannerBgType === 'gradient' ? 'block' : 'none';
        document.getElementById('bannerBgImage').style.display = bannerBgType === 'image' ? 'block' : 'none';
        renderBannerPreview();
      };
    });

    // Text position buttons
    document.querySelectorAll('#panel-banner [data-textpos]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('#panel-banner [data-textpos]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        bannerTextPos = btn.dataset.textpos;
        renderBannerPreview();
      };
    });

    // Background image upload
    setupUploadZone('bannerBgUpload', 'bannerBgInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      bannerBgImg = await loadImage(dataUrl);
      renderBannerPreview();
    });

    // Logo upload
    setupUploadZone('bannerLogoUpload', 'bannerLogoInput', async (fileList) => {
      const file = fileList[0];
      if (!file || !file.type.startsWith('image/')) return;
      const dataUrl = await readFileAsDataURL(file);
      bannerLogoImg = await loadImage(dataUrl);
      document.getElementById('bannerLogoPreview').style.display = 'block';
      document.getElementById('bannerLogoImg').src = dataUrl;
      renderBannerPreview();
    });

    window.clearBannerLogo = () => {
      bannerLogoImg = null;
      document.getElementById('bannerLogoPreview').style.display = 'none';
      renderBannerPreview();
    };

    // Live preview on input changes
    ['bannerShopName', 'bannerTagline', 'bannerFont', 'bannerTextColor', 'bannerColor1', 'bannerGrad1', 'bannerGrad2', 'bannerGradDir'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', renderBannerPreview);
    });

    document.getElementById('bannerPreviewBtn').onclick = renderBannerPreview;

    function renderBannerPreview() {
      const { width, height } = bannerSizes[bannerSize];
      const { canvas, ctx } = Utils.createCanvas(width, height);

      // Draw background
      if (bannerBgType === 'color') {
        ctx.fillStyle = document.getElementById('bannerColor1').value;
        ctx.fillRect(0, 0, width, height);
      } else if (bannerBgType === 'gradient') {
        const dir = document.getElementById('bannerGradDir').value;
        let grad;
        if (dir === 'to right') grad = ctx.createLinearGradient(0, 0, width, 0);
        else if (dir === 'to left') grad = ctx.createLinearGradient(width, 0, 0, 0);
        else if (dir === 'to bottom') grad = ctx.createLinearGradient(0, 0, 0, height);
        else grad = ctx.createLinearGradient(0, 0, width, height);
        grad.addColorStop(0, document.getElementById('bannerGrad1').value);
        grad.addColorStop(1, document.getElementById('bannerGrad2').value);
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, width, height);
      } else if (bannerBgType === 'image' && bannerBgImg) {
        const scale = Math.max(width / bannerBgImg.width, height / bannerBgImg.height);
        const w = bannerBgImg.width * scale;
        const h = bannerBgImg.height * scale;
        ctx.drawImage(bannerBgImg, (width - w) / 2, (height - h) / 2, w, h);
      } else {
        ctx.fillStyle = '#f5f5f4';
        ctx.fillRect(0, 0, width, height);
      }

      // Get text settings
      const shopName = document.getElementById('bannerShopName').value || 'Your Shop Name';
      const tagline = document.getElementById('bannerTagline').value;
      const font = document.getElementById('bannerFont').value;
      const textColor = document.getElementById('bannerTextColor').value;

      // Calculate text position
      let textX = width / 2;
      let textAlign = 'center';
      if (bannerTextPos === 'left') {
        textX = bannerLogoImg ? 200 : 60;
        textAlign = 'left';
      } else if (bannerTextPos === 'right') {
        textX = width - 60;
        textAlign = 'right';
      }

      // Draw logo if present
      if (bannerLogoImg) {
        const logoMaxH = height * 0.6;
        const logoScale = Math.min(logoMaxH / bannerLogoImg.height, 150 / bannerLogoImg.width);
        const logoW = bannerLogoImg.width * logoScale;
        const logoH = bannerLogoImg.height * logoScale;

        let logoX = 40;
        if (bannerTextPos === 'center') logoX = (width - logoW) / 2 - 200;
        else if (bannerTextPos === 'right') logoX = width - logoW - 250;

        ctx.drawImage(bannerLogoImg, logoX, (height - logoH) / 2, logoW, logoH);

        // Adjust text position if logo present and centered
        if (bannerTextPos === 'center') {
          textX = width / 2 + 60;
        }
      }

      // Draw shop name
      ctx.fillStyle = textColor;
      ctx.textAlign = textAlign;
      ctx.textBaseline = 'middle';

      const mainFontSize = bannerSize === 'big' ? 56 : bannerSize === 'mini' ? 36 : 40;
      ctx.font = `bold ${mainFontSize}px ${font}`;

      const textY = tagline ? height / 2 - 20 : height / 2;
      ctx.fillText(shopName, textX, textY);

      // Draw tagline
      if (tagline) {
        const taglineFontSize = bannerSize === 'big' ? 24 : 18;
        ctx.font = `${taglineFontSize}px ${font}`;
        ctx.globalAlpha = 0.7;
        ctx.fillText(tagline, textX, textY + mainFontSize * 0.7);
        ctx.globalAlpha = 1;
      }

      // Display preview
      const preview = document.getElementById('bannerPreview');
      preview.innerHTML = `<img src="${canvas.toDataURL()}" style="max-width:100%;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.2);">`;

      // Store canvas for download
      preview.dataset.canvasData = canvas.toDataURL('image/png');
    }

    // Download banner
    document.getElementById('bannerDownload').onclick = async () => {
      renderBannerPreview();

      const preview = document.getElementById('bannerPreview');
      const dataUrl = preview.dataset.canvasData;

      if (!dataUrl) {
        Utils.toast('Generate a preview first', 'error');
        return;
      }

      const { width, height } = bannerSizes[bannerSize];
      const shopName = document.getElementById('bannerShopName').value || 'shop';
      const filename = `${shopName.replace(/\s+/g, '_')}_banner_${width}x${height}.png`;

      // Create download link directly from data URL
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      Utils.toast(`Downloaded: ${filename}`);
    };

    // Preset styles
    window.applyBannerPreset = (preset) => {
      const presets = {
        minimal: { bg: 'color', color1: '#ffffff', textColor: '#1f1f1f', font: "'DM Sans', sans-serif" },
        warm: { bg: 'gradient', grad1: '#fef3c7', grad2: '#fed7aa', textColor: '#78350f', font: 'Georgia, serif' },
        elegant: { bg: 'color', color1: '#1f1f1f', textColor: '#fafafa', font: "'Playfair Display', serif" },
        bold: { bg: 'color', color1: '#dc2626', textColor: '#ffffff', font: 'Impact, sans-serif' },
        nature: { bg: 'gradient', grad1: '#d1fae5', grad2: '#a7f3d0', textColor: '#064e3b', font: 'Georgia, serif' },
        pastel: { bg: 'gradient', grad1: '#fce7f3', grad2: '#ddd6fe', textColor: '#581c87', font: "'Brush Script MT', cursive" }
      };

      const p = presets[preset];
      if (!p) return;

      // Set background type
      document.querySelectorAll('#panel-banner [data-bannerbg]').forEach(b => b.classList.remove('active'));
      document.querySelector(`#panel-banner [data-bannerbg="${p.bg}"]`).classList.add('active');
      bannerBgType = p.bg;
      document.getElementById('bannerBgColor').style.display = p.bg === 'color' ? 'block' : 'none';
      document.getElementById('bannerBgGradient').style.display = p.bg === 'gradient' ? 'block' : 'none';
      document.getElementById('bannerBgImage').style.display = p.bg === 'image' ? 'block' : 'none';

      // Set colors
      if (p.color1) document.getElementById('bannerColor1').value = p.color1;
      if (p.grad1) document.getElementById('bannerGrad1').value = p.grad1;
      if (p.grad2) document.getElementById('bannerGrad2').value = p.grad2;
      document.getElementById('bannerTextColor').value = p.textColor;
      document.getElementById('bannerFont').value = p.font;

      renderBannerPreview();
      Utils.toast(`Applied "${preset}" preset`);
    };

    // Initial render
    renderBannerPreview();


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: SIMPLE FRAMES
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: SIMPLE FRAMES
// ============================================
    // ============================================
    // SIMPLE FRAMES
    // ============================================
    let framesImage = null;
    setupUploadZone('framesUpload', 'framesInput', async files => {
      const file = files[0];
      if (!file?.type.startsWith('image/')) return;
      framesImage = { img: await loadImage(await readFileAsDataURL(file)), name: Utils.getBaseName(file.name) };
      document.getElementById('framesEmpty').style.display = 'none';
      document.getElementById('framesCanvas').style.display = 'block';
      document.getElementById('framesDownload').disabled = false;
      renderFrame();
    });
    document.querySelectorAll('#frameStyles button').forEach(btn => {
      btn.onclick = () => { document.querySelectorAll('#frameStyles button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderFrame(); };
    });
    document.getElementById('matWidth').oninput = e => { document.getElementById('matWidthVal').textContent = e.target.value + '%'; renderFrame(); };
    function renderFrame() {
      if (!framesImage) return;
      const style = document.querySelector('#frameStyles .active').dataset.frame;
      const matPct = parseInt(document.getElementById('matWidth').value) / 100;
      const img = framesImage.img;
      const pad = Math.round(Math.max(img.width, img.height) * matPct);
      const frameW = style === 'thick-white' ? 20 : 8;
      const canvas = document.getElementById('framesCanvas');
      canvas.width = img.width + pad * 2 + frameW * 2;
      canvas.height = img.height + pad * 2 + frameW * 2;
      const ctx = canvas.getContext('2d');
      // Frame
      const colors = { 'thin-black': '#222', 'thick-white': '#fff', 'wood': '#8B4513', 'gold': '#D4AF37', 'shadow': '#333' };
      ctx.fillStyle = colors[style] || '#222';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      // Mat (white)
      ctx.fillStyle = '#fff';
      ctx.fillRect(frameW, frameW, canvas.width - frameW * 2, canvas.height - frameW * 2);
      // Image
      ctx.drawImage(img, frameW + pad, frameW + pad);
      // Shadow effect
      if (style === 'shadow') { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width - 10, canvas.height - 10); ctx.drawImage(img, pad, pad); }
    }
    document.getElementById('framesDownload').onclick = async () => {
      if (!framesImage) return;
      const blob = await Utils.canvasToBlob(document.getElementById('framesCanvas'));
      downloadBlob(blob, framesImage.name + '-framed.png');
      Utils.toast('Framed image downloaded!');
    };


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };
    // ============================================
    // TOOL: BUNDLE CREATOR
    // ============================================

// ============================================
      // Stats display removed - function kept for compatibility
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = src;
      });
    }

    function downloadBlob(blob, filename) {
      Utils.downloadBlob(blob, filename);
      Utils.toast(`Downloaded: ${filename}`);
    }

    function setupUploadZone(zoneId, inputId, handler) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      if (!zone) { console.error('Upload zone not found:', zoneId); return; }
      if (!input) { console.error('File input not found:', inputId); return; }

      // Detect mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      // Update hint text for mobile
      if (isMobile) {
        const hintEl = zone.querySelector('.upload-text');
        if (hintEl && hintEl.textContent.toLowerCase().includes('drop')) {
          hintEl.textContent = 'Tap to select files';
        }
      }

      // Click handler - simple version for mobile
      zone.addEventListener('click', (e) => {
        // On desktop, prevent default and stop propagation to avoid conflicts
        if (!isMobile) {
          e.preventDefault();
          e.stopPropagation();
        }
        // On mobile, DON'T call preventDefault - let browser handle it naturally
        input.click();
      });

      // Drag handlers (desktop only)
      if (!isMobile) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
          e.preventDefault();
          zone.classList.remove('dragover');
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            handler(e.dataTransfer.files);
          }
        });
      }

      // File input change handler
      input.addEventListener('change', e => {
        if (e.target.files && e.target.files.length > 0) {
          handler(e.target.files);
          e.target.value = ''; // Reset so same file can be selected again
        }
      });
    }



// ============================================
// TOOL: BUNDLE CREATOR
// ============================================
    // ============================================
    // BUNDLE CREATOR
    // ============================================
    let bundleFiles = [];
    setupUploadZone('bundleUpload', 'bundleInput', files => {
      bundleFiles.push(...Array.from(files));
      renderBundleList();
    });
    function renderBundleList() {
      const list = document.getElementById('bundleList');
      document.getElementById('bundleCount').textContent = bundleFiles.length;
      document.getElementById('bundleDownload').disabled = bundleFiles.length === 0;
      if (!bundleFiles.length) { list.innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center;">No files added</div>'; return; }
      list.innerHTML = bundleFiles.map((f, i) => `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid var(--border);"><span style="font-size:13px;">${f.name}</span><button class="btn btn-secondary btn-sm" onclick="bundleFiles.splice(${i},1);renderBundleList();">√ó</button></div>`).join('');
    }
    document.getElementById('bundleClear').onclick = () => { bundleFiles = []; renderBundleList(); };
    document.getElementById('bundleDownload').onclick = async () => {
      const zip = new JSZip();
      for (const f of bundleFiles) zip.file(f.name, f);
      const blob = await zip.generateAsync({ type: 'blob' });
      downloadBlob(blob, (document.getElementById('bundleName').value || 'bundle') + '.zip');
      Utils.toast('Bundle created!');
    };
    renderBundleList();


// Settings/theme (with guards)
try {
    // ============================================
    // SETTINGS & THEME
    // ============================================

    // Theme toggle
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('etsy-toolkit-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('etsy-toolkit-theme') || 'dark';
    setTheme(savedTheme);

    document.getElementById('themeToggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(current === 'dark' ? 'light' : 'dark');
    };

    document.getElementById('themeDark').onclick = () => setTheme('dark');
    document.getElementById('themeLight').onclick = () => setTheme('light');

    // Settings modal
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'flex';
      renderFavorites();
      renderRecentFiles();
    };

    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    // Favorites system
    let favorites = JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]');

    function toggleFavorite(tool) {
      if (favorites.includes(tool)) {
        favorites = favorites.filter(t => t !== tool);
      } else {
        favorites.push(tool);
      }
      localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const container = document.getElementById('favoriteTools');
      if (favorites.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No favorites yet</span>';
        return;
      }
      container.innerHTML = favorites.map(f => `
        <button class="btn btn-secondary btn-sm" onclick="switchTab('${f}', toolMap['${f}']?.icon, toolMap['${f}']?.name); document.getElementById('settingsModal').style.display='none';">
          ${toolMap[f]?.icon || 'üîß'} ${toolMap[f]?.name || f}
        </button>
      `).join('');
    }

    // Recent files system
    let recentFiles = JSON.parse(localStorage.getItem('etsy-toolkit-recent') || '[]');

    function addRecentFile(name, tool) {
      recentFiles = recentFiles.filter(f => f.name !== name);
      recentFiles.unshift({ name, tool, time: Date.now() });
      if (recentFiles.length > 20) recentFiles = recentFiles.slice(0, 20);
      localStorage.setItem('etsy-toolkit-recent', JSON.stringify(recentFiles));
    }

    function renderRecentFiles() {
      const container = document.getElementById('recentFilesList');
      if (recentFiles.length === 0) {
        container.innerHTML = '<span style="font-size:13px;color:var(--text-muted);">No recent files</span>';
        return;
      }
      container.innerHTML = recentFiles.slice(0, 10).map(f => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px;">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px;">${f.name}</span>
          <span style="color:var(--text-muted);font-size:11px;">${toolMap[f.tool]?.name || f.tool}</span>
        </div>
      `).join('');
    }

    function clearRecentFiles() {
      recentFiles = [];
      localStorage.setItem('etsy-toolkit-recent', '[]');
      renderRecentFiles();
      Utils.toast('Recent files cleared');
    }

    // Export/import presets
    function exportPresets() {
      const data = {
        theme: localStorage.getItem('etsy-toolkit-theme'),
        favorites: JSON.parse(localStorage.getItem('etsy-toolkit-favorites') || '[]'),
        mockupTemplates: localStorage.getItem('etsy-mockup-templates'),
        version: '1.0'
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, 'etsy-toolkit-settings.json');
      Utils.toast('Settings exported!');
    }

    document.getElementById('importPresets').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (data.theme) localStorage.setItem('etsy-toolkit-theme', data.theme);
        if (data.favorites) localStorage.setItem('etsy-toolkit-favorites', JSON.stringify(data.favorites));
        if (data.mockupTemplates) localStorage.setItem('etsy-mockup-templates', data.mockupTemplates);
        location.reload();
      } catch (err) {
        Utils.toast('Invalid settings file', 'error');
      }
    };

  }); // end DOMContentLoaded
  </script>
</body>
</html>
